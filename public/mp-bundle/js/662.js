/*! For license information please see 662.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[662],{95512:(t,e,i)=>{"use strict";i.d(e,{y:()=>a});var s=i(19663);class a extends s.m{constructor(t){super(),this.id="DISABLE_CURSOR_MESH",this.payload={disable:t}}}},20217:(t,e,i)=>{"use strict";i.d(e,{C:()=>a,h:()=>o});var s=i(19663);class a extends s.m{constructor(t){super(),this.payload=t,this.id="DOLLHOUSE_VERTICAL_LIMITS"}}class o extends s.m{constructor(){super(),this.id="SNAP_DOLLHOUSE_UPPER_LIMIT"}}},61282:(t,e,i)=>{"use strict";i.d(e,{N2:()=>l,O8:()=>p,SI:()=>a,TD:()=>m,bC:()=>v,bp:()=>d,jX:()=>u,mP:()=>h,pj:()=>n,qj:()=>c,uQ:()=>o,v0:()=>g,zf:()=>r});var s=i(69505);const a=1e3/60,o=89*s.Ue,n=90*s.Ue,r=.001*s.Ue,d=10*s.Ue,l=20*s.Ue,c=.25,h=500,u=.1,m=.16,p=.08,g=Math.PI/1e3,v=.02},10840:(t,e,i)=>{"use strict";i.d(e,{T:()=>g});var s=i(81396),a=i(11677),o=i(44724),n=i.n(o),r=i(7188),d=i.n(r),l=i(52059),c=i.n(l),h=i(75215),u=i.n(h),m=i(56449),p=i.n(m);const g={endpoint:{uniforms:{opacity:{type:"f",value:1},color:{type:"c",value:new s.Color},bg:{type:"t",value:null}},vertexShader:a.Z.basicTextured.vertexShader,fragmentShader:n()},line:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,{linewidth:{value:4},resolution:{value:new s.Vector2(0,0)},dashScale:{value:1},dashSize:{value:.025},gapSize:{value:.05},mask:{value:null}}]),vertexShader:d(),fragmentShader:c()},screenline:{uniforms:{lineWidth:{value:1},screenSize:{value:new s.Vector2(0,0)},dashed:{value:0},dashSize:{value:1},gapSize:{value:1},antialiasWidth:{value:1},color:{value:new s.Color(1,0,0)},opacity:{value:1},start:{value:new s.Vector3},end:{value:new s.Vector3}},vertexShader:u(),fragmentShader:p()}}},38987:(t,e,i)=>{"use strict";i.d(e,{u:()=>a});var s=i(19663);class a extends s.m{constructor(t=null){super(),this.id="SET_MOUSE_CURSOR",this.payload={cursor:t}}}},34956:(t,e,i)=>{"use strict";var s;i.d(e,{C:()=>s}),function(t){t.NONE="none",t.DEFAULT="default",t.MOVE="move",t.MOVE_LF="col-resize",t.MOVE_UD="row-resize",t.XHAIR="crosshair",t.PLUS="cell",t.QUESTION="help",t.NOPE="not-allowed",t.FINGER="pointer",t.TEXT="text",t.TEXT_VERT="vertical-text",t.ZOOM_IN="zoom-in",t.ZOOM_OUT="zoom-in",t.GRAB="grab",t.GRABBING="grabbing",t.ARROW_R="e-resize",t.ARROW_L="w-resize",t.ARROW_U="n-resize",t.ARROW_D="s-resize",t.ARROW_UR="ne-resize",t.ARROW_UL="nw-resize",t.ARROW_DR="se-resize",t.ARROW_DL="sw-resize",t.ARROW_LR="ew-resize",t.ARROW_UD="ns-resize",t.ARROW_URDL="nesw-resize",t.ARROW_ULDR="nwse-resize",t.ROOMBOUNDS_DEFAULT="rbe-default",t.ROOMBOUNDS_MOVING="rbe-moving",t.ROOMBOUNDS_PLACE_NODE="rbe-place-node",t.ROOMBOUNDS_FINISH_ROOM="rbe-finish-room"}(s||(s={}))},39564:(t,e,i)=>{"use strict";i.d(e,{t:()=>o});var s=i(67992),a=i(15637);class o extends s.V{constructor(t){super(),this.name="notes-data",this.notes=(0,a.q)(t)}iterate(t){for(const e of this.notes)t(e)}updateNote(t){this.notes.has(t.id)?this.notes.get(t.id).copy(t):this.notes.set(t.id,t)}updateNoteProperties(t,e){if(this.notes.has(t)){const i=this.notes.get(t);let s=!1;void 0!==e.resolved&&e.resolved!==i.resolved&&(i.resolved=e.resolved,s=!0),void 0!==e.color&&e.color!==i.color&&(i.color=e.color,s=!0),void 0!==e.anchorPosition&&e.anchorPosition!==i.anchorPosition&&(i.anchorPosition=e.anchorPosition,s=!0),void 0!==e.stemNormal&&e.stemNormal!==i.stemNormal&&(i.stemNormal=e.stemNormal,s=!0),void 0!==e.stemLength&&e.stemLength!==i.stemLength&&(i.stemLength=e.stemLength,s=!0),void 0!==e.stemEnabled&&e.stemEnabled!==i.stemEnabled&&(i.stemEnabled=e.stemEnabled,s=!0),void 0!==e.floorId&&e.floorId!==i.floorId&&(i.floorId=e.floorId,s=!0),void 0!==e.roomId&&e.roomId!==i.roomId&&(i.roomId=e.roomId,s=!0),s&&i.commit()}}removeNote(t){this.notes.has(t)&&(this.notes.delete(t),this.commit())}getNote(t){return this.notes.get(t)}getNoteProperties(t){const e=this.notes.get(t);if(!e)return null;return Object.assign({},e)}get collection(){return this.notes}}},72957:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>K});var s=i(97542),a=i(89570),o=i(92810),n=i(35221),r=i(5823),d=i(80742),l=i(34029),c=i(26158),h=i(46391),u=i(54244),m=i(47309),p=i(63422),g=i(38399),v=i(71166),f=i(56163),w=i(76957),y=i(38127),S=i(12039),E=i(15004),b=i(84784);class D extends f.K{constructor(t,e,i,s,a,o,d){super(t,e,s),this.room=a,this.title=o,this.id=this.room.id,this.icon=`icon-${(0,E.mX)(this.room.roomTypeIds)}`,this.typeId=r.SF.MODELROOM,this.layerId=p.gi,this.dateBucket=n.Z.OLDER,this.enabled=!0,this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new S.SG(this.room)),await this.commandBinder.issueCommand(new y.et(this.id))},this.floorId=d,this.roomId=a.id;const l=i.tryGetProperty(c.F.UnitType,h.M.IMPERIAL);this.description=this.room.getMeasurementText(l)}}var I=i(92089),C=i(41999),A=i(39011),O=i(17788),R=i(22999),V=i(97998),N=i(78283);const T=new V.Z("MdsRoomBoundsDeserializer");class M{deserialize(t){var e,i,s,a,o,n,r,d,l,c,h,u,m,g,v;const f={version:0,floors:{}};for(const r of t.floors||[]){const t={edges:{},vertices:{},rooms:{}};f.floors[r.id]=t;for(const s of r.vertices||[])s?t.vertices[s.id]={x:s.position.x,y:s.position.y,layerId:null!==(i=null===(e=s.layer)||void 0===e?void 0:e.id)&&void 0!==i?i:p.gi}:T.warn("Found null vertex in floor vertices!");for(const e of r.edges||[]){if(!e||null===e.thickness||null===e.centerLineBias||null===e.vertices||2!==e.vertices.length){T.warn("Invalid edge!");continue}const i={vertices:e.vertices.map((t=>t.id)),thickness:e.thickness,bias:e.centerLineBias,openings:{},type:e.type||void 0,layerId:null!==(a=null===(s=e.layer)||void 0===s?void 0:s.id)&&void 0!==a?a:p.gi};t.edges[e.id]=i;for(const t of e.openings||[]){if(!t){T.warn("Found null opening!");continue}const e={height:t.height,lowerElevation:t.lowerElevation,relativePos:t.relativeCenter,type:t.type,width:t.width,layerId:null!==(n=null===(o=t.layer)||void 0===o?void 0:o.id)&&void 0!==n?n:p.gi};i.openings[t.id]=e}}}for(const e of t.rooms||[]){if(!e||!e.floor){T.warn("Found null room");continue}if(!f.floors[e.floor.id]){T.warn("Unable to find floor for room!");continue}const t=e.classifications||[].sort(((t,e)=>(t.confidence||0)-(e.confidence||0))),i=null===(r=e.dimensionEstimates)||void 0===r?void 0:r.units,s=(e.label||"").trim();f.floors[e.floor.id].rooms[e.id]={height:.1,edges:(null===(l=null===(d=e.boundary)||void 0===d?void 0:d.edges)||void 0===l?void 0:l.map((t=>t.id)))||[],holes:(null===(c=e.holes)||void 0===c?void 0:c.map((t=>{var e;return(null===(e=t.edges)||void 0===e?void 0:e.map((t=>t.id)))||[]})))||[],classifications:t,label:s,width:this.ensureMetric("distance",null===(h=e.dimensionEstimates)||void 0===h?void 0:h.width,i),length:this.ensureMetric("distance",null===(u=e.dimensionEstimates)||void 0===u?void 0:u.depth,i),area:this.ensureMetric("area",null===(m=e.dimensionEstimates)||void 0===m?void 0:m.area,i),layerId:null!==(v=null===(g=e.layer)||void 0===g?void 0:g.id)&&void 0!==v?v:p.gi}}return f}ensureMetric(t,e,i){if(null!=e&&null!=i){const s=i===r.nL.IMPERIAL,a="area"===t?N.W3:N._F;return s?a(e):e}return NaN}}var x=i(16747);const L=new V.Z("MdsRoomBoundsStore");class P extends O.u{constructor(t){super(t),this.queuedMutations=[],this.seenRooms=new Map,this.lastUpdates=new Map,this.deserializer=new M}async read(t){var e,i;const s={modelId:this.getViewId()},a=await this.query(R.GetRoomBounds,s,t);return(null===(i=null===(e=null==a?void 0:a.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.floors)?this.deserializer.deserialize(a.data.model):null}async readClassifications({options:t,localizeFn:e}={}){var i;return((null===(i=(await this.query(R.GetRoomClassifications,{},t)).data)||void 0===i?void 0:i.roomClassifications)||[]).reduce(((t,i)=>(i&&(t[i.id]=e?e(i):i),t)),{})}setReadOnly(t){this.config.readonly=t}queueRemoveEntity(t,e,i){this.queueDeleteRoomsAndBoundaryData(t,e,i)}queueAddNode(t){this.queuedMutations.push(`addBoundaryVertex(modelId: $modelId, id: "${t.id}", vertex: ${this.vertexDetailsFromNode(t)}) { id }`)}queueUpdateNode(t){this.updateEntity("node",t.id,`patchBoundaryVertex(modelId: $modelId, id: "${t.id}", vertex: ${this.vertexDetailsFromNode(t)}) { id }`)}vertexDetailsFromNode(t){return`{\n      floorId: "${t.floorId}",\n      position: { x: ${t.x} y: ${-t.z} }\n      ${this.layerId(t.layerId)}\n    }`}queueRemoveNode(t){this.queueRemoveEntity("node",t.id,t.layerId)}queueAddWall(t){this.queuedMutations.push(`addBoundaryEdge(modelId: $modelId, id: "${t.id}", edge: ${this.edgeDetailsFromWall(t)}) { id }`)}queueUpdateWall(t){this.updateEntity("wall",t.id,`patchBoundaryEdge(modelId: $modelId, id: "${t.id}" edge: ${this.edgeDetailsFromWall(t)}) { id }`)}edgeDetailsFromWall(t){return`\n    {\n      floorId: "${t.floorId}" \n      vertices: ["${t.from.id}", "${t.to.id}"]\n      thickness: ${t.width} \n      units: ${r.nL.METRIC} \n      centerLineBias: ${1-t.bias}\n      type: ${t.type===x.d.SOLID?r.Pb.WALL:r.Pb.INVISIBLE}\n      ${this.layerId(t.layerId)}\n    }\n    `}queueRemoveWall(t){this.queueRemoveEntity("wall",t.id,t.layerId)}queueAddOpening(t){this.queuedMutations.push(`addEdgeOpenings(modelId: $modelId, id: "${t.wallId}", openings: [${this.openingDetailsFromOpening(t)}]) { id }`)}queueUpdateOpening(t){this.updateEntity("opening",t.id,`patchEdgeOpening(modelId: $modelId, id: "${t.wallId}", opening: ${this.openingDetailsFromOpening(t)}) { id }`)}openingDetailsFromOpening(t){return`\n    {\n      id: "${t.id}" \n      relativeCenter: ${t.relativePos} \n      type: ${t.type} \n      width: ${t.width} \n      ${this.layerId(t.layerId)}\n      height: 0.1, \n      lowerElevation: 0.1\n    }\n    `}queueRemoveOpening(t){this.queuedMutations.push(`removeEdgeOpenings(\n        modelId: $modelId\n        id: "${t.wallId}"\n        openings: ["${t.id}"]\n        layerId: "${t.layerId}"\n      )`),this.clearEntityUpdate("opening",t.id)}queueAddRoom(t){this.queuedMutations.push(`addRoom(\n        modelId: $modelId,\n        id: "${t.id}",\n        room: ${this.getRoomDetailsFromRoom(t)}\n      ) { id }`)}queueUpdateRoom(t){const e=this.seenRooms.get(t.id);e&&e!==t&&this.clearEntityUpdate("room",t.id),this.seenRooms.set(t.id,t),this.updateEntity("room",t.id,`patchRoom(\n        modelId: $modelId,\n        id: "${t.id}",\n        room: ${this.getRoomDetailsFromRoom(t)}\n      ) { id }`)}getRoomDetailsFromRoom(t){return`\n    {\n      floorId: "${t.floorId}"\n      label: "${this.escapeUserString(t.name)}"\n      classifications: [${t.roomTypeIds.map((t=>`"${t}"`))}],\n      ${this.layerId(t.layerId)}\n      boundary: {\n        edges: [${Array.from(t.walls.values()).map((t=>`"${t.id}"`))}],\n      }\n      holes: [${Array.from(t.holes.values()).map((t=>`{ edges: [${Array.from(t.values()).map((t=>`"${t.id}"`))}] }`))}]\n      dimensionEstimates: {\n        room: "${t.id}",\n        area: ${Number.isNaN(t.area)?null:t.area},\n        areaIndoor: ${Number.isNaN(t.area)?null:t.area},\n        depth: ${Number.isNaN(t.length)?null:t.length}\n        width: ${Number.isNaN(t.width)?null:t.width}\n        units: ${r.nL.METRIC}\n      }\n    }\n    `}queueRemoveRoom(t){this.seenRooms.delete(t.id),this.queueRemoveEntity("room",t.id,t.layerId)}queueRemoveLegacyRooms(t){const e=t.map((t=>`"${t}"`));this.queuedMutations.push(`deleteRoomsAndBoundaryData(\n      modelId: $modelId,\n      selectedData: {\n        ids: [${e.join(",")}],\n        type: ${r.TS.ROOM}\n      }\n    )`)}queueUpdateRoomAssociations(t){if(0===t.length)return;this.queuedMutations.push(`bulkPatchRoomData(\n        modelId: $modelId,\n        updatedRoomAssociations: [${t.map((t=>(t=>`{ ${Object.keys(t).map((e=>`${e}: ${JSON.stringify(t[e])}`)).join(",")} }`)(t)))}]\n      )`)}async submitQueuedMutations(){if(0===this.queuedMutations.length)return;const t=C.gql`
      mutation updateRoomBoundaries($modelId: ID!) {
        ${this.queuedMutations.map(((t,e)=>`op${e}: ${t}`)).join("\n")}
      }
    `;this.queuedMutations.length=0;for(const t of this.lastUpdates.values())t.clear();L.debug((0,A.S)(t)),await this.mutate(t,{modelId:this.getViewId()}),L.debug("mutation successful")}clearQueuedMutations(){this.queuedMutations.length=0;for(const t of this.lastUpdates.values())t.clear()}updateEntity(t,e,i){const s=this.lastUpdates.get(t)||new Map;this.lastUpdates.set(t,s);const a=s.get(e);void 0!==a?this.queuedMutations[a]=i:(this.queuedMutations.push(i),s.set(e,this.queuedMutations.length-1))}clearEntityUpdate(t,e){const i=this.lastUpdates.get(t);i&&i.delete(e)}queueDeleteRoomsAndBoundaryData(t,e,i){let s=r.TS.BOUNDARYVERTEX;switch(t){case"room":s=r.TS.ROOM;break;case"wall":s=r.TS.BOUNDARYEDGE}this.queuedMutations.push(`deleteRoomsAndBoundaryData(\n        modelId: $modelId,\n        selectedData: {\n          ids: ["${e}"],\n          type: ${s},\n          ${this.layerId(i)}\n        }\n      )`),this.clearEntityUpdate(t,e)}layerId(t){return t!==p.gi?`layerId: "${t}"`:""}escapeUserString(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}}var F=i(80008),k=i(85679),B=i(39564),W=i(92294),_=i(59512),U=i(53954),H=i(39693),z=i(96776),j=i(75668),G=i(28269),$=i(20241),q=i(635),Y=i(79728),Z=i(10374);class X extends s.Y{constructor(){super(...arguments),this.name="room_bound_data",this.associationSources=[],this.modifiedFloors=new Set,this.afterFinalize=async()=>{if(!this.writeBindings)throw new Error("Not permitted to write room bounds data");try{this.store.queueUpdateRoomAssociations(this.updateRoomAssociations()),await this.store.submitQueuedMutations()}catch(t){this.log.info("Error finalizing room bounds data",t),this.data.clearUndoBuffer();const e=await this.store.read();throw this.writeBindings.cancel(),this.data.load(e||{version:0,floors:{}}),this.data.commit(),this.writeBindings.renew(),t}},this.addRoom=t=>{this.roomData.get(t.id)||this.roomData.add(new $.d({id:t.id,floorId:t.floorId,meshSubgroup:-1})),this.addToModifiedFloors(t),this.data.legacyRoomIds.length&&(this.store.queueRemoveLegacyRooms(this.data.legacyRoomIds),this.data.legacyRoomIds.forEach((t=>this.roomData.remove(t))),this.data.legacyRoomIds.length=0),this.store.queueAddRoom(t)},this.removeRoom=t=>{this.roomData.get(t.id)&&this.roomData.remove(t.id),this.addToModifiedFloors(t),this.store.queueRemoveRoom(t)}}async init(t,e){const[i,s,n]=await Promise.all([e.market.waitForData(d.R),e.market.waitForData(G.Z),e.market.waitForData(u.pu)]);this.roomData=s,this.layersData=i,this.issueCommand=e.commandBinder.issueCommand;const h=i.getBaseModelView();if(!h)throw new Error("Unable to find view for RoomBound data");this.localeModule=await e.getModuleBySymbol(o.e9),this.store=new P({viewId:h.id,context:i.mdsContext,readonly:t.readonly,baseUrl:t.baseUrl});let p=await this.store.read();p&&!t.readonly&&(p=this.validateData(p));const f=await this.store.readClassifications({localizeFn:t=>this.localizeRoomClassification(t)});j.Ds.forEach((t=>{const e=t.join(j.Rt);f[e]={id:e,label:t.map((t=>f[t].label)).join(j.X9)}})),this.data=new I.Z(p,f),this.data.clearUndoBuffer(),this.data.resetHistory(),t.readonly||(this.writeBindings=new a.V(this.data.onWallsChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddWall(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateWall(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveWall(t)}}),this.data.onNodesChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddNode(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateNode(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveNode(t)}}),this.data.onRoomsChanged({onAdded:this.addRoom,onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateRoom(t)},onRemoved:this.removeRoom}),this.data.onOpeningsChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddOpening(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateOpening(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveOpening(t)}}),this.data.afterFinalize((async()=>{await e.commandBinder.issueCommand(new q.V({dataTypes:[Y.g.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0}))}))),this.writeBindings.cancel()),await this.updateForApp(e,n.application),this.bindings.push(e.subscribe(Z.bS,(t=>this.updateForApp(e,t.application)))),await this.registerRoomAssociationSources(e),this.store.clearQueuedMutations(),async function(t,e){const[i,s,n,h,p]=await Promise.all([t.market.waitForData(u.pu),t.market.waitForData(d.R),t.market.waitForData(l.e),t.market.waitForData(w.i),t.getModuleBySymbol(o.e9)]);let f=i.application===u.Mx.WORKSHOP;const y=(i,a,o,r=[])=>{if(!f&&!n.tryGetProperty(m.hW,!1))return[];if(r.length>0)return[];const d=[];for(const o of e.rooms.values()){const r=(0,b.LN)(o.id,p,e);if(i(o.name)||i(r)){const e=h.getFloor(o.floorId);if(!e)throw new Error("Unable to find floor for room while generating search results.");d.push(new D(t.commandBinder,s,n,a,o,r,e.id))}}return d.sort(((t,e)=>t.title.localeCompare(e.title)))},S=t=>{},E=t=>new a.V(e.onChanged(t),n.onPropertyChanged(c.F.UnitType,t)),I={renew:()=>{t.commandBinder.issueCommandWhenBound(new v.c6({id:r.SF.MODELROOM,groupPhraseKey:g.Z.SHOWCASE.ROOMS.SEARCH_GROUP_HEADER,getSimpleMatches:y,registerChangeObserver:E,onSearchActivatedChanged:S,groupOrder:100,groupIcon:"edit-floorplan",batchSupported:!1}))},cancel:()=>{t.commandBinder.issueCommandWhenBound(new v.Pe(r.SF.MODELROOM))}},C=()=>{f=i.application===u.Mx.WORKSHOP,n.tryGetProperty(m.hW,!1)||f?I.renew():I.cancel()},A=i.onPropertyChanged("application",C),O=n.onPropertyChanged(m.hW,C);return C(),new a.V(I,A,O)}(e,this.data).then((t=>this.bindings.push(t))),e.market.register(this,I.Z,this.data)}dispose(t){super.dispose(t),this.writeBindings&&this.writeBindings.cancel()}localizeRoomClassification(t){return this.localeModule?Object.assign(Object.assign({},t),{label:(0,b.Nw)(t,this.localeModule)}):t}validateData(t){return Object.values(t.floors).forEach((t=>{const e={};Object.values(t.edges).forEach((t=>{t.vertices&&t.vertices.forEach((t=>{e[t]=!0}))}));const i={};Object.entries(t.vertices).forEach((([t,s])=>{e[t]?i[t]=s:this.store.queueRemoveEntity("node",t,s.layerId)})),t.vertices=i})),this.store.submitQueuedMutations(),t}trackRoomBoundsABTest(t,e){Promise.all([t.getModuleBySymbol(o.V6),t.market.waitForData(l.e)]).then((([t,i])=>{const s=this.data.rooms.size>0,a=e===u.Mx.WORKSHOP||s&&(0,m.G)(i);t.trackFeatures(`${m.A0}:${a}`)}))}async updateForApp(t,e){return this.trackRoomBoundsABTest(t,e),this.updateReadonly(e)}async updateReadonly(t){const e=t===u.Mx.SHOWCASE;if(this.store.setReadOnly(e),this.writeBindings)if(e)this.writeBindings.cancel();else{this.writeBindings.renew(),await this.issueCommand(new F.fk);const t=this.layersData.getViewLayerIdForBaseView();if(!t)throw Error("Cannot edit rooms without base view view-data layer");this.data.defaultLayerId=t}}addToModifiedFloors(t){this.modifiedFloors.add(t.floorId)}updateRoomAssociations(){const t=new Map;for(const e of this.associationSources)for(const i of e.getPositionId()){if(!i.floorId||!this.modifiedFloors.has(i.floorId))continue;const s=this.data.findRoomIdForPosition(i.position,i.floorId,i.roomId);if(s!=i.roomId){const a=t.get(s)||(s?{roomId:s}:{resetRoom:!0}),o=a[e.type]||[];o.push(i.id),a[e.type]=o,t.set(s,a),e.updateRoomForId(i.id,s)}}return this.modifiedFloors.clear(),Array.from(t.values())}async registerRoomAssociationSources(t){const e=await t.market.waitForData(l.e),i=await t.market.waitForData(k.n);if(this.associationSources.push({type:"mattertags",getPositionId:function*(){for(const t of i)yield{id:t.sid,roomId:t.roomId,floorId:t.floorId,position:t.anchorPosition}},updateRoomForId:(t,e)=>{const s=i.getTag(t);if(!s)throw new Error("Invalid tag id!");s.roomId=e||void 0}}),e.tryGetProperty(H.Mp,!1)){const e=await t.market.waitForData(B.t);this.associationSources.push({type:"notes",getPositionId:function*(){for(const t of e.collection.values)yield{id:t.id,roomId:t.roomId,floorId:t.floorId,position:t.anchorPosition}},updateRoomForId:(t,i)=>{const s=e.getNote(t);if(!s)throw new Error("Invalid note id!");s.roomId=i||void 0}})}const s=await t.market.waitForData(W.X);if(this.associationSources.push({type:"measurements",getPositionId:function*(){for(const t of s.groups())yield{id:t.info.sid,roomId:t.info.roomId,floorId:t.info.floorId,position:t.get(0)}},updateRoomForId:(t,e)=>{const i=s.getGroupInfoBySid(t);if(!i)throw new Error("Invalid measurement group id");i.info.roomId=e||void 0}}),e.tryGetProperty(z.QA,!1)){const e=await t.market.waitForData(_.h);this.associationSources.push({type:"objectAnnotations",getPositionId:function*(){for(const t of e.collection.values)yield{id:t.id,roomId:t.roomId,floorId:t.floorId,position:t.position}},updateRoomForId:(t,i)=>{const s=e.getObjectTag(t);if(!s)throw new Error("Invalid object detection id!");s.roomId=i||void 0}})}const a=await t.market.waitForData(U.Z);this.associationSources.push({type:"locations",getPositionId:function*(){for(const t of a.sweeps())yield{id:t.id,roomId:t.roomId||void 0,floorId:t.floorId||void 0,position:t.position}},updateRoomForId:(t,e)=>{const i=a.getSweep(t);if(!i)throw new Error("Invalid sweep id!");i.roomId=e||null}})}}const K=X},77905:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>Ni});var s=i(92810),a=i(97542),o=i(34029),n=i(60975),r=i(6282),d=i(76631),l=i(91380),c=i(50892),h=i(89549),u=i(59625),m=i(71776),p=i(38987),g=i(34956),v=i(39693),f=i(43736),w=i(92001),y=i(65019),S=i(41326),E=i(66917),b=i(75287),D=i(89570),I=i(2224),C=i(97998),A=i(37082),O=i(13693),R=i(98010);const V=new C.Z("editor");var N;!function(t){let e,i;t.DragAndDrop=class{constructor(t=new s){this.state=t,this.events=new O.Y,this.bindings=[],this.validator=null,this.state.commit(),this.bindings.push(this.state.onPropertyChanged("toolState",(()=>{V.debug("toolState:",{from:this.state.previousToolState,to:this.state.toolState},this.state),this.events.broadcast(new i.StateChange(this.state.toolState,this.state.previousToolState))})),this.onSelectedChanged(((t,e)=>{this.events.broadcast(new i.SelectChange(t,e))})),this.onHoveredChanged(((t,e)=>{this.events.broadcast(new i.HoverChange(t,e))})),this.state.onCurrentIdChanged(((t,e)=>{this.events.broadcast(new i.CurrentChange(t,e))}))),this.bindings.forEach((t=>t.cancel()))}subscribe(t,e){return this.events.subscribe(t,e)}setState(t){t!==this.state.toolState&&(this.state.previousToolState=this.state.toolState,this.state.toolState=t,this.state.commit())}start(){const{toolState:t}=this.state;if(t===e.CLOSED)this.bindings.forEach((t=>t.renew()));else if(t!==e.READ_ONLY)throw new a("Editor already started");this.setState(e.IDLE),this.events.broadcast(new i.Start)}startReadOnly(){const{toolState:t}=this.state;if(t===e.CLOSED)this.bindings.forEach((t=>t.renew()));else if(t!==e.IDLE)throw new a("Editor already started");this.setState(e.READ_ONLY)}setEnabled(t){if(this.state.toolState===e.CLOSED)throw new a("Editor not started");if(t)this.state.toolState===e.DISABLED&&this.setState(e.IDLE);else switch(this.state.toolState){case e.DISABLED:break;case e.IDLE:this.setState(e.DISABLED);break;default:this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard(),this.setState(e.DISABLED)}}exit(){this.state.toolState!==e.CLOSED&&(this.state.toolState!==e.DISABLED&&(this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard()),this.setState(e.CLOSED),this.bindings.forEach((t=>t.cancel())),this.events.broadcast(new i.Exit))}setValidator(t){this.validator=t}onDiscard(t){this.state.onBeforeDiscard=t||null}edit(t){if(this.assertActive(),null!==this.state.pendingEdit)throw V.error(`Trying to edit asset ${t}, but currently editing ${this.state.pendingEdit}`),new a("Edit in progress");this.state.pendingEdit=t,this.setState(e.EDITING),this.events.broadcast(new i.EditStart(t,!1))}waitForAdd(){if(this.assertActive(),null!==this.state.pendingAdd)throw V.error(`Entering wait for add state, but already adding ${this.state.pendingAdd}`),new a("Add in progress");null!==this.state.selected&&(V.debug(`Entering the wait for add state, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.events.broadcast(new i.WaitForAddStart),this.setState(e.WAIT_FOR_ADD)}add(t){if(this.assertActive(),null!==this.state.pendingAdd)throw V.error(`Trying to add new asset ${t}, but already adding ${this.state.pendingAdd}`),new a("Add in progress");null!==this.state.selected&&(V.debug(`Add ${t} called, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.state.pendingAdd=t,this.events.broadcast(new i.AddStart(t)),this.setState(e.ADDING)}place(t){this.assertActive();const{pendingAdd:s,pendingEdit:a}=this.state,o=s||a;o&&t===o||(this.state.pendingEdit=t),this.setState(e.PLACING),this.events.broadcast(new i.EditStart(t,!0))}move(t){this.assertActive(),this.validate(t);const{pendingAdd:e,pendingEdit:s,selected:a}=this.state,o=e||s||a;o&&this.events.broadcast(new i.Move(o,t)),this.state.ndcPosition.value=t.clientPosition}highlight(...t){this.assertActive();for(const e of t)this.state.highlighted.add(e),this.events.broadcast(new i.HighlightAdd(e))}clearAllHighlights(){this.assertActive();for(const t of this.state.highlighted)this.events.broadcast(new i.HighlightClear(t));this.state.highlighted.clear()}dim(t){this.assertActive(),this.state.dimmed.add(t),this.events.broadcast(new i.DimAdd(t))}clearDim(t){this.assertActive(),this.state.dimmed.delete(t),this.events.broadcast(new i.DimClear(t))}clearAllDims(){this.assertActive();for(const t of this.state.dimmed)this.events.broadcast(new i.DimClear(t));this.state.dimmed.clear()}select(t,i){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||(this.state.previousSelected=this.state.selected,this.state.selected=t,this.state.commit(),i&&i.transitionTo?this.setState(i.transitionTo):this.state.isReadonly()?this.setState(e.SELECTED_READ_ONLY):this.setState(e.SELECTED))}toggleSelect(t){this.state.selected===t?this.deselect():this.select(t)}deselect(t={commit:!0}){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||null!==this.state.selected&&(this.state.previousSelected=this.state.selected,this.state.selected=null,t.commit&&this.state.commit(),t&&t.transitionTo?this.setState(t.transitionTo):this.state.toolState===e.SELECTED_READ_ONLY?this.setState(e.READ_ONLY):this.setState(e.IDLE))}hover(t){this.assertActive(),t!==this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=t,this.state.commit())}unhover(t={commit:!0}){this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=null,t.commit&&this.state.commit())}tryCommit(){this.assertActive();const t=this.state.pendingAdd,e=this.state.pendingEdit;if(!1===this.state.pendingValid)return V.warn("nop, pendingValid",this.state.pendingValid),!1;let s=!1;const a=this.state.selected,o=this.state.pendingAdd||this.state.pendingEdit;if(o){const n=null===this.state.pendingValid||!0===this.state.pendingValid;n&&(this.state.pendingAdd=null,this.state.pendingEdit=null,this.state.pendingValid=null,this.state.onBeforeDiscard=null,e&&this.events.broadcast(new i.EditConfirm(e)),t&&this.events.broadcast(new i.AddConfirm(t)),this.state.pendingAdd||this.state.pendingEdit||a!==this.state.selected||this.select(o)),s=n}return s}discard(){const s=this.state.pendingAdd||this.state.pendingEdit,a=this.state.pendingAdd,o=this.state.pendingEdit;s&&(this.state.onBeforeDiscard&&this.state.onBeforeDiscard(),o&&(this.state.pendingEdit=null,this.events.broadcast(new i.EditDiscard(o))),a&&(this.state.pendingAdd=null,this.events.broadcast(new i.AddDiscard(a))),this.events.broadcast(new t.Events.ValidChange(null,null)),this.state.pendingValid=null,this.state.onBeforeDiscard=null),this.unhover({commit:!1}),this.deselect({commit:!1}),this.state.isReadonly()?this.setState(e.READ_ONLY):this.state.toolState!==e.IDLE&&this.setState(e.IDLE),this.state.commit()}validate(e){const i=this.state.pendingAdd||this.state.pendingEdit||this.state.selected;if(i){const s=this.state.pendingValid;let a=!0;this.validator?(a=this.validator.validate(i,e),this.state.pendingValid=a):this.state.pendingValid=null,null!==this.state.pendingValid&&s!==this.state.pendingValid&&this.events.broadcast(new t.Events.ValidChange(a?i:null,a?null:i))}}assertActive(){if(this.state.toolState===t.ToolState.CLOSED)throw new a("Editor closed");if(this.state.toolState===t.ToolState.DISABLED)throw new a("Editor disabled")}onSelectedChanged(t){return this.state.onPropertyChanged("selected",(()=>t(this.state.selected,this.state.previousSelected)))}onHoveredChanged(t){return this.state.onPropertyChanged("hovered",(()=>t(this.state.hovered,this.state.previousHovered)))}},function(t){t.CLOSED="CLOSED",t.READ_ONLY="READ_ONLY",t.DISABLED="DISABLED",t.IDLE="IDLE",t.SELECTED="SELECTED",t.SELECTED_READ_ONLY="SELECTED_READ_ONLY",t.WAIT_FOR_ADD="WAIT_FOR_ADD",t.ADDING="ADDING",t.EDITING="EDITING",t.PLACING="PLACING"}(e=t.ToolState||(t.ToolState={}));class s extends b.T{constructor(){super(...arguments),this.toolState=e.CLOSED,this.previousToolState=e.CLOSED,this.pendingAdd=null,this.pendingEdit=null,this.selected=null,this.previousSelected=null,this.hovered=null,this.previousHovered=null,this.highlighted=new Set,this.dimmed=new Set,this.ndcPosition=new A.f(null),this.onBeforeDiscard=null,this.pendingValid=null}get currentId(){return this.pendingAdd||this.pendingEdit||this.selected||null}onCurrentIdChanged(t,e=!1){let i=this.currentId;const s=()=>{this.currentId!==i&&(t(this.currentId,i),i=this.currentId)},a=new D.V(this.onPropertyChanged("selected",s),this.onPropertyChanged("pendingAdd",s),this.onPropertyChanged("pendingEdit",s));return e?a.renew():a.cancel(),a}isReadonly(){return this.toolState===e.READ_ONLY||this.toolState===e.SELECTED_READ_ONLY}}t.State=s;class a extends I.y{constructor(t="invalid state"){super(t),this.name="invalid state"}}t.EditorException=a,function(t){class e extends R.v0{}e.type="edit",t.EditEvent=e;class i extends e{constructor(t){super(),this.target=t}}i.type="editt",t.EditTarget=i;class s extends e{constructor(t,e){super(),this.target=t,this.previous=e}}s.type="edittp",t.EditTargetAndPrev=s;class a extends e{constructor(t,e){super(),this.target=t,this.previous=e}}a.type="toolchange",t.StateChange=a;class o extends e{}o.type="editorstart",t.Start=o;class n extends e{}n.type="editorexit",t.Exit=n;class r extends e{}r.type="waitforaddstart",t.WaitForAddStart=r;class d extends i{}d.type="addstart",t.AddStart=d;class l extends i{constructor(t,e){super(t),this.placeOnly=e}}l.type="editstart",t.EditStart=l;class c extends i{}c.type="addconfirm",t.AddConfirm=c;class h extends i{}h.type="adddiscard",t.AddDiscard=h;class u extends i{}u.type="editconfirm",t.EditConfirm=u;class m extends i{}m.type="editdiscard",t.EditDiscard=m;class p extends i{}p.type="delete",t.Delete=p;class g extends i{constructor(t,e){super(t),this.target=t,this.ev=e}}g.type="move",t.Move=g;class v extends s{}v.type="target",t.CurrentChange=v;class f extends s{}f.type="hover",t.HoverChange=f;class w extends s{}w.type="select",t.SelectChange=w;class y extends i{}y.type="highlight",t.HighlightAdd=y;class S extends i{}S.type="highlightclear",t.HighlightClear=S;class E extends i{}E.type="dim",t.DimAdd=E;class b extends i{}b.type="dimclear",t.DimClear=b;class D extends s{}D.type="valid",t.ValidChange=D,t.hasTarget=function(t){return t instanceof i},t.hasTargetAndPrev=function(t){return t instanceof s}}(i=t.Events||(t.Events={}))}(N||(N={}));var T,M=i(92089),x=i(47309),L=i(38127),P=i(90304),F=i(16747),k=i(2482);!function(t){const e={[N.Events.HoverChange.type]:"hoverState",[N.Events.SelectChange.type]:"selectState",[N.Events.ValidChange.type]:"validState",[N.Events.Move.type]:"mover",[N.Events.HighlightAdd.type]:"highlightState",[N.Events.HighlightClear.type]:"highlightState",[N.Events.DimAdd.type]:"dimState",[N.Events.DimClear.type]:"dimState"};t.EditorEntityAdapter=class{constructor(t){this.editor=t,this.bindings=[],this.entities=new Map,this.bindings.push(this.editor.subscribe(N.Events.HoverChange,(t=>this.bindTargetedCallback(N.Events.HoverChange.type,t))),this.editor.subscribe(N.Events.SelectChange,(t=>this.bindTargetedCallback(N.Events.SelectChange.type,t))),this.editor.subscribe(N.Events.ValidChange,(t=>this.bindTargetedCallback(N.Events.ValidChange.type,t))),this.editor.subscribe(N.Events.HighlightAdd,(t=>this.bindTargetedCallback(N.Events.HighlightAdd.type,t))),this.editor.subscribe(N.Events.HighlightClear,(t=>this.bindClearCallback(N.Events.HighlightClear.type,t))),this.editor.subscribe(N.Events.DimAdd,(t=>this.bindTargetedCallback(N.Events.DimAdd.type,t))),this.editor.subscribe(N.Events.DimClear,(t=>this.bindClearCallback(N.Events.DimClear.type,t))),this.editor.subscribe(N.Events.Move,(t=>this.bindMoveCallback(t))))}registerEntity(t,...e){let i=this.entities.get(t);i||(i=[]),i.push(...e),this.entities.set(t,i)}unregisterEntity(t){return this.entities.delete(t)}bindTargetedCallback(t,i){let s=null,a=null;N.Events.hasTargetAndPrev(i)?(s=i.target,a=i.previous):N.Events.hasTarget(i)&&(s=i.target);const o=e[t];if(!o)throw Error(`implement targetted callback for ${t}`);(this.entities.get(a)||[]).forEach((t=>{o in t&&(t[o].active=!1,t[o].off())})),(this.entities.get(s)||[]).forEach((t=>{o in t&&(t[o].active=!0,t[o].on())}))}bindMoveCallback(t){(this.entities.get(t.target)||[]).forEach((e=>{e.mover&&t.target&&e.mover.onMove(t.target,t.ev)}))}bindClearCallback(t,i){let s=null;const a=e[t];N.Events.hasTarget(i)&&(s=i.target),(this.entities.get(s)||[]).forEach((t=>{a in t&&(t[a].active=!1,t[a].off())}))}}}(T||(T={}));var B=i(81396),W=i(59370),_=i(2569);var U;!function(t){t[t.NONE=0]="NONE",t[t.LINE=1]="LINE",t[t.POINT=2]="POINT"}(U||(U={}));const H=(()=>{const t=new B.Vector2,e={target:new B.Vector3,closestLine:new B.Line3,orthoLine:new B.Line3,targetType:U.NONE};return(i,s,a,o)=>{e.target.copy(o),e.targetType=U.NONE;let n=Number.MIN_VALUE;const r=z(i,a);for(const t of r){const{dist:i,weight:a,closestPt:r}=G(t,o,s);i<15&&a>n&&(n=a,e.target.copy(r),e.closestLine.copy(t),e.targetType=U.LINE)}if(e.targetType===U.LINE){let n=Number.MIN_VALUE;const r=z(i,a);for(const i of r)if($(i,e.closestLine)){const{dist:a,weight:r}=G(i,o,s);if(a<7.5&&r>n){(0,_.cB)(i.start.x,i.start.z,i.end.x,i.end.z,e.closestLine.start.x,e.closestLine.start.z,e.closestLine.end.x,e.closestLine.end.z,t)&&(n=r,e.target.set(t.x,0,t.y),e.orthoLine.copy(i),e.targetType=U.POINT)}}}return e}})(),z=(()=>{const t=new B.Line3(new B.Vector3,new B.Vector3),e=new B.Vector3,i=new B.Vector3,s=new B.Vector3,a=new B.Vector3(0,1,0);return function*(o,n){const r=o.getWallsForNode(n),d=o.getWallsForFloor(n.floorId);if(d)for(const o of d)if(!r.has(o)){const n=o.from.getVec3(e),r=o.to.getVec3(i);t.set(n,r),yield t,s.subVectors(r,n).normalize(),s.applyAxisAngle(a,Math.PI/2);const d=i.addVectors(n,s);t.set(n,d),yield t;const l=o.to.getVec3(e),c=i.addVectors(l,s);t.set(l,c),yield t}}})(),j=(()=>{const t=new B.Vector2,e=new B.Vector2,i=new B.Vector3;return(s,a,o)=>{const n=(0,W.q9)(s,a,t,i).screenPosition,r=(0,W.q9)(s,o,e,i).screenPosition;return n.distanceTo(r)}})(),G=(()=>{const t={dist:0,weight:0,closestPt:new B.Vector3};return(e,i,s)=>{const a=e.closestPointToPoint(i,!1,t.closestPt),o=j(s,a,i);t.dist=o;const n=j(s,e.start,a);return t.weight=Math.max(5-.0025*n,0),t}})(),$=(()=>{const t=new B.Vector3,e=new B.Vector3;return(i,s)=>(t.subVectors(i.end,i.start).normalize(),e.subVectors(s.end,s.start).normalize(),Math.abs(t.dot(e))<.1)})();var q,Y,Z=i(32597),X=i(80978),K=i(32683);!function(t){t[t.WALLS=0]="WALLS",t[t.DOORS=1]="DOORS",t[t.OPENINGS=2]="OPENINGS"}(q||(q={})),function(t){t[t.MOVE=0]="MOVE",t[t.START=1]="START",t[t.END=2]="END"}(Y||(Y={}));class Q extends N.State{constructor(){super(...arguments),this.addType=q.WALLS,this.wallType=F.d.SOLID,this.wallOpeningType=X.u.DOOR,this.openingEditState=Y.MOVE,this.cursor=g.C.ROOMBOUNDS_DEFAULT}}const J=(t,e,i,s=!1)=>{const a=new Set;a.add(t.id);const o=e.getNode(t.id),n=e.getWallsForNode(o);for(const t of n){a.add(t.id);const i=t.getOtherNode(o);1===e.getEdgeCountForNode(o)&&1===e.getEdgeCountForNode(i)&&a.add(i.id)}const r=s?t.getVec3():void 0;return i.getCurrentRoomBoundHit(a,r)};var tt=i(78596);class et{constructor(t,e,i,s,a,o,n){this.editor=t,this.getCursorOrigin=e,this.data=i,this.cameraData=s,this.snappingAxesRenderer=a,this.keyboardState=o,this.analytics=n,this.readBindings=[],this.writeBindings=[],this.edgeStateOnDragStart={fromOffset:new B.Vector3,toOffset:new B.Vector3,initialGrabPt:new B.Vector3,dragDir:new B.Vector3,fromDirection:new B.Vector3,toDirection:new B.Vector3},this.openingStateOnDragStart={relativeStart:0,relativeEnd:0,wallLine:new B.Line3},this.onMoveStart=({target:t,placeOnly:e})=>{if(t&&e){const e=this.data.getEntity(t);e instanceof F.c?this.onWallMoveStart(e):e instanceof X.E&&this.onWallOpeningMoveStart(e)}},this.mover={onMove:(t,e)=>{const{data:i,editor:s}=this;if(!s.state.currentId)return;const a=s.state.toolState===N.ToolState.ADDING?i.getEntity(s.state.toId):i.getEntity(s.state.currentId),o=this.getCursorOrigin();a instanceof k.z?this.onMoveNode(a,o):a instanceof F.c?this.onMoveWall(a,o):a instanceof X.E&&this.onMoveWallOpening(a,o)}},this.mergePointAndStartNewWall=({target:t})=>{const{editor:e}=this;if(e.state.toolState===N.ToolState.ADDING&&t){const t=this.getCursorOrigin(),e=new B.Vector3,i=this.checkForNodeOrWallHit(this.editor.state.toId);if(this.data.finalizeHistory(),i)this.editor.discard(),this.editor.select(this.editor.state.toId),this.snappingAxesRenderer.hide();else{const i=this.data.getNode(this.editor.state.toId);this.tryApplySnapping(t,i,e),this.data.moveNode(this.editor.state.toId,e);const{wall:s,toId:a}=this.data.addTrailingEdgeToNode(this.editor.state.wallType,this.editor.state.toId,e,this.data.getLastWallWidth(this.editor.state.wallType));this.editor.add(s),this.editor.state.toId=a}}},this.finalizeMovePt=({target:t})=>{if(t){const e=this.data.getEntity(t);e instanceof k.z?this.checkForNodeOrWallHit(t):e instanceof F.c&&(this.checkForNodeOrWallHit(e.from.id,!1),this.checkForNodeOrWallHit(e.to.id,!1)),this.data.finalizeHistory(),this.snappingAxesRenderer.hide()}},this.killLastWall=({target:t})=>{const{data:e,editor:i}=this;i.state.toolState===N.ToolState.ADDING&&(this.clearHighlightedViews(),t&&this.data.undo(),e.finalizeHistory(),this.snappingAxesRenderer.hide())},this.onHoverChange=({target:t,previous:e})=>{if(this.editor.state.toolState===N.ToolState.ADDING)return;if(!t)return this.editor.clearAllDims(),this.editor.clearAllHighlights(),void(this.editor.state.selected&&this.setSelectedView(this.editor.state.selected));const i=this.data.getEntity(t);this.hoverView(i)},this.onCurrentChange=({target:t})=>{this.editor.state.toolState!==N.ToolState.ADDING&&this.clearHighlightedViews(),this.highlightView(t)},this.onSelectChange=({target:t})=>{if(this.setSelectedView(t),t){const e=this.data.getEntity(t);if(e instanceof K.J){const t=e.classifications.map((t=>t.id)).join(",");this.analytics.track("room_bound_room_clicked",{classifications:t})}}},this.editableEntities=new T.EditorEntityAdapter(this.editor),this.editor.setValidator(this)}addEditableEntity(t,e){this.editableEntities.registerEntity(e,this,t)}removeEditableEntity(t){this.editableEntities.unregisterEntity(t)}activate(t){0===this.readBindings.length?this.readBindings.push(this.editor.subscribe(N.Events.CurrentChange,this.onCurrentChange),this.editor.subscribe(N.Events.SelectChange,this.onSelectChange),this.editor.subscribe(N.Events.HoverChange,this.onHoverChange)):this.readBindings.forEach((t=>t.renew())),t||(0===this.writeBindings.length?this.writeBindings.push(this.editor.subscribe(N.Events.EditStart,this.onMoveStart),this.editor.subscribe(N.Events.AddConfirm,this.mergePointAndStartNewWall),this.editor.subscribe(N.Events.EditConfirm,this.finalizeMovePt),this.editor.subscribe(N.Events.AddDiscard,this.killLastWall)):this.writeBindings.forEach((t=>t.renew())))}deactivate(){this.readBindings.forEach((t=>t.cancel())),this.writeBindings.forEach((t=>t.cancel()))}onWallMoveStart(t){const e=this.getCursorOrigin();t.from.getVec3(this.edgeStateOnDragStart.fromOffset),t.to.getVec3(this.edgeStateOnDragStart.toOffset),this.edgeStateOnDragStart.fromOffset.sub(e),this.edgeStateOnDragStart.toOffset.sub(e),this.edgeStateOnDragStart.initialGrabPt.copy(e),t.getDirection(this.edgeStateOnDragStart.dragDir),this.edgeStateOnDragStart.dragDir.normalize(),this.edgeStateOnDragStart.dragDir.applyAxisAngle(new B.Vector3(0,1,0),Math.PI/2);const i=this.edgeStateOnDragStart.dragDir,s=this.needsWallJoint(t,t.from,i),a=this.needsWallJoint(t,t.to,i);(s||a)&&this.data.addWallJoint(t.id,s?t.from.id:void 0,a?t.to.id:void 0),this.getWallDirection(t,t.from,i,this.edgeStateOnDragStart.fromDirection),this.getWallDirection(t,t.to,i,this.edgeStateOnDragStart.toDirection),i.dot(this.edgeStateOnDragStart.fromDirection)<0&&this.edgeStateOnDragStart.fromDirection.multiplyScalar(-1),i.dot(this.edgeStateOnDragStart.toDirection)<0&&this.edgeStateOnDragStart.toDirection.multiplyScalar(-1)}onWallOpeningMoveStart(t){const e=this.data.getWall(t.wallId),{wallLine:i}=this.openingStateOnDragStart;e.from.getVec3(i.start),e.to.getVec3(i.end);const s=t.width/this.openingStateOnDragStart.wallLine.distance()*.5;this.openingStateOnDragStart.relativeStart=t.relativePos-s,this.openingStateOnDragStart.relativeEnd=t.relativePos+s}onMoveNode(t,e){const i=new B.Vector3,s=this.tryApplySnapping(e,t,i);if(s){const{closestLine:t,orthoLine:e,targetType:i}=s;i===U.LINE||i===U.POINT?i===U.POINT?this.snappingAxesRenderer.showAt(t,e):this.snappingAxesRenderer.showAt(t):this.snappingAxesRenderer.hide()}else this.snappingAxesRenderer.hide();this.data.moveNode(t.id,i)}onMoveWall(t,e){const{initialGrabPt:i,dragDir:s,fromOffset:a,toOffset:o,fromDirection:n,toDirection:r}=this.edgeStateOnDragStart,d=e.clone().sub(i),l=s.dot(d),c=n.clone().multiplyScalar(l),h=i.clone().add(c).add(a),u=r.clone().multiplyScalar(l),m=i.clone().add(u).add(o);this.data.moveWall(t.id,h,m)}onMoveWallOpening(t,e){const{editor:i,openingStateOnDragStart:s}=this,{relativeStart:a,relativeEnd:o,wallLine:n}=s,r=n.closestPointToPointParameter(e,!0);switch(i.state.openingEditState){case Y.MOVE:const e=t.width/n.distance()*.5;r+e<1&&r-e>0&&this.data.editWallOpeningDetails(t.id,{relativePos:r});break;case Y.START:case Y.END:{const e=i.state.openingEditState===Y.START?(o-r)*n.distance():(r-a)*n.distance();if(e<tt.PW&&e<t.width)return;const s=.5*(r+o);this.data.editWallOpeningDetails(t.id,{relativePos:s,width:e})}}}checkForNodeOrWallHit(t,e=!0){const i=this.data.getNode(t),s=J(i,this.data,this.editor,!0);if(s){if(s instanceof k.z)return this.data.mergeNodes(t,s.id),!0;if(s instanceof F.c){const a=new B.Vector3;if(e){const t=this.getCursorOrigin();this.tryApplySnapping(t,i,a)}else i.getVec3(a);return this.data.splitEdgeWithNode(s.id,t,s.getProjection(a)),!0}}return!1}clearHighlightedViews(){this.editor.clearAllHighlights()}hoverView(t){t instanceof K.J&&this.hoverRoom(t)}setSelectedView(t){if(!t)return void this.editor.clearAllDims();const e=this.data.getEntity(t);e instanceof F.c&&this.editor.highlight(e.from.id,e.to.id),e instanceof K.J&&(this.clearHighlightedViews(),this.dimAllRooms(),this.selectRoom(e))}dimAllRooms(){this.editor.clearAllDims();for(const[,t]of this.data.rooms)this.dimRoom(t)}highlightView(t){if(!t)return;const e=this.data.getEntity(t);e instanceof F.c&&this.editor.highlight(t,e.from.id,e.to.id)}selectRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id);for(const e of t.points)this.editor.clearDim(e.id)}hoverRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id);for(const e of t.points)this.editor.clearDim(e.id)}dimRoom(t){const e=t.id;this.editor.dim(e);for(const e of t.walls)this.editor.dim(e.id);for(const e of t.points)this.editor.dim(e.id)}isSnappingDisabled(){return this.keyboardState.isKeyHeld(Z.R.ALT)||this.keyboardState.isKeyHeld(Z.R.SHIFT)}tryApplySnapping(t,e,i){if(i.copy(t),!this.isSnappingDisabled()){const s=H(this.data,this.cameraData,e,t);return i.copy(s.target),s}return null}getAttachedWall(t,e){const i=this.data.getWallsForNode(e);if(i)for(const e of i)if(e!==t)return e;return null}getWallDirection(t,e,i,s){const a=this.getAttachedWall(t,e);if(!a)return void s.copy(i);a.getDirection(s).normalize().equals(P.fU.ZERO)&&s.copy(i)}needsWallJoint(t,e,i){const s=this.data.getWallsForNode(e);for(const e of s){if(e===t)continue;const s=i.dot(e.getDirection().normalize());if(Math.abs(s)<.8)return!0}return!1}validate(t,e){const{editor:i,data:s}=this,a=i.state.toolState===N.ToolState.ADDING?s.getEntity(i.state.toId):s.getEntity(t);if(a instanceof k.z){const t=J(a,s,i,!0);if(t&&t instanceof k.z)return this.data.canMergeNodes(a.id,t.id)}return!0}}var it=i(10374),st=i(35895);class at{constructor(t){this.map=new Map,t.forEach((t=>this.map.set(t.state,t.subs)))}renew(t){(this.map.get(t)||[]).forEach((t=>t.renew()))}cancel(t){if(t){(this.map.get(t)||[]).forEach((t=>t.cancel()))}else this.map.forEach((t=>t.forEach((t=>t.cancel()))))}update(t,e){this.map.set(t,e)}}var ot,nt=i(67678),rt=i(80592),dt=i(89553),lt=i(23612),ct=i(86819),ht=i(51788),ut=i(82814),mt=i(12039),pt=i(94046),gt=i(96154),vt=i(72996),ft=i(15462),wt=i(23885),yt=i(12529);!function(t){t[t.BASE=yt.z.roomBounds]="BASE",t[t.OPENING_STENCIL=yt.z.roomBounds+1]="OPENING_STENCIL",t[t.ROOM=yt.z.roomBounds+2]="ROOM",t[t.EDGE=yt.z.roomBounds+3]="EDGE",t[t.HIGHLIGHTED_EDGE=yt.z.roomBounds+4]="HIGHLIGHTED_EDGE",t[t.OPENING_LINES=yt.z.roomBounds+5]="OPENING_LINES",t[t.NODE=yt.z.roomBounds+6]="NODE"}(ot||(ot={}));var St=i(89557);const Et=100;class bt extends B.Mesh{constructor(t,e,i,s){super(e,i),this.roomBoundsId=t,this.cameraData=s,this.animation=new St.z(0),this.prevColorState={opacity:1,innerColor:new B.Color,outerColor:new B.Color},this.pitchFactor=1,this.raycastEnabled=!0,this.opacity=1,this.selectState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.hoverState={active:!1,on:()=>{this.updateMaterial()},off:()=>this.updateMaterial()},this.highlightState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.dimState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.name=t,this.renderOrder=ot.BASE}updateMaterial(){let t=this.colors.baseState;this.dimState.active&&(t=this.colors.dimState),this.hoverState.active&&(t=this.colors.hoverState),(this.highlightState.active||this.selectState.active)&&(t=this.colors.selectState);t!==this.targetColorScheme&&(this.targetColorScheme=t)}tickAnimations(t){this.animation.tick(t)}dispose(){}raycast(t,e){if(!this.raycastEnabled)return;const i=[];super.raycast(t,i),i.length>0&&e.push(i[0])}setPitchFactor(t){this.pitchFactor=t,this.raycastEnabled=(0,W.Eb)(this.pitchFactor)}}var Dt=i(57216),It=i.n(Dt),Ct=i(4014),At=i.n(Ct),Ot=i(33057),Rt=i.n(Ot),Vt=i(56413),Nt=i.n(Vt),Tt=i(27706),Mt=i.n(Tt),xt=i(73403),Lt=i.n(xt);const Pt={uniforms:{outlineColor:{type:"v4",value:ft.I.BLACK},baseColor:{type:"v4",value:ft.I.SINE},outlinePct:{type:"f",value:.8},radius:{type:"f",value:tt.pp},opacity:{type:"f",value:1}},vertexShader:It(),fragmentShader:At()},Ft={uniforms:{outlineColor:{type:"v3",value:ft.I.WHITE},color:{type:"v3",value:ft.I.WHITE},lineStart:{type:"v3",value:new B.Vector3},lineEnd:{type:"v3",value:new B.Vector3},width:{type:"f",value:1},selectedWidth:{type:"f",value:.01},opacity:{type:"f",value:1}},vertexShader:Rt(),fragmentShader:Nt()},kt={uniforms:{baseColor:{type:"v4",value:ft.I.WHITE},isDoor:{type:"f",value:1},opacity:{type:"f",value:1}},vertexShader:Mt(),fragmentShader:Lt()};var Bt=i(93411),Wt=i(67944);const _t={baseState:{opacity:1,innerColor:ft.I.MIRROR,outerColor:ft.I.PORTAL},hoverState:{opacity:1,innerColor:ft.I.MIRROR,outerColor:ft.I.PORTAL},selectState:{opacity:1,innerColor:ft.I.MP_BRAND,outerColor:ft.I.WHITE},dimState:{opacity:1,innerColor:ft.I.MIRROR,outerColor:ft.I.PORTAL}};class Ut extends B.RawShaderMaterial{constructor(){super({fragmentShader:Pt.fragmentShader,vertexShader:Pt.vertexShader,uniforms:B.UniformsUtils.clone(Pt.uniforms),name:"HandleMaterial",transparent:!0,depthTest:!1,extensions:{derivatives:!0}})}}class Ht extends bt{constructor(t,e){const i=new Float32Array([-1,0,-1,1,0,-1,1,0,1,-1,0,1]),s=new B.BufferGeometry;s.setAttribute("position",new B.Float32BufferAttribute(i,3)),s.setIndex([0,2,1,0,3,2]),super(t,s,new Ut,e),this.targetRadius=.3,this.prevRadius=.3,this.renderOrder=ot.NODE,this.colors=_t,this.animation.onChanged((()=>this.onAnimationChange())),this.onBeforeRender=()=>{this.material.uniforms.opacity.value=this.opacity*(1-this.pitchFactor)}}onAnimationChange(){const t=this.prevColorState,e=this.targetColorScheme;this.material.uniforms.outlineColor.value.lerpColors(t.outerColor,e.outerColor,this.animation.value),this.material.uniforms.baseColor.value.lerpColors(t.innerColor,e.innerColor,this.animation.value),this.opacity=(0,Bt.t)(t.opacity,e.opacity,this.animation.value);const i=(0,Bt.t)(this.prevRadius,this.targetRadius,this.animation.value);this.setRadius(i)}setPitchFactor(t){super.setPitchFactor(t),this.visible=this.pitchFactor<1}raycast(t,e){const i=[];if(super.raycast(t,i),i.length>0){const s=i[0].point,a=t.ray.origin.distanceTo(this.position),o=(0,Wt._U)(a,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),n=tt.Nh*o;s.distanceTo(this.position)<tt.pp+n&&e.push(i[0])}}updateMaterial(){this.prevRadius=this.material.uniforms.radius.value,this.targetRadius=tt.pp+(this.hoverState.active?tt.XG:0)+(this.selectState.active?tt.XG:0),super.updateMaterial(),this.prevColorState.innerColor.copy(this.material.uniforms.baseColor.value),this.prevColorState.outerColor.copy(this.material.uniforms.outlineColor.value),this.prevColorState.opacity=this.material.opacity,this.animation.modifyAnimation(0,1,Et,wt.hl)}setRadius(t){this.material.uniforms.radius.value=t}updatePosition(t){this.position.copy(t)}}class zt extends B.RawShaderMaterial{constructor(){super({fragmentShader:kt.fragmentShader,vertexShader:kt.vertexShader,uniforms:B.UniformsUtils.clone(kt.uniforms),name:"OpeningMaterial",depthTest:!1,transparent:!0,stencilFunc:B.AlwaysStencilFunc,stencilWrite:!1})}}const jt=new B.BoxGeometry(1,1,1);class Gt extends bt{constructor(t,e,i){super(t,jt.clone(),new zt,i),this.floorId=e,this.onEdgePositionChanged=(()=>{const t=new B.Vector3;return(e,i,s,a)=>{t.subVectors(i,e),this.scale.set(t.length(),.05,s),this.stencilPrepass&&this.stencilPrepass.scale.set(t.length(),.05,s);const o=Math.atan2(i.x-e.x,i.z-e.z)+Math.PI/2;this.rotation.y=o,this.stencilPrepass&&(this.stencilPrepass.rotation.y=o);const n=t.addVectors(i,e).multiplyScalar(.5);this.position.copy(n),this.stencilPrepass&&this.stencilPrepass.position.copy(n),this.startHandle.position.copy(e),this.endHandle.position.copy(i);const r=a===X.u.DOOR?1:0;this.material.uniforms.isDoor.value=r,this.stencilPrepass&&(this.stencilPrepass.material.uniforms.isDoor.value=r)}})(),this.renderOrder=ot.OPENING_LINES,this.startHandle=new Zt(t,i,this),this.endHandle=new Xt(t,i,this),this.animation.onChanged((()=>{this.material.uniforms.baseColor.value.lerpColors(ft.I.WHITE,ft.I.NEPTUNE,this.animation.value)}))}setPitchFactor(t){super.setPitchFactor(t),this.visible=this.pitchFactor<1,this.startHandle.setPitchFactor(t),this.endHandle.setPitchFactor(t),this.stencilPrepass&&this.stencilPrepass.setPitchFactor(t)}updateMaterial(){const t=this.selectState.active||this.hoverState.active||this.highlightState.active;this.animation.modifyAnimation(this.animation.value,t?1:0,Et,wt.hl)}tickAnimations(t){super.tickAnimations(t),this.startHandle.tickAnimations(t),this.endHandle.tickAnimations(t)}}class $t extends Gt{constructor(t,e,i){super(t,e,i),this.floorId=e,this.stencilPrepass=new qt(t,e,i)}}class qt extends Gt{constructor(t,e,i){super(t,e,i),this.floorId=e,this.renderOrder=ot.OPENING_STENCIL,this.material.colorWrite=!1,this.material.stencilRef=1,this.material.stencilFail=B.ReplaceStencilOp,this.material.stencilZFail=B.ReplaceStencilOp,this.material.stencilZPass=B.ReplaceStencilOp,this.material.stencilFunc=B.AlwaysStencilFunc,this.material.stencilWrite=!0}raycast(t,e){}}class Yt extends Ht{constructor(t,e,i){super(t,e),this.parentOpeningView=i}}class Zt extends Yt{}class Xt extends Yt{}var Kt=i(16782),Qt=i(92826),Jt=i(49827),te=i(69505),ee=i(96139),ie=i(27990);function se(t,e,i){const s=function(t){return t/180*Math.PI}(e||0);if(!i||0===i[0]&&0===i[1])return ae(t,s);return ae(t.map(((t,e)=>t-i[e])),s).map(((t,e)=>t+i[e]))}function ae(t,e){return[t[0]*Math.cos(e)-t[1]*Math.sin(e),t[0]*Math.sin(e)+t[1]*Math.cos(e)]}var oe=i(18810),ne=i(53831),re=i(19810),de=i(5696);function le(t,e,i=0){let s=!1;const a=(0,ne.x)(e);for(let e=0,o=a.length-1;e<o;e++)if((0,de.s8)(t,[a[e],a[e+1]],i)){s=!0;break}return s}function ce(t,e){let i=!1,s=0;const a=(0,ne.x)(t);for(let t=0,o=a.length-1;t<o;t++){const o=a[t],n=a[t+1];if((0,re.t)([o,n],e)){i=!0;break}if(le(o,e)&&++s,2===s){i=!0;break}}return i}var he=i(72119),ue=i(37519);class me{constructor(t,e,i,s,a,o){this.cameraData=t,this.start=new B.Vector3,this.end=new B.Vector3,this.width=.1,this.getLinePositions=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3,a=new B.Vector3;return()=>{t.copy(this.start),e.copy(this.end);const o=(0,ie.Ko)(t,e,this.cameraData),n=(0,ie.hJ)(this.label.text.length),r=o.pixelDistance>n.width&&this.labelVisible;this.labelOpacityAnimation.modifyAnimation(this.labelOpacityAnimation.value,r?1:0,150);const d=this.cameraData.isOrtho(),l=d?Math.abs(this.label.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(this.label.position);i.addVectors(t,e).multiplyScalar(.5),d?(a.subVectors(e,t),a.applyAxisAngle(P.fU.UP,.5*Math.PI).normalize()):a.copy(P.fU.UP);const c=(0,Wt._U)(l,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),h=d?2:10;return s.copy(i),s.addScaledVector(a,.5*this.width+.75*this.label.scale.x+c*h),{start:t,end:e,center:i,labelPosition:s,lineRotation:o.rotation}}})(),this.label=a.createLabel(),this.label.setRenderOrder(yt.z.labels),this.label.opacity=0,this.labelOpacityAnimation=new St.z(0),this.updateDimensions(i,s,e,o)}addTo(t){t.add(this.label)}removeFrom(t){t.remove(this.label)}dispose(){this.label.dispose()}tickAnimations(t){this.labelOpacityAnimation.tick(t)}setVisible(t){t!==this.labelVisible&&(this.labelVisible=t)}updateDimensions(t,e,i,s){this.start.copy(t),this.end.copy(e),this.width=i;const a=this.start.distanceTo(this.end),o=(0,ie.up)(a,s);this.label.text=o}update(){this.updateOpacity(),this.updateBillboard()}updateOpacity(){this.label.opacity=this.labelOpacityAnimation.value}updateBillboard(){const{labelPosition:t,lineRotation:e}=this.getLinePositions(),{label:i}=this;i.setPosition(t),i.setOrientation(this.cameraData.pose.rotation,e);const{position:s,projection:a}=this.cameraData.pose,o=this.cameraData.aspect(),{height:n}=this.cameraData,r=this.cameraData.zoom(),d=(0,Wt.mY)(a,s,i.position,n,he.Hn.SCALE),l=(0,Wt.Pp)(a)?0:((0,ue.uZ)(o,1,2.5)+r)*he.Hn.SCALE_ASPECT,c=1+he.Hn.SCALE_NDC-l,h=Math.max(Math.min(1/d*c,3),.001);i.scaleFactor=h}}class pe{constructor(){this.primary=new B.Vector3,this.bevel=new B.Vector3}set(t,e,i){this.primary.set(t,e,i),this.bevel.set(t,e,i)}copy(t,e){this.primary.copy(t),e?this.bevel.copy(e):this.bevel.copy(t)}}const ge=(()=>{const t={fromLeft:new pe,fromRight:new pe,toLeft:new pe,toRight:new pe};return(e,i)=>{ye(e,t);const s=i.getWallNeighbors(e,"from"),a=i.getWallNeighbors(e,"to");return s&&(fe(e,s.left,"from","left",t.fromLeft),fe(e,s.right,"from","right",t.fromRight)),a&&(fe(e,a.left,"to","left",t.toLeft),fe(e,a.right,"to","right",t.toRight)),t}})(),ve=(()=>{const t={start:new B.Vector3,end:new B.Vector3},e={fromLeft:new pe,fromRight:new pe,toLeft:new pe,toRight:new pe};return(i,s,a,o)=>{let n,r,d,l,c;return o?(n="right",r="to",d="from",l=e.toRight,c=e.fromRight):(n="left",r="from",d="to",l=e.fromLeft,c=e.toLeft),ye(i,e),fe(i,s,r,n,l),fe(i,a,d,n,c),t.start.copy(l.primary),t.end.copy(c.primary),t}})(),fe=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3,a=new B.Vector3,o=new B.Vector3,n=new B.Vector3,r=new B.Vector2,d=new B.Vector2,l=new B.Vector2,c=new B.Vector3,h=new B.Vector3;return(u,m,p,g,v)=>{const f=u.getDirection(t).normalize(),w=u[p],y="from"===p?-1:1,S=m.getOtherNode(w).getVec3(e).sub(w.getVec3(i)).normalize().multiplyScalar(y),E=f.dot(S);if(Math.acos(E)*te.MN<5)return;u.getBiasAdjustmentVec(c),m.getBiasAdjustmentVec(h);const b="left"===g?Math.PI/2:-Math.PI/2,D=f.applyAxisAngle(P.fU.UP,b).multiplyScalar(u.width/2).add(c),I=S.applyAxisAngle(P.fU.UP,b).multiplyScalar(m.width/2).add(h);u.from.getVec3(s).add(D),u.to.getVec3(a).add(D),m.from.getVec3(o).add(I),m.to.getVec3(n).add(I);if((0,_.cB)(s.x,s.z,a.x,a.z,o.x,o.z,n.x,n.z,r)){const t=we(w,u,m,r,l),e=t.x>0&&t.y>0,i=t.x<0&&t.y<0;if(t.x<u.length&&t.y<m.length)if(e)v.set(r.x,0,r.y);else{d.set(w.x+c.x+h.x,w.z+c.z+h.z).distanceTo(r)>1.2*Math.max(u.width,m.width)&&i?Se(w,u,m,D,I,v):v.set(r.x,0,r.y)}}}})(),we=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3;return(a,o,n,r,d)=>{let l=o.getOtherNode(a);return a.getVec3(i),l.getVec3(t).sub(i),l=n.getOtherNode(a),l.getVec3(e).sub(i),s.set(r.x,0,r.y).sub(i),d.set(t.dot(s)/t.length(),e.dot(s)/e.length()),d}})(),ye=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3;return(a,o)=>{const n=a.width;a.getBiasAdjustmentVec(i),a.getNormal(t).multiplyScalar(-n/2).add(i),a.getNormal(e).multiplyScalar(n/2).add(i);const r=a.from.getVec3(s).add(e);o.fromRight.copy(r);const d=a.to.getVec3(s).add(e);o.toRight.copy(d);const l=a.to.getVec3(s).add(t);o.toLeft.copy(l);const c=a.from.getVec3(s).add(t);o.fromLeft.copy(c)}})(),Se=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3,a=new B.Vector3;return(o,n,r,d,l,c)=>{const h=n.getOtherNode(o),u=r.getOtherNode(o);o.getVec3(e),h.getVec3(t).sub(e).normalize().multiplyScalar(-n.width/2),u.getVec3(i).sub(e).normalize().multiplyScalar(-r.width/2),s.copy(e).add(d).add(t),a.copy(e).add(l).add(i),c.copy(s,a)}})(),Ee={baseState:{innerColor:ft.I.LENS_GRAY,outerColor:ft.I.WHITE,opacity:0},hoverState:{innerColor:ft.I.NEPTUNE,outerColor:ft.I.WHITE,opacity:.5},selectState:{innerColor:ft.I.NEPTUNE,outerColor:ft.I.WHITE,opacity:0},dimState:{innerColor:ft.I.LENS_GRAY,outerColor:ft.I.WHITE,opacity:.5}};class be extends bt{constructor(t,e,i,s,a,o){const n=be.getGeoFromRoom(t,i),r=new B.MeshBasicMaterial({color:ft.I.LENS_GRAY,depthTest:!1,side:B.DoubleSide,transparent:!0,opacity:0,blending:B.CustomBlending,blendEquation:B.AddEquation,blendSrc:B.SrcAlphaFactor,blendDst:B.DstColorFactor});super(t.id,n,r,s),this.perimeterLabelFactory=a,this.perimeterLabels=[],this.renderOrder=ot.ROOM,this.add(e),this.label=e,e.opacity=1,this.prevLabelOpacity=1,this.targetLabelOpacity=1,this.room=t,this.calculateMaxLabelSize(),this.updateLabelPosition(t,i),this.updatePerimeterLabels(o),this.colors=Ee,this.animation.onChanged((()=>{const t=this.prevColorState;this.material.color.lerpColors(t.innerColor,this.targetColorScheme.innerColor,this.animation.value);const e=(0,Bt.t)(t.opacity,this.targetColorScheme.opacity,this.animation.value);this.opacity=e;const i=(0,Bt.t)(this.prevLabelOpacity,this.targetLabelOpacity,this.animation.value);this.label.opacity=i})),this.onBeforeRender=()=>{this.material.opacity=this.opacity*(1-this.pitchFactor);for(const t of this.perimeterLabels)t.update()}}dispose(){this.label.dispose();for(const t of this.perimeterLabels)t.dispose();super.dispose()}updateGeo(t,e,i){this.room=t;const s=be.getGeoFromRoom(t,e);this.geometry.dispose(),this.geometry=s,this.geometry.computeBoundingBox(),this.calculateMaxLabelSize(),this.updateLabelPosition(t,e),this.updateLabelElipsis(),this.updatePerimeterLabels(i)}updateLabelBillboard(){const{position:t,rotation:e,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,a=this.cameraData.isOrtho()?this.cameraData.zoom():1,o=this.cameraData.aspect(),n=(0,_.dS)(64-ee.R.LABEL_SIZE,0,64,.02,.1);this.label.quaternion.copy(e),this.label.scaleBillboard(t,e,i,a,s,o,n),this.updateLabelElipsis();for(const t of this.perimeterLabels)t.update()}setLabelVisible(t){for(const e of this.perimeterLabels)e.setVisible(t)}updateMaterial(){super.updateMaterial(),this.hoverState.active&&(this.targetColorScheme=this.colors.hoverState),this.material.blending=this.hoverState.active?B.CustomBlending:B.NormalBlending;const t=this.material;this.prevColorState.innerColor.copy(t.color),this.prevColorState.opacity=t.opacity;const e=this.dimState.active;this.prevLabelOpacity=this.label.opacity,this.targetLabelOpacity=e?.5:1,this.animation.modifyAnimation(0,1,Et,wt.hl)}updateLabelPosition(t,e){this.label.position.copy(t.getViewCenter().clone().add(new B.Vector3(0,e,0)))}updateText(t,e){this.labelText=t,this.areaText=e,this.updateLabelElipsis()}static getGeoFromRoom(t,e){const i=t.points.map((t=>t.getVec2())),s=new B.Shape(i);s.holes=t.holesCW.map((t=>new B.Path(t.map((t=>t.getVec2())))));const a=new B.ShapeGeometry(s);return a.rotateX(Math.PI/2),a.translate(0,e,0),a}updateLabelElipsis(){let t=this.areaText,e=this.labelText;if(!t||!e)return;let i=!1;const s=this.cameraData.pose.position.distanceTo(this.room.getViewCenter()),a=(0,Wt._U)(s,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),o=(new B.Euler).setFromQuaternion(this.cameraData.pose.rotation).z,n=te.MN*o,r=this.room.getViewCenter(),d=[r.x,r.z],l=function(t,e,i){let s=[];for(let a=0,o=t.length;a<o;a++)s[a]=se(t[a],e,i);return s}(this.maxLabelPolygon,n,d);let c=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;l.forEach((([t,e])=>{c=Math.min(c,t),h=Math.max(h,t)}));const u=Math.abs(h-c)/a,m=this.getLabelPolygon(),p=(0,oe.D)(m,this.roomPolygon),g=Math.round((u-5)/9);if(!p||g<this.labelText.length){e=this.labelText.substring(0,g-3)+"...",i=!0}i&&(t=""),this.label.text=e+(t.length>0?"\n"+t:"")}calculateMaxLabelSize(){const t=this.room.bbox.getSize(new B.Vector2),e=.1*Math.min(t.x,t.y),i=this.room.getViewCenter(),s=this.room.points.map((t=>[t.x,t.z]));s.push(s[0]);const a=this.room.holesCW.map((t=>t.map((t=>[t.x,t.z])))),o=()=>{if(!(0,oe.D)(l,s))return!1;for(const t of a)if(ce(t,l))return!1;return!0},n=i.x,r=i.z,d=[];d.push([n-e,r-e]),d.push([n+e,r-e]),d.push([n+e,r+e]),d.push([n-e,r+e]),d.push(d[0]);const l=d;for(;o();)l[0][0]-=e,l[1][0]+=e,l[2][0]+=e,l[4][0]-=e;for(l[0][0]+=e,l[1][0]-=e,l[2][0]-=e,l[4][0]+=e;o();)l[0][1]-=e,l[1][1]-=e,l[2][1]+=e,l[4][1]+=e;l[0][1]+=e,l[1][1]+=e,l[2][1]-=e,l[4][1]-=e,this.maxLabelPolygon=l,this.roomPolygon=s}getLabelPolygon(){const t=this.cameraData.pose.position.distanceTo(this.room.getViewCenter()),e=(0,Wt._U)(t,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),i=(0,ie.hJ)(this.labelText.length,0,0),s=this.room.getViewCenter(),a=s.x,o=s.z,n=.5*i.width*e,r=.5*i.height*e,d=new B.Vector3;d.set(a-n,0,o-r),d.applyQuaternion(this.cameraData.pose.rotation);const l=[];return l.push([a-n,o-r]),l.push([a+n,o-r]),l.push([a+n,o+r]),l.push([a-n,o+r]),l.map((t=>(d.set(t[0],0,t[1]),d.applyQuaternion(this.cameraData.pose.rotation),[d.x,0,d.z]))),l.push(l[0]),l}updatePerimeterLabels(t){for(const t of this.perimeterLabels)t.removeFrom(this),t.dispose();this.perimeterLabels=[];const e=[],i=this.room.wallsCCW.length;for(let t=0;t<i;t++){const s=this.room.wallsCCW[(t+i-1)%i],a=this.room.wallsCCW[t],o=this.room.wallsCCW[(t+1)%i],n=ve(a.wall,s.wall,o.wall,a.flipped);e.push({start:n.start.clone(),end:n.end.clone(),width:a.wall.width})}const s=[];s.push(e[0]);const a=new B.Vector3,o=new B.Vector3,n=(t,e)=>{const i=t.end.distanceTo(e.start)<.01;a.subVectors(t.start,t.end).normalize(),o.subVectors(e.end,e.start).normalize();const s=Math.abs(Math.abs(a.dot(o))-1)<.01;return i&&s},r=e.length;for(let t=1;t<r;t++){const i=e[(t+r-1)%r],a=e[t];if(n(i,a)){const t=s[s.length-1];t.end.copy(a.end),t.width=Math.max(t.width,a.width)}else s.push(a)}const d=s[0],l=s[s.length-1];n(l,d)&&(d.start.copy(l.start),d.width=Math.max(d.width,l.width),s.pop());for(const e of s){const i=new me(this.cameraData,e.width,e.start.clone(),e.end.clone(),this.perimeterLabelFactory,t);i.addTo(this),this.perimeterLabels.push(i)}}tickAnimations(t){super.tickAnimations(t);for(const e of this.perimeterLabels)e.tickAnimations(t)}}var De,Ie=i(10840);!function(t){t[t.PIXELS=0]="PIXELS",t[t.METERS=1]="METERS"}(De||(De={}));class Ce extends B.Mesh{constructor(t,e,i){const s=new Float32Array([-9999,-9999,-9999,9999,9999,9999,-9999,-9999,-9999,9999,9999,9999,9999,9999,9999,-9999,-9999,-9999]),a=new Float32Array([1,1,0,0,-1,-1]),o=new Float32Array([0,1,0,1,0,1]),n=new B.BufferGeometry;n.setAttribute("position",new B.Float32BufferAttribute(s,3)),n.setAttribute("offsetDirection",new B.Float32BufferAttribute(a,1)),n.setAttribute("t",new B.Float32BufferAttribute(o,1)),n.setIndex([0,2,1,2,3,1,2,4,3,4,5,3]);let r={},d={};(null==i?void 0:i.dashUnits)===De.METERS&&(r={WORLDSPACE_DASH:!0},d={derivatives:!0});super(n,new B.RawShaderMaterial({uniforms:B.UniformsUtils.clone(Ie.T.screenline.uniforms),side:B.FrontSide,vertexShader:Ie.T.screenline.vertexShader,fragmentShader:Ie.T.screenline.fragmentShader,transparent:!0,depthTest:i.depthTest,depthWrite:i.depthWrite,depthFunc:i.depthFunc,defines:r,extensions:d})),this.updateEndpoints(t,e),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.renderOrder=yt.z.lines,this.onBeforeRender=t=>{t.getSize(this.material.uniforms.screenSize.value)},this.material.uniforms.dashed.value=+i.dashed,this.material.uniforms.dashSize.value=i.dashSize,this.material.uniforms.gapSize.value=i.gapSize,this.material.uniforms.lineWidth.value=i.lineWidth,this.material.uniforms.color.value.copy(i.color),this.material.uniforms.opacity.value=i.opacity}updateEndpoints(t,e){this.material.uniforms.start.value.copy(t),this.material.uniforms.end.value.copy(e)}opacity(t){this.material.uniforms.opacity.value=t}color(t){this.material.uniforms.color.value.copy(t)}}const Ae={baseState:{innerColor:ft.I.WHITE,outerColor:ft.I.WHITE,opacity:1},hoverState:{innerColor:ft.I.WHITE,outerColor:ft.I.NEPTUNE,opacity:1},selectState:{innerColor:ft.I.WHITE,outerColor:ft.I.NEPTUNE,opacity:1},dimState:{innerColor:ft.I.WHITE,outerColor:ft.I.WHITE,opacity:.5}};class Oe extends bt{constructor(t,e,i){const s=new Float32Array([0,0,0,1,0,0,1,0,1,0,0,1,-1,0,1,-1,0,0,1,0,2,-1,0,2,-1,0,-1,1,0,-1]),a=new B.BufferGeometry;a.setAttribute("position",new B.Float32BufferAttribute(s,3)),a.setIndex([0,1,2,0,2,3,0,3,4,0,4,5,3,2,6,3,7,4,0,9,1,0,5,8]);super(t,a,new B.RawShaderMaterial({uniforms:B.UniformsUtils.clone(Ft.uniforms),vertexShader:Ft.vertexShader,fragmentShader:Ft.fragmentShader,transparent:!0,depthTest:!1,stencilRef:1,stencilFail:B.KeepStencilOp,stencilZFail:B.KeepStencilOp,stencilZPass:B.KeepStencilOp,stencilFunc:B.GreaterStencilFunc,stencilWrite:!0,extensions:{derivatives:!0}}),e),this.lineLabel=i,this.line3=new B.Line3(new B.Vector3,new B.Vector3),this.widthCache=.1,this.updateMaterial=()=>{super.updateMaterial();const t=this.material.uniforms;this.prevColorState.innerColor.copy(t.color.value),this.prevColorState.outerColor.copy(t.outlineColor.value),this.prevColorState.opacity=t.opacity.value;const e=this.selectState.active||this.highlightState.active,i=this.hoverState.active;this.renderOrder=e||i?ot.HIGHLIGHTED_EDGE:ot.EDGE,this.animation.modifyAnimation(0,1,Et,wt.hl)},this.raycast=(()=>{const t=new B.Vector3,e=new B.Vector2,i=new B.Vector2;return(s,a)=>{const o=this.line3.closestPointToPoint(s.ray.origin,!0,t);e.set(o.x,o.z),i.set(s.ray.origin.x,s.ray.origin.z);const n=e.distanceTo(i),r=s.ray.origin.distanceTo(this.line3.start),d=(0,Wt._U)(r,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),l=tt.Nh*d;n<.5*this.widthCache+l&&a.push({distance:r,object:this,point:o.clone(),face:{a:-1,b:-1,c:-1,materialIndex:-1,normal:new B.Vector3(0,1,0)}})}})(),this.onEdgePositionChanged=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3,a=new B.Vector3,o=new B.Vector3,n=new B.Vector3;return(r,d,l)=>{var c;const h=r.getWall(this.roomBoundsId),u=(null===(c=d.floors.getFloor(h.floorId))||void 0===c?void 0:c.bottom)||0;h.from.getVec3(t),h.to.getVec3(e);const m=this.geometry.getAttribute("position");h.getBiasAdjustmentVec(n),i.set(t.x,t.y+u,t.z),s.set(e.x,e.y+u,e.z),a.addVectors(i,n),o.addVectors(s,n),this.line3.start.copy(a),this.line3.end.copy(o),this.material.uniforms.lineStart.value.copy(a),this.material.uniforms.lineEnd.value.copy(o),this.material.uniforms.width.value=h.width,this.widthCache=h.width,this.lineLabel.updateDimensions(a,o,h.width,l),m.setXYZ(0,i.x,i.y,i.z),m.setXYZ(3,s.x,s.y,s.z);const{fromLeft:p,fromRight:g,toLeft:v,toRight:f}=ge(h,r);m.setXYZ(1,g.primary.x,g.primary.y+u,g.primary.z),m.setXYZ(2,f.primary.x,f.primary.y+u,f.primary.z),m.setXYZ(4,v.primary.x,v.primary.y+u,v.primary.z),m.setXYZ(5,p.primary.x,p.primary.y+u,p.primary.z),m.setXYZ(9,g.bevel.x,g.bevel.y+u,g.bevel.z),m.setXYZ(6,f.bevel.x,f.bevel.y+u,f.bevel.z),m.setXYZ(7,v.bevel.x,v.bevel.y+u,v.bevel.z),m.setXYZ(8,p.bevel.x,p.bevel.y+u,p.bevel.z),m.needsUpdate=!0,this.perspectiveLine.updateEndpoints(i,s),this.occlusionLine.updateEndpoints(i,s),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere()}})(),this.renderOrder=ot.EDGE,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere();const o={dashed:!1,dashSize:1,gapSize:1,lineWidth:1,color:ft.I.WHITE,dashUnits:De.METERS,depthWrite:!1,depthTest:!0,depthFunc:B.LessDepth,opacity:1},n={dashed:!0,dashSize:.08,gapSize:.04,lineWidth:1,color:ft.I.WHITE,dashUnits:De.METERS,depthWrite:!1,depthTest:!0,depthFunc:B.GreaterDepth,opacity:1};this.occlusionLine=new Ce(new B.Vector3,new B.Vector3,n),this.perspectiveLine=new Ce(new B.Vector3,new B.Vector3,o),this.add(this.perspectiveLine),this.add(this.occlusionLine),this.colors=Ae,this.material.uniforms.selectedWidth.value=.03;const r=ft.I.WHITE.clone();this.animation.onChanged((()=>{const t=this.prevColorState,e=this.targetColorScheme;this.material.uniforms.outlineColor.value.lerpColors(t.outerColor,e.outerColor,this.animation.value);this.material.uniforms.color.value.lerpColors(t.innerColor,e.innerColor,this.animation.value);const i=(0,Bt.t)(t.opacity,e.opacity,this.animation.value);this.opacity=i,r.copy(ft.I.WHITE).multiplyScalar(this.opacity),this.occlusionLine.color(r),this.perspectiveLine.color(r)})),this.onBeforeRender=()=>{this.material.depthTest=1===this.pitchFactor,this.material.uniforms.opacity.value=(1-this.pitchFactor)*this.opacity,this.occlusionLine.opacity(this.pitchFactor),this.perspectiveLine.opacity(this.pitchFactor),this.lineLabel.update()}}tickAnimations(t){super.tickAnimations(t),this.lineLabel.tickAnimations(t)}setLabelVisible(t){this.lineLabel.setVisible(t)}dispose(){super.dispose(),this.lineLabel.dispose()}}const Re=new C.Z("room-bounds-editor"),Ve=t=>{const e=Re.debug;return(0,st.k1)((()=>e(`${t}.renew()`)),(()=>e(`${t}.cancel()`)),!1)};class Ne extends N.DragAndDrop{constructor(t,e,i,s,a,o,n,r,d,l){super(new Q),this.getCursorOrigin=t,this.input=e,this.raycaster=i,this.messageBus=s,this.data=a,this.floorsViewData=o,this.cameraPoseData=n,this.commandBinder=r,this.canvasData=d,this.allViewsComparator=vt.s.is((t=>this.state.toolState===N.ToolState.READ_ONLY||this.state.toolState===N.ToolState.SELECTED_READ_ONLY?t instanceof be:t instanceof bt)),this.draggableViewsComparator=vt.s.is((t=>(t instanceof Oe||t instanceof $t||t instanceof Ht)&&!!t.raycastEnabled)),this.addPoint=t=>{if(t.button!==Kt.M.PRIMARY)return;const e=this.getCurrentRoomBoundHit(),i=this.getCursorOrigin(),s={x:i.x,z:i.z};switch(this.data.finalizeHistory(),this.state.addType){case q.WALLS:{const{wallType:t}=this.state,a=this.data.getLastWallWidth(t);if(e)if(e instanceof k.z){const{wall:i,toId:o}=this.data.addTrailingEdgeToNode(t,e.id,s,a);this.state.toId=o,this.add(i)}else if(e instanceof F.c){const o=e.getProjection(i),{newTrailingWall:n,newNodeToId:r}=this.data.addTrailingEdgeToEdge(t,e.id,o,s,a);this.add(n.id),this.state.toId=r}else{if(!(e instanceof K.J||e instanceof X.E))throw new Error("Trying to add a new Edge on an invalid object type");this.addFirstFloatingPoint(s)}else this.addFirstFloatingPoint(s)}break;case q.DOORS:case q.OPENINGS:{const t=this.state.tempHoverPreviewEntityId;t&&(this.data.finalizeHistory(),setTimeout((()=>this.select(t)),1),this.state.tempHoverPreviewEntityId=null)}}},this.moveTemporaryPreview=()=>{const t=new B.Line3;return(()=>{const e=this.state.tempHoverPreviewEntityId;if(e){if(this.state.addType!==q.DOORS&&this.state.addType!==q.OPENINGS)return void this.deleteTemporaryPreview();const i=this.data.getOpening(e),s=this.data.getWall(i.wallId).getLine3(t),a=this.getCursorOrigin(),o=s.closestPointToPointParameter(a,!0),n=i.width/s.distance()*.5;o+n<1&&o-n>0&&this.data.editWallOpeningDetails(e,{relativePos:o})}})()},this.mergePointAndStartNewWall=t=>{this.tryCommit()},this.updateCursor=(t=!1)=>{const{toolState:e,toId:i,pendingValid:s,pendingAdd:a,pendingEdit:o}=this.state;let n=g.C.ROOMBOUNDS_DEFAULT;if((e===N.ToolState.ADDING||e===N.ToolState.WAIT_FOR_ADD)&&(n=g.C.ROOMBOUNDS_PLACE_NODE,i))try{const t=this.data.getNode(i),e=J(t,this.data,this);e&&(e instanceof F.c||e instanceof k.z)&&(n=g.C.ROOMBOUNDS_FINISH_ROOM)}catch(t){}this.state.dragging&&(n=g.C.ROOMBOUNDS_MOVING),(a||o)&&!1===s&&(n=g.C.NOPE),this.state.cursor!==n&&(this.state.cursor=n,this.state.commit())};const c=[this.subscribe(N.Events.StateChange,(async({target:t})=>{this.inputStates||(this.inputStates=this.bindInputToEditorStates(l)),this.inputStates.cancel(),this.inputStates.renew(t)})),this.subscribe(N.Events.CurrentChange,(()=>this.updateCursor())),this.subscribe(N.Events.ValidChange,(()=>this.updateCursor())),this.subscribe(N.Events.HoverChange,(()=>this.updateCursor())),this.input.registerHandler(nt.mE,(()=>this.updateCursor()))];c.forEach((t=>t.cancel())),this.bindings.push(...c)}exit(){super.exit(),this.inputStates&&this.inputStates.cancel()}bindInputToEditorStates(t){const e=new D.V(this.input.registerPriorityHandler(rt._t,ut.S,(()=>!0)),this.input.registerPriorityHandler(rt._t,pt.i,(()=>!0)));e.cancel();const i=()=>this.setEnabled(!1),s=()=>this.setEnabled(!0),a=()=>this.exit(),o=new D.V((0,st.k1)((()=>this.messageBus.subscribe(gt.oR,i)),(()=>this.messageBus.unsubscribe(gt.oR,i)),!1),(0,st.k1)((()=>this.messageBus.subscribe(gt.NR,s)),(()=>this.messageBus.unsubscribe(gt.NR,s)),!1),(0,st.k1)((()=>this.messageBus.subscribe(it.bS,a)),(()=>this.messageBus.unsubscribe(it.bS,a)),!1),this.cameraPoseData.onChanged((()=>{this.state.toolState!==N.ToolState.CLOSED&&this.setEnabled(this.cameraPoseData.pitchFactor()<1)}))),n=new D.V(this.input.registerUnfilteredHandler(dt.e,(t=>{t.key===Z.R.ESCAPE&&this.discard(),t.key===Z.R.RETURN&&this.tryCommit()})));n.cancel();const r=new Qt.r(t,"keydown",(t=>{"KeyZ"===t.code&&(t.ctrlKey||t.metaKey)&&this.commandBinder.issueCommand(new L.o3)}));r.cancel();const d=new D.V(this.input.registerMeshHandler(lt.z,this.allViewsComparator,((t,e)=>this.hover(e.roomBoundsId,e))),this.input.registerMeshHandler(lt.A,this.allViewsComparator,(()=>this.unhover())));d.cancel();const l=this.input.registerUnfilteredHandler(dt.e,(t=>{t.key===Z.R.ESCAPE&&this.deselect()}));l.cancel();const c=this.input.registerUnfilteredHandler(dt.e,(t=>{if(this.canvasData.isCanvasFocused()&&[Z.R.DELETE,Z.R.BACKSPACE].includes(t.key)){const{currentId:t}=this.state;t&&(this.discard(),this.data.deleteEntity(t),this.data.finalizeHistory())}}));c.cancel();const h=new D.V(this.input.registerPriorityHandler(ct.R,ut.S,(()=>(this.deselect(),!0))),this.input.registerPriorityHandler(ct.R,pt.i,(()=>(this.deselect(),!0))));h.cancel();const u=new D.V(this.input.registerMeshHandler(ct.R,this.allViewsComparator,this.onToggleSelectInput.bind(this)),this.input.registerMeshHandler(rt.u4,this.allViewsComparator,this.onToggleSelectInput.bind(this)),this.input.registerMeshHandler(rt._t,this.draggableViewsComparator,this.onToggleSelectInput.bind(this)));u.cancel();const m=this.input.registerUnfilteredHandler(ct.R,this.addPoint),p=this.input.registerUnfilteredHandler(ct.R,this.mergePointAndStartNewWall),g=new D.V(this.input.registerMeshHandler(rt.u4,this.draggableViewsComparator,this.placeOnDrag.bind(this)),this.input.registerMeshHandler(rt.Zv,this.draggableViewsComparator,this.onDragEnd.bind(this)));g.cancel();const v=this.input.registerUnfilteredHandler(nt.mE,(t=>this.move(t)));v.cancel();const f=this.input.registerUnfilteredHandler(nt.er,this.dropOnPointerUp.bind(this));f.cancel();const w=this.input.registerUnfilteredHandler(nt.mE,this.moveTemporaryPreview.bind(this));w.cancel();const y=this.input.registerUnfilteredHandler(nt.er,(t=>{t.button===Kt.M.PRIMARY&&this.updateCursor(!0)})),S=(0,st.k1)((()=>{this.commandBinder.issueCommand(new mt.ZK),this.commandBinder.issueCommand(new ht.t)}),(()=>{this.commandBinder.issueCommand(new mt.Lp),this.commandBinder.issueCommand(new ht.U)}),!1),E=new D.V(o,d,u,Ve("ToolState.READ_ONLY -> bindings")),b=new D.V(o,d,u,g,y,r,Ve("ToolState.IDLE -> bindings")),I=new D.V(o,n,d,w,m,S,Ve("ToolState.WAIT_FOR_ADD -> bindings")),C=new D.V(o,n,v,d,p,S,r,Ve("ToolState.ADDING -> bindings")),A=[o,u,d,y,l,h],O=[g,r,c],R=new D.V(...A,...O,Ve("ToolState.SELECTED -> bindings")),V=new D.V(...A,Ve("ToolState.SELECTED_READ_ONLY -> bindings")),T=new D.V(o,e,n,d,Ve("ToolState.PLACING -> (base) bindings")),M=new D.V(...A,...O,Ve("ToolState.EDITING -> bindings"));return new at([{state:N.ToolState.DISABLED,subs:[o]},{state:N.ToolState.READ_ONLY,subs:[E]},{state:N.ToolState.IDLE,subs:[b]},{state:N.ToolState.WAIT_FOR_ADD,subs:[I]},{state:N.ToolState.ADDING,subs:[C]},{state:N.ToolState.SELECTED,subs:[R]},{state:N.ToolState.SELECTED_READ_ONLY,subs:[V]},{state:N.ToolState.EDITING,subs:[M]},{state:N.ToolState.PLACING,subs:[T,v,f]}])}getCurrentRoomBoundHit(t,e){let i;const s=t=>t instanceof bt,a=t=>s(t.object);if(null==e)i=this.input.getCurrentRayHits().filter(a);else{const t=e.clone().add(new B.Vector3(0,1e3,0));i=this.raycaster.picking.cast(t,P.fU.DOWN,s)}let o=i.filter(a).map((t=>t.object.roomBoundsId));return t&&(o=o.filter((e=>!t.has(e)))),o.length>0?this.data.getEntity(o[0]):null}onToggleSelectInput(t,e){this.updateOpeningEditState(e);const i=e.roomBoundsId;i&&setTimeout((()=>{if(e.parent){if(this.state.selected===i)t instanceof ct.R&&(this.discard(),this.deselect());else{const t=this.state.toolState;t!==N.ToolState.EDITING&&t!==N.ToolState.PLACING||this.discard(),this.select(i),t!==N.ToolState.READ_ONLY&&t!==N.ToolState.SELECTED_READ_ONLY&&this.edit(i),this.hover(i)}}}),0)}hover(t,e){super.hover(t),e&&this.handleOpeningHover(e),this.state.tempHoverPreviewEntityId&&this.state.tempHoverPreviewEntityId!==t&&this.deleteTemporaryPreview();const i=this.state.toolState===N.ToolState.ADDING||this.state.toolState===N.ToolState.WAIT_FOR_ADD,s=this.state.addType===q.DOORS||this.state.addType===q.OPENINGS;if(i&&s){const t=this.getCurrentRoomBoundHit(),e=this.getCursorOrigin(),i=this.addOpeningOrDoor(t,e);i&&(this.state.tempHoverPreviewEntityId=i)}}handleOpeningHover(t){const e=t=>{t.hoverState.active=!1,t.hoverState.off()};if(t instanceof $t)e(t.startHandle),e(t.endHandle);else if(t instanceof Yt){e(t instanceof Zt?t.parentOpeningView.endHandle:t.parentOpeningView.startHandle)}}placeOnDrag(t,e){if(t instanceof rt._t&&t.buttons!==Kt.r.PRIMARY||t instanceof rt.u4&&t.pointer.buttons!==Kt.r.PRIMARY)return;this.updateOpeningEditState(e);const i=e.roomBoundsId;this.state.selected!==i&&this.select(i),this.place(i),this.state.dragging=!0}onDragEnd(t){this.state.dragging=!1}updateOpeningEditState(t){this.state.openingEditState=t instanceof Zt?Y.START:t instanceof Xt?Y.END:Y.MOVE}dropOnPointerUp(t){if(t.down)this.updateCursor(!0);else{!1!==this.state.pendingValid?this.tryCommit():this.discard()}}addOpeningOrDoor(t,e){if(!(t instanceof F.c))return null;const i=t.getProjection(e)/t.length,s=Math.min(.9*t.length,.9144),a=s/t.length*.5,o=(0,Jt.uZ)(i,a,1-a);return this.data.addWallOpening({wallId:t.id,type:this.state.addType===q.DOORS?X.u.DOOR:X.u.OPENING,relativePos:o,width:s})}deleteTemporaryPreview(){this.state.tempHoverPreviewEntityId&&this.data.tryGetEntity(this.state.tempHoverPreviewEntityId)&&(this.data.deleteEntity(this.state.tempHoverPreviewEntityId),this.state.tempHoverPreviewEntityId=null)}addFirstFloatingPoint(t){if(!this.floorsViewData.currentFloorId)throw new Error("Expected a floor when adding point.");const{wall:e,toId:i}=this.data.addFloatingEdge(this.state.wallType,t,Object.assign({},t),this.data.getLastWallWidth(this.state.wallType),this.floorsViewData.currentFloorId);this.add(e),this.state.toId=i}}var Te=i(26158),Me=i(69739),xe=i(56159),Le=i(46391),Pe=i(84784);class Fe extends Ht{}class ke{constructor(t,e,i,s,a,o,n,r,d,l,c,h){this.scene=t,this.input=e,this.inputManager=i,this.editor=s,this.data=a,this.floorsViewData=o,this.roomLabelMaker=n,this.wallLabelMaker=r,this.cameraData=d,this.locale=l,this.engine=c,this.settingsData=h,this.currentFloorId="",this.cameraDirty=!1,this.rootObjects={},this.viewMap=new Map,this.nodeMap=new Map,this.roomMap=new Map,this.openingMap=new Map,this.visibleWallLabels=new Set,this.hideCurrentFloorViews=()=>{if(this.currentFloorId){const t=this.rootObjects[this.currentFloorId];for(const e of t.children)e instanceof bt&&this.unregisterViewToInput(e);this.scene.remove(t)}},this.showCurrentFloorViews=()=>{var t;const e=(null===(t=this.floorsViewData.singleFloor)||void 0===t?void 0:t.id)||this.floorsViewData.currentFloorId;if(e){const t=this.rootObjects[e];this.scene.add(t);for(const e of t.children)e instanceof bt&&this.registerViewToInput(e);this.currentFloorId=e}},this.updateOpeningView=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3,a=new B.Vector3,o=new B.Vector3;return n=>{var r;const d=this.data.getWall(n.wallId),l=(null===(r=this.floorsViewData.floors.getFloor(d.floorId))||void 0===r?void 0:r.bottom)||0;o.set(0,l,0),d.getBiasAdjustmentVec(a),d.from.getVec3(i).add(a).add(o),d.to.getVec3(s).add(a).add(o),e.subVectors(s,i).normalize(),t.copy(i),t.lerp(s,n.relativePos),i.copy(t).addScaledVector(e,-.5*n.width),s.copy(t).addScaledVector(e,.5*n.width);const c=this.openingMap.get(n.id);if(!c)throw new Error("Unable to find view for opening while updating");c.onEdgePositionChanged(i,s,d.width,n.type)}})(),this.onMove=({target:t})=>{t&&this.toggleLabelChildrenForView(t,!0)},this.hideAllWallLabels=()=>{if(this.visibleWallLabels.size>0){for(const t of this.visibleWallLabels)t.setLabelVisible(!1);this.visibleWallLabels.clear()}},this.onMoveEnd=({target:t})=>{t&&this.toggleLabelChildrenForView(t,!1)},this.onSelect=({target:t,previous:e})=>{this.hideAllWallLabels(),e&&this.toggleViewWallLabel(e,!1),t&&this.toggleViewWallLabel(t,!0)},this.onHover=({target:t,previous:e})=>{e&&this.toggleViewWallLabel(e,!1),t&&this.toggleViewWallLabel(t,!0)},this.floorsViewData.floors.iterate((t=>{this.rootObjects[t.id]=new B.Object3D})),this.bindings=[this.data.onWallsChanged({onRemoved:t=>this.removeViewForWall(t),onUpdated:t=>this.updateWallView(t),onAdded:t=>this.makeWallView(t)}),this.data.onNodesChanged({onRemoved:t=>this.removeViewForNode(t),onUpdated:t=>this.updateNodeView(t),onAdded:t=>this.makeNodeView(t)}),this.data.onRoomsChanged({onRemoved:t=>this.removeViewForRoom(t),onUpdated:t=>this.updateRoomView(t),onAdded:t=>this.makeRoomView(t)}),this.data.onOpeningsChanged({onRemoved:t=>this.removeViewForOpening(t),onUpdated:t=>this.updateOpeningView(t),onAdded:t=>this.makeOpeningView(t)}),this.editor.subscribe(N.Events.Move,this.onMove),this.editor.subscribe(N.Events.EditConfirm,this.onMoveEnd),this.editor.subscribe(N.Events.SelectChange,this.onSelect),this.editor.subscribe(N.Events.HoverChange,this.onHover),this.engine.subscribe(xe.S,this.hideCurrentFloorViews),this.engine.subscribe(Me.P,this.showCurrentFloorViews),d.onChanged((()=>this.cameraDirty=!0)),this.settingsData.onPropertyChanged(Te.F.UnitType,(t=>{for(const t of this.data.rooms.values())this.updateRoomView(t);for(const t of this.data.walls.values())this.updateWallView(t)}))],this.bindings.forEach((t=>t.cancel()))}init(){}render(t){const e=this.cameraData.pose.pitchFactor();for(const i of[this.viewMap,this.nodeMap,this.roomMap,this.openingMap])for(const s of i.values())s.tickAnimations(t),s.setPitchFactor(e)}dispose(){}beforeRender(){this.cameraDirty&&(this.cameraDirty=!1,this.updateLabels())}activate(t,e={readonly:!1}){if(!e.readonly)for(const[t,e]of this.data.nodes)this.makeNodeView(e);for(const[t,e]of this.data.walls)this.makeWallView(e);for(const[t,e]of this.data.rooms)this.makeRoomView(e);for(const[t,e]of this.data.wallOpenings)this.makeOpeningView(e);this.bindings.forEach((t=>t.renew())),this.showCurrentFloorViews()}deactivate(){this.bindings.forEach((t=>t.cancel()));for(const t in this.rootObjects){const e=this.rootObjects[t];this.scene.remove(e);for(const t of e.children.slice())t instanceof bt&&(t.dispose(),this.unregisterViewToInput(t)),e.remove(t)}}getRoomBoundView(t){const e=this.viewMap.get(t)||this.nodeMap.get(t);if(e)return e;throw new Error(`View for id: ${t} doesn't exist`)}updateLabels(){for(const t of this.roomMap.values())t.updateLabelBillboard()}registerViewToInput(...t){var e;for(const i of t)(null===(e=i.parent)||void 0===e?void 0:e.parent)&&(this.input.registerMesh(i,!1),this.inputManager.addEditableEntity(i,i.roomBoundsId))}unregisterViewToInput(...t){for(const e of t)this.input.unregisterMesh(e),this.inputManager.removeEditableEntity(e.roomBoundsId)}makeNodeView(t){var e;const i=new Fe(t.id,this.cameraData),s=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0;i.updatePosition(new B.Vector3(t.x,s,t.z)),this.nodeMap.set(t.id,i),this.rootObjects[t.floorId].add(i),this.registerViewToInput(i)}updateNodeView(t){var e;const i=this.nodeMap.get(t.id);if(i){const s=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0;i.updatePosition(new B.Vector3(t.x,s,t.z))}}removeViewForNode(t){const e=this.nodeMap.get(t.id);e&&(this.rootObjects[t.floorId].remove(e),this.nodeMap.delete(t.id),e.dispose(),this.unregisterViewToInput(e))}makeWallView(t){const e=new me(this.cameraData,t.width,t.from.getVec3(),t.to.getVec3(),this.wallLabelMaker,this.getUnits()),i=new Oe(t.id,this.cameraData,e);this.viewMap.set(t.id,i),this.rootObjects[t.floorId].add(i),e.addTo(this.rootObjects[t.floorId]),this.updateWallView(t),e.update(),this.registerViewToInput(i)}updateWallView(t){const e=this.viewMap.get(t.id);e&&e.onEdgePositionChanged(this.data,this.floorsViewData,this.getUnits())}removeViewForWall(t){const e=this.viewMap.get(t.id);e&&(this.rootObjects[t.floorId].remove(e),e.lineLabel.removeFrom(this.rootObjects[t.floorId]),this.viewMap.delete(t.id),this.visibleWallLabels.delete(e),e.dispose(),this.unregisterViewToInput(e))}makeRoomView(t){var e;const i=this.rootObjects[t.floorId];this.roomMap.has(t.id)&&this.removeViewForRoom(t);const s=this.roomLabelMaker.makeLabel(),a=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0,o=new be(t,s,a,this.cameraData,this.wallLabelMaker,this.getUnits());i.add(o),this.roomMap.set(t.id,o),this.registerViewToInput(o),this.updateRoomView(t)}updateRoomView(t){var e;const i=this.roomMap.get(t.id);if(!i)throw new Error("Unable to find view for room while updating.");const s=(null===(e=this.floorsViewData.floors.getFloor(t.floorId))||void 0===e?void 0:e.bottom)||0;i.updateGeo(t,s,this.getUnits()),i.updateLabelBillboard();const a=this.getUnits();let o=`${t.getArea(a)} ${a===Le.M.IMPERIAL?"sq ft":"sq m"}`;o+="\n"+t.getMeasurementText(a),i.updateText((0,Pe.LN)(t.id,this.locale,this.data),o)}removeViewForRoom(t){const e=this.roomMap.get(t.id);if(!e)throw new Error("Unable to find view for room while deleting.");this.rootObjects[t.floorId].remove(e),this.roomMap.delete(t.id),e.dispose(),this.input.unregisterMesh(e),this.inputManager.removeEditableEntity(t.id)}makeOpeningView(t){const e=this.data.getWall(t.wallId),i=new $t(t.id,e.floorId,this.cameraData);this.rootObjects[e.floorId].add(i,i.stencilPrepass,i.startHandle,i.endHandle),this.openingMap.set(t.id,i),this.registerViewToInput(i,i.startHandle,i.endHandle),this.updateOpeningView(t)}removeViewForOpening(t){const e=this.openingMap.get(t.id);if(!e)throw new Error("Unable to find view for opening while deleting.");this.rootObjects[e.floorId].remove(e,e.stencilPrepass,e.startHandle,e.endHandle),this.openingMap.delete(t.id),e.dispose(),this.unregisterViewToInput(e,e.startHandle,e.endHandle)}toggleLabelChildrenForView(t,e){if(this.viewMap.has(t)){const i=this.data.getWall(t);this.toggleViewWallLabel(i.to.id,e),this.toggleViewWallLabel(i.from.id,e)}else this.toggleViewWallLabel(t,e)}toggleViewWallLabel(t,e){const i=this.viewMap.get(t)||this.roomMap.get(t);if(i){const t=i.hoverState.active,s=i.selectState.active||i.highlightState.active,a=t||s||e;i.setLabelVisible(a),i instanceof Oe&&(a?this.visibleWallLabels.add(i):this.visibleWallLabels.delete(i))}if(this.nodeMap.has(t)){const i=this.data.getNode(t);if(i){const t=this.data.getWallsForNode(i);for(const i of t)this.toggleViewWallLabel(i.id,e)}}}getUnits(){return this.settingsData.tryGetProperty(Te.F.UnitType,Le.M.IMPERIAL)}}var Be=i(18544),We=i(85893),_e=i(67294),Ue=i(33558),He=i(38399),ze=i(1358);function je(t,e,i){const[s,a]=(0,_e.useState)(null===t?i:t[e]);return(0,_e.useEffect)((()=>{if(null===t)return;const i=t.onPropertyChanged(e,(t=>{a(t)}));return()=>i.cancel()}),[t,e,i]),s}const Ge=(0,i(45755).u)(Be.e);function $e(){const t=Ge();return(null==t?void 0:t.editorState)||null}function qe(){const t=(0,ze.S)(),e=je($e(),"selected",null);return e&&t?t.getEntity(e):null}var Ye=i(38490),Ze=i(38039),Xe=i(87281),Ke=i(66102),Qe=i(56064);function Je({room:t}){const e=(0,Ke.b)(),i=(0,Qe.O)(),s=e.t(He.Z.SHOWCASE.ROOMS.ROOM_INFORMATION),a=e.t(He.Z.SHOWCASE.ROOMS.ROOM_AREA),o=e.t(He.Z.SHOWCASE.ROOMS.ROOM_DIMENSIONS),n=e.t(He.Z.SHOWCASE.ROOMS.ROOM_PERIMETER),r=i===Le.M.IMPERIAL?"sq ft":"sq m",d=e.t(He.Z.SHOWCASE.ROOMS.QUANTITY_IN_UNITS,{units:r,quantity:t.getArea(i)}),l=t.getMeasurementText(i)||"n/a",c=i===Le.M.IMPERIAL?"ft":"m",h=e.t(He.Z.SHOWCASE.ROOMS.QUANTITY_IN_UNITS,{units:c,quantity:t.getPerimeter(i)});return(0,We.jsxs)("div",Object.assign({className:"room-size-info"},{children:[(0,We.jsx)("div",Object.assign({className:"room-info-title"},{children:s})),(0,We.jsxs)("div",Object.assign({className:"area-info"},{children:[(0,We.jsxs)("div",Object.assign({className:"area-info-detail"},{children:[(0,We.jsx)("div",Object.assign({className:"p5"},{children:a})),(0,We.jsx)("div",Object.assign({className:"p3"},{children:d}))]})),(0,We.jsxs)("div",Object.assign({className:"area-info-detail"},{children:[(0,We.jsx)("div",Object.assign({className:"p5"},{children:o})),(0,We.jsx)("div",Object.assign({className:"p3"},{children:l}))]})),(0,We.jsxs)("div",Object.assign({className:"area-info-detail"},{children:[(0,We.jsx)("div",Object.assign({className:"p5"},{children:n})),(0,We.jsx)("div",Object.assign({className:"p3"},{children:h}))]}))]}))]}))}function ti({room:t}){const e=(0,ze.S)(),i=(0,Ke.b)(),s=(0,Pe.LN)(t.id,i,e);return(0,We.jsx)("div",Object.assign({className:"room-title"},{children:s}))}var ei=i(65428);function ii(){const{locale:t,commandBinder:e}=(0,_e.useContext)(Ue.I),i=(0,ei.A)(),s=function(){const t=qe();return t&&t instanceof K.J?t:null}(),a=i&&(i===d.w1.SEARCH||i===d.w1.LAYERS);async function o(){a?(await e.issueCommand(new h.cR),await e.issueCommand(new h.qy(!1))):s&&e.issueCommand(new L.pZ(s.id))}const n=t.t(a?He.Z.SHOWCASE.ROOMS.BACK:He.Z.SHOWCASE.ROOMS.CLOSE),r=a?"back":"close";return(0,We.jsxs)(Xe.J,Object.assign({open:!!s,onClose:o},{children:[(0,We.jsx)("div",Object.assign({className:"detail-panel-header"},{children:(0,We.jsx)(Ye.P,{label:n,className:"return-btn",icon:r,size:Ze.qE.SMALL,onClose:o})})),(0,We.jsxs)("div",Object.assign({className:"room-view"},{children:[s&&(0,We.jsx)(ti,{room:s}),s&&(0,We.jsx)(Je,{room:s})]}))]}))}class si{constructor(){}renderPanel(){return(0,We.jsx)(ii,{})}}var ai=i(40964);class oi{constructor(t,e,i){this.engine=t,this.toolsData=e,this.viewData=i,this.bindings=[],this.selectionChanged=async t=>{if(this.toolsData.activeToolName===d.w1.ROOM_BOUNDS)return;const e=this.viewData.getSelectedRoom(t);this.toolsData.activeToolName===d.w1.ROOM_VIEW!==!!e&&(await this.engine.commandBinder.issueCommand(new h.tT(d.w1.ROOM_VIEW,!!e)),this.engine.broadcast(e?new ai.ro:new ai.A))},this.bindings.push(this.viewData.editorState.onPropertyChanged("selected",this.selectionChanged))}async activate(){}async deactivate(){}async dispose(){this.bindings.forEach((t=>t.cancel()))}}var ni=i(38042),ri=i(79727),di=i(33324),li=i(9037);const ci=.5;class hi{constructor(t){this.axis=new ui(t),this.orthoAxis=new ui(t)}showAt(t,e){this.axis.setPosition(t),this.axis.show(),e?(this.orthoAxis.setPosition(e),this.orthoAxis.show()):this.orthoAxis.hide()}hide(){this.axis.hide(),this.orthoAxis.hide()}dispose(){this.axis.dispose(),this.orthoAxis.dispose()}}class ui{constructor(t){this.scene=t,this.setPosition=(()=>{const t=new B.Vector3,e=new B.Vector3,i=new B.Vector3,s=new B.Vector3;return a=>{i.subVectors(a.end,a.start).normalize(),s.copy(i).applyAxisAngle(P.fU.UP,Math.PI/2),t.copy(a.start).addScaledVector(i,-1e3),e.copy(a.start).addScaledVector(i,1e3),this.alignedAxis.updateEndpoints(t,e),t.copy(a.start).addScaledVector(s,ci),e.copy(a.start).addScaledVector(i,ci).addScaledVector(s,ci),this.angleIndictorLine1.updateEndpoints(t,e),t.copy(a.start).addScaledVector(s,-1e3),e.copy(a.start).addScaledVector(s,1e3),this.orthoAxis.updateEndpoints(t,e),t.copy(a.start).addScaledVector(i,ci),e.copy(a.start).addScaledVector(s,ci).addScaledVector(i,ci),this.angleIndictorLine2.updateEndpoints(t,e)}})();const e={dashed:!1,dashSize:1,gapSize:1,lineWidth:1,color:ft.I.MP_BRAND,dashUnits:De.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:B.AlwaysDepth,opacity:1},i={dashed:!0,dashSize:5,gapSize:2,lineWidth:1,color:ft.I.MP_BRAND,dashUnits:De.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:B.AlwaysDepth,opacity:1};this.alignedAxis=new Ce(new B.Vector3,new B.Vector3,i),this.orthoAxis=new Ce(new B.Vector3,new B.Vector3,i),this.angleIndictorLine1=new Ce(new B.Vector3,new B.Vector3,e),this.angleIndictorLine2=new Ce(new B.Vector3,new B.Vector3,e),this.scene.add(this.alignedAxis),this.scene.add(this.orthoAxis),this.scene.add(this.angleIndictorLine1),this.scene.add(this.angleIndictorLine2),this.hide()}show(){this.alignedAxis.visible=!0,this.orthoAxis.visible=!0,this.angleIndictorLine1.visible=!0,this.angleIndictorLine2.visible=!0}hide(){this.alignedAxis.visible=!1,this.orthoAxis.visible=!1,this.angleIndictorLine1.visible=!1,this.angleIndictorLine2.visible=!1}dispose(){this.scene.remove(this.alignedAxis),this.scene.remove(this.orthoAxis),this.scene.remove(this.angleIndictorLine1),this.scene.remove(this.angleIndictorLine2)}}var mi=i(79307),pi=i(39642),gi=i(95512),vi=i(20217),fi=i(61282),wi=i(61864);var yi,Si=i(42147),Ei=i(67971),bi=i(23254),Di=i(54244),Ii=i(64918),Ci=i(55450),Ai=i(18596),Oi=i(5332),Ri=i(23037);!function(t){t[t.INACTIVE=0]="INACTIVE",t[t.ACTIVE_EDIT=1]="ACTIVE_EDIT",t[t.ACTIVE_READ_ONLY=2]="ACTIVE_READ_ONLY"}(yi||(yi={}));const Vi=[d.w1.ROOM_BOUNDS,d.w1.SEARCH,d.w1.LAYERS,d.w1.ROOM_VIEW];class Ni extends a.Y{constructor(){super(...arguments),this.name="room_bound",this.state=yi.INACTIVE,this.disabledAssets={[w.U]:!1,[f.s]:!1,[m.re]:!1,[v.Mp]:!1,[Ri.Nj]:!1},this.disabledAssetsReadOnly={[Ri.Nj]:!1},this.activate=async()=>{const t=yi.ACTIVE_READ_ONLY;await this.tryDeactivate(t),this.state=t,this.disableUnrelatedAssets.toggle(!0),this.floorsViewData.onlyShowActiveFloor.value=!0,await(0,r.E)(this.cameraData,this.viewmodeData),await this.commandBinder.issueCommand(new S._i(S.BD.DOLLHOUSE,Ii.n.FadeToBlack,this.getStartCameraPose(),Ci.DEFAULT_TRANSITION_TIME/2)),await this.commandBinder.issueCommand(new vi.C({phiUpperLimitDegrees:90,phiLowerLimitDegrees:fi.bp*te.MN,noTransition:!0})),await this.commandBinder.issueCommand(new Si.Nb),await this.commandBinder.issueCommand(new gi.y(!0)),await(0,r.E)(this.cameraData,this.viewmodeData),await this.commandBinder.issueCommand(new E.M),await this.commandBinder.issueCommand(new di.tR),await this.commandBinder.issueCommand(new di.TS),await this.commandBinder.issueCommand(new vi.h),this.updateCursor(),this.editor.start(),this.renderer.activate(this.engine,{readonly:!1}),this.inputManager.activate(!1)},this.activateReadOnly=async()=>{const t=yi.ACTIVE_READ_ONLY;this.state!==t&&(await this.tryDeactivate(t),this.state=t,this.disableUnrelatedAssetsReadOnly.toggle(!0),this.editor.startReadOnly(),this.renderer.activate(this.engine,{readonly:!0}),this.inputManager.activate(!0),await(0,r.E)(this.cameraData,this.viewmodeData),this.updateCursor())},this.deactivateReadOnly=async(t=yi.INACTIVE)=>{this.state===yi.ACTIVE_READ_ONLY&&(t===yi.INACTIVE&&this.editor.exit(),this.renderer.deactivate(),this.inputManager.deactivate(),this.disableUnrelatedAssetsReadOnly.toggle(!1),this.state=t)},this.deactivate=async(t=yi.INACTIVE)=>{t===yi.INACTIVE&&this.editor.exit(),this.renderer.deactivate(),this.inputManager.deactivate(),this.disableUnrelatedAssets.toggle(!1),this.snappingAxesRenderer.hide(),await this.commandBinder.issueCommand(new E.I),await this.commandBinder.issueCommand(new vi.C({noTransition:!0})),await this.commandBinder.issueCommand(new Si.qK),await this.commandBinder.issueCommand(new di.LW),await this.commandBinder.issueCommand(new gi.y(!1)),await this.commandBinder.issueCommand(new di.Md),await this.commandBinder.issueCommand(new p.u(g.C.DEFAULT)),this.floorsViewData.onlyShowActiveFloor.value=!1,this.state=yi.INACTIVE},this.tryDeactivate=async t=>{this.state===yi.ACTIVE_EDIT?await this.deactivate(t):this.state===yi.ACTIVE_READ_ONLY&&await this.deactivateReadOnly(t)},this.select=async t=>{t&&(await this.updateShowcaseVisibility(),this.state!==yi.INACTIVE&&this.editor.select(t))},this.unselect=async t=>{t&&(await this.updateShowcaseVisibility(),this.state!==yi.INACTIVE&&this.editor.deselect())},this.undo=async()=>{await this.ensureValidViewMode();const t=this.editor.state.selected;!(this.editor.state.toolState===N.ToolState.SELECTED||this.editor.state.toolState===N.ToolState.EDITING)&&this.editor.discard(),this.data.undo();!(t&&this.data.tryGetEntity(t))&&this.editor.discard()},this.editWall=t=>{const e=this.editor.state;e.toolState===N.ToolState.EDITING&&e.currentId&&this.editor.tryCommit(),this.editor.edit(t)},this.finishEdit=()=>{this.editor.tryCommit()},this.cancelEdit=async()=>{await this.ensureValidViewMode(),this.editor.discard()},this.exitEdit=()=>{this.editor.discard()},this.deleteEntity=async t=>{await this.ensureValidViewMode();const e=this.editor.state,i=t.id||e.currentId;i&&(this.editor.discard(),this.data.deleteEntity(i),this.data.finalizeHistory())},this.addEntity=async({addState:t,wallType:e})=>{await this.ensureValidViewMode();const i=this.editor.state.toolState;i!==N.ToolState.IDLE&&i!==N.ToolState.SELECTED&&this.editor.discard(),this.editor.state.addType=t,void 0!==e&&(this.editor.state.wallType=e),this.editor.waitForAdd()},this.updateCursor=()=>{this.commandBinder.issueCommand(new p.u(this.editor.state.cursor))}}async init(t,e){this.commandBinder=e.commandBinder,this.engine=e;const[i,a,r,d,c,h,m,p,g,v,f,w,S]=await Promise.all([e.getModuleBySymbol(s.PZ),e.getModuleBySymbol(s.fQ),e.market.waitForData(M.Z),e.getModuleBySymbol(s.Aj),e.market.waitForData(o.e),e.market.waitForData(ri.c),e.market.waitForData(li.M),e.getModuleBySymbol(s.e9),e.market.waitForData(bi.O),e.market.waitForData(Di.pu),e.market.waitForData(l.t),e.market.waitForData(Oi.W),e.getModuleBySymbol(s.V6)]);this.data=r,this.floorsViewData=h,this.cameraData=m,this.viewmodeData=g,this.applicationData=v,this.toolsData=f,this.settingsData=c,this.canvasData=w,this.analytics=S,this.disableUnrelatedAssets=new n.u(c,this.disabledAssets),this.disableUnrelatedAssetsReadOnly=new n.u(c,this.disabledAssetsReadOnly),this.snappingAxesRenderer=new hi(d.getScene());const E=new B.Vector3,b=()=>{var t;const e=i.getCurrentPointerRay();return E.set(0,0,0),h.currentFloor&&e.intersectPlane(null===(t=h.currentFloor)||void 0===t?void 0:t.groundPlane,E),E};this.editor=new Ne(b,i,a,e.msgBus,r,this.floorsViewData,m.pose,e.commandBinder,this.canvasData,t.rootNode);const D=c.tryGetProperty(u.gx.RoomBounds,!1);this.viewData=new Be.e(this.data,this.editor.state,D),this.addToolPanel(),this.inputManager=new et(this.editor,b,r,m,this.snappingAxesRenderer,i.keyboardState,this.analytics);const I=new mi.$(c.tryGetProperty(pi.Q,!1),{assetBasePath:c.tryGetProperty("assetBasePath",""),lang:p.languageCode});I.setRenderLayer(e.claimRenderLayer("labels"));const C=new Ei.uc({assetBasePath:c.tryGetProperty("assetBasePath",""),color:"black",background:!0,backgroundColor:"#ffffff",backgroundColliderType:Ti,disableDepth:!0});this.renderer=new ke(d.getScene(),i,this.inputManager,this.editor,this.data,this.floorsViewData,I,C,m,p,e,c),e.addComponent(this,this.renderer),this.renderer.deactivate(),this.bindings.push(e.commandBinder.addBinding(L.Yx,this.activate),e.commandBinder.addBinding(L.Rc,(async()=>this.deactivate())),e.commandBinder.addBinding(L.et,(async t=>this.select(t.id))),e.commandBinder.addBinding(L.pZ,(async t=>this.unselect(t.id))),e.commandBinder.addBinding(L.Os,(async t=>this.toggleVisibilityForViewer(t.visible))),this.editor.state.onPropertyChanged("cursor",this.updateCursor),g.currentModeObservable.onChanged((()=>this.updateShowcaseVisibility())),this.toolsData.onPropertyChanged("activeToolName",(()=>this.updateShowcaseVisibility())),e.subscribe(it.pB,(t=>{this.updateShowcaseVisibility(),t.application===Di.Mx.SHOWCASE&&this.addToolPanel()}))),t.readonly||this.bindings.push(e.commandBinder.addBinding(L.pd,(async t=>this.deleteEntity(t))),e.commandBinder.addBinding(L.o3,(async()=>this.undo())),e.commandBinder.addBinding(L.vQ,this.addEntity),e.commandBinder.addBinding(L.mB,(async t=>this.editWall(t.id))),e.commandBinder.addBinding(L.DE,(async()=>this.finishEdit())),e.commandBinder.addBinding(L._j,this.cancelEdit),e.commandBinder.addBinding(L.bw,(async()=>this.exitEdit())),e.commandBinder.addBinding(L.Km,(async t=>this.editRoomName(t.id,t.name))),e.commandBinder.addBinding(L.c8,(async t=>this.editRoomTypes(t.id,t.roomTypeIds))),c.onPropertyChanged(u.gx.RoomBounds,(()=>this.updateShowcaseAvailability())),c.onPropertyChanged(y.dF,(()=>this.updateShowcaseAvailability()))),e.market.register(this,Be.e,this.viewData),this.updateShowcaseAvailability(),async function(t){const e=await t.market.waitForData(o.e),i=await t.getModuleBySymbol(wi.Ak),s=(t,s,a)=>{i.registerSetting("Room Bounds"+t,t+s+"Inner",a.innerColor,!0),e.onPropertyChanged(t+s+"Inner",(t=>a.innerColor=t)),i.registerSetting("Room Bounds"+t,t+s+"Outer",a.outerColor,!0),e.onPropertyChanged(t+s+"Outer",(t=>a.outerColor=t)),i.registerSetting("Room Bounds"+t,t+s+"Opacity",a.opacity,!0),e.onPropertyChanged(t+s+"Opacity",(t=>a.opacity=t))},a=(t,e)=>{s(t,"Base",e.baseState),s(t,"Hover",e.hoverState),s(t,"Select",e.selectState),s(t,"Dim",e.dimState)};a("Node",_t),a("Edge",Ae),a("Room",Ee),i.registerButton("Room Bounds Export","Export colors",(()=>{const t={Node:_t,Edge:Ae,Room:Ee},e=JSON.stringify(t);navigator.clipboard.writeText(e)})),i.registerButton("Room Bounds Export","Import colors",(async()=>{const t=(t,e,i)=>{s(t.baseState,e.baseState,i,"Base"),s(t.hoverState,e.hoverState,i,"Hover"),s(t.selectState,e.selectState,i,"Select"),s(t.dimState,e.dimState,i,"Dim")},s=(t,e,s,a)=>{t.innerColor=new B.Color(e.innerColor),t.outerColor=new B.Color(e.outerColor),t.opacity=e.opacity;const o=s+a;i.updateSetting(o+"Inner",t.innerColor),i.updateSetting(o+"Outer",t.outerColor),i.updateSetting(o+"Opacity",t.opacity)},a=await navigator.clipboard.readText(),o=JSON.parse(a);o&&(t(_t,o.Node,"Node"),t(Ae,o.Edge,"Edge"),t(Ee,o.Room,"Room")),e.setDirty(!0),e.commit()}))}(e)}dispose(t){super.dispose(t),t.market.unregister(this,Be.e)}toggleVisibilityForViewer(t){this.viewData.visibleInShowcase=t,this.viewData.commit(),this.updateShowcaseVisibility()}async updateShowcaseAvailability(){const t=this.settingsData.tryGetProperty(u.gx.RoomBounds,!1),e=this.settingsData.tryGetProperty(y.dF,!1),i=t&&e;this.settingsData.setProperty(x.hW,i),i&&!this.viewData.visibleInShowcase?this.toggleVisibilityForViewer(!0):this.updateShowcaseVisibility()}async updateShowcaseVisibility(){const{application:t}=this.applicationData,e=t===Di.Mx.SHOWCASE,i=t===Di.Mx.WORKSHOP,s=this.settingsData.tryGetProperty(x.hW,!1),a=e&&this.viewData.visibleInShowcase&&s||i,o=null==this.toolsData.activeToolName||Vi.includes(this.toolsData.activeToolName),n=this.viewmodeData.isFloorplan(),r=this.data.rooms.size>0;a&&n&&o&&r?await this.activateReadOnly():await this.deactivateReadOnly()}async addToolPanel(){if(!this.toolsData.getTool(d.w1.ROOM_VIEW)){const t=new oi(this.engine,this.toolsData,this.viewData),e=new c.U({id:d.w1.ROOM_VIEW,panel:!0,enabled:!0,dimmed:!1,manager:t,ui:new si,analytic:"rooms"});await this.engine.commandBinder.issueCommand(new h.MV([e]))}}editRoomName(t,e){this.data.getRoom(t).name!==e&&(this.data.setRoomDetails(t,e),this.data.finalizeHistory())}editRoomTypes(t,e){const i=this.data.getRoom(t).classifications.map((t=>t.id));(0,ni.E8)(e,i)||(this.data.setRoomDetails(t,void 0,e),this.data.finalizeHistory())}getStartCameraPose(){const t=this.floorsViewData.currentFloor||this.floorsViewData.getFloor(this.floorsViewData.bottomFloorId),e=t.bottom,i=t.boundingBox.getCenter(new B.Vector3);i.y=e;const s=t.boundingBox.max.clone();s.y=e;const a=i.distanceTo(s)/Math.tan(Ai.oR.fov/2*te.Ue),o=P.Hk.DOWNWARD.clone().multiply((new B.Quaternion).setFromAxisAngle(P.fU.RIGHT,45*te.Ue)),n=P.fU.FORWARD.clone().applyQuaternion(o).multiplyScalar(-1*a);return{position:i.clone().add(n),rotation:o}}async ensureValidViewMode(){this.cameraData.pose.autoOrthoApplied&&await this.engine.commandBinder.issueCommand(new vi.h)}}class Ti extends B.Mesh{raycast(t,e){}}},20241:(t,e,i)=>{"use strict";i.d(e,{d:()=>s});class s{constructor(t){this.tags=[],t&&Object.assign(this,t)}}},94046:(t,e,i)=>{"use strict";i.d(e,{i:()=>a});var s=i(81396);class a extends s.Mesh{}},6282:(t,e,i)=>{"use strict";async function s(t,e){if(await t.transition.promise,!e.canStartTransition()){const t=new Promise((t=>{const i=e.onChanged((()=>{e.canStartTransition()&&(i.cancel(),t())}))}));await t}}i.d(e,{E:()=>s})},44724:t=>{t.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform float opacity;uniform vec3 color;uniform sampler2D bg;varying vec2 vUv;void main(){vec4 bgColor=texture2D(bg,vUv);gl_FragColor=vec4(bgColor.rgb,bgColor.a*opacity);}"},52059:t=>{t.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform vec3 diffuse;uniform float opacity;uniform sampler2D mask;\n#ifdef USE_DASH\nuniform float dashSize;uniform float gapSize;\n#endif\nvarying float vLineDistance;\n#include <common>\nvarying vec2 vUv;void main(){\n#ifdef USE_DASH\nif(vUv.y<-1.||vUv.y>1.)discard;if(mod(vLineDistance,dashSize+gapSize)>dashSize)discard;\n#endif\n#ifdef USE_MASK\nvec2 modUv=vec2(vUv);modUv*=2.;vec4 texelColor=texture2D(mask,modUv);gl_FragColor=vec4(texelColor.rgb,min(texelColor.a,opacity));\n#else\ngl_FragColor=vec4(diffuse,opacity);\n#endif\n}"},7188:t=>{t.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;\n#include <common>\nuniform float linewidth;uniform vec2 resolution;attribute vec3 instanceStart;attribute vec3 instanceEnd;attribute vec3 instanceColorStart;attribute vec3 instanceColorEnd;varying vec2 vUv;\n#ifdef USE_DASH\nuniform float dashScale;attribute float instanceDistanceStart;attribute float instanceDistanceEnd;varying float vLineDistance;\n#endif\nvoid trimSegment(const in vec4 start,inout vec4 end){float a=projectionMatrix[2][2];float b=projectionMatrix[3][2];float nearEstimate=-0.5*b/a;float alpha=(nearEstimate-start.z)/(end.z-start.z);end.xyz=mix(start.xyz,end.xyz,alpha);}void main(){\n#ifdef USE_COLOR\nvColor.xyz=(position.y<0.5)?instanceColorStart:instanceColorEnd;\n#endif\n#ifdef USE_DASH\nvLineDistance=(position.y<0.5)?dashScale*instanceDistanceStart:dashScale*instanceDistanceEnd;\n#endif\nfloat aspect=resolution.x/resolution.y;vUv=uv;vec4 start=modelViewMatrix*vec4(instanceStart,1.);vec4 end=modelViewMatrix*vec4(instanceEnd,1.);bool perspective=(projectionMatrix[2][3]==-1.);if(perspective){if(start.z<0.&&end.z>=0.){trimSegment(start,end);}else if(end.z<0.&&start.z>=0.){trimSegment(end,start);}}vec4 clipStart=projectionMatrix*start;vec4 clipEnd=projectionMatrix*end;vec2 ndcStart=clipStart.xy/clipStart.w;vec2 ndcEnd=clipEnd.xy/clipEnd.w;vec2 dir=ndcEnd-ndcStart;dir.x*=aspect;dir=normalize(dir);vec2 offset=vec2(dir.y,-dir.x);dir.x/=aspect;offset.x/=aspect;if(position.x<0.)offset*=-1.;offset*=linewidth;offset/=resolution.y;vec4 clip=(position.y<0.5)?clipStart:clipEnd;\n#ifdef USE_MASK\noffset*=(clipEnd.w+clipStart.w)*0.5;\n#else\noffset*=clip.w;\n#endif\nclip.xy+=offset;gl_Position=clip;\n#include <worldpos_vertex>\n}"},56449:t=>{t.exports="precision highp float;uniform vec3 color;uniform float antialiasWidth;uniform float lineWidth;uniform float dashed;uniform float dashSize;uniform float gapSize;uniform float opacity;varying float vDistanceFromAxis;varying float vDistanceAlong;void main(){float halfWidth=lineWidth*0.5;float antialiasing=1.-smoothstep(halfWidth,halfWidth+antialiasWidth,vDistanceFromAxis);float dashOpacity=1.;if(dashed>0.){\n#ifdef WORLDSPACE_DASH\nfloat dashAA=fwidth(vDistanceAlong)*antialiasWidth*0.5;\n#else\nfloat dashAA=antialiasWidth*0.5;\n#endif\nfloat dashT=mod(vDistanceAlong,dashSize+gapSize);dashOpacity=smoothstep(0.,dashAA,dashT)*(1.-smoothstep(dashSize-dashAA,dashSize,dashT));}gl_FragColor=vec4(color,opacity*dashOpacity*antialiasing);}"},75215:t=>{t.exports="precision highp float;uniform vec3 start;uniform vec3 end;uniform float lineWidth;uniform float antialiasWidth;uniform vec2 screenSize;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute float offsetDirection;attribute float t;varying float vDistanceFromAxis;varying float vDistanceAlong;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return pt.xy*screenSize/2.;}vec2 screenToNdc(vec2 pt){return pt*2./screenSize;}void main(){vec4 startNdc=projectionMatrix*modelViewMatrix*vec4(start,1.);vec4 endNdc=projectionMatrix*modelViewMatrix*vec4(end,1.);float z=mix(startNdc.z,endNdc.z,t);float w=mix(startNdc.w,endNdc.w,t);vec2 startScreen=ndcToScreen(startNdc/startNdc.w);vec2 endScreen=ndcToScreen(endNdc/endNdc.w);float halfWidth=lineWidth*0.5+antialiasWidth;vec2 directionScreen=endScreen-startScreen;vec2 widthOffsetScreen=rotate90(normalize(directionScreen))*offsetDirection*halfWidth;vec2 position=startScreen+directionScreen*t+widthOffsetScreen;vDistanceFromAxis=length(widthOffsetScreen);\n#ifdef WORLDSPACE_DASH\nvDistanceAlong=length((end-start)*t);\n#else\nvDistanceAlong=length(directionScreen*t);\n#endif\nvec2 posNdc=screenToNdc(position);gl_Position=vec4(posNdc*w,z,w);}"},4014:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform vec3 outlineColor;uniform vec3 baseColor;uniform float radius;uniform float opacity;uniform float outlinePct;varying vec3 vPosition;void main(){float fragRadius=length(vPosition.xz);float outlineRadius=radius*outlinePct;float smoothAmt=fwidth(fragRadius)*ANTIALIAS_WIDTH;float mixAmt=smoothstep(outlineRadius-smoothAmt,outlineRadius,fragRadius);gl_FragColor=vec4(mix(baseColor,outlineColor,mixAmt),1.);gl_FragColor.a=opacity*(1.-smoothstep(radius-smoothAmt,radius,fragRadius));}"},57216:t=>{t.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vPosition;void main(){vPosition=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},73403:t=>{t.exports="precision highp float;uniform vec3 baseColor;uniform float isDoor;varying vec3 vPosition;void main(){const float lineWidth=0.15;if(isDoor>0.){const float startZ=0.15;const float endZ=startZ+lineWidth;float alpha=(abs(vPosition.z)>startZ&&abs(vPosition.z)<endZ)?1.:0.;gl_FragColor=vec4(baseColor,alpha);}else{float alpha=(abs(vPosition.z)<lineWidth*0.5)?1.:0.;gl_FragColor=vec4(baseColor,alpha);}}"},27706:t=>{t.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vPosition;void main(){vPosition=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},56413:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float selectedWidth;uniform vec3 outlineColor;uniform vec3 color;uniform float opacity;uniform float width;uniform vec3 lineStart;uniform vec3 lineEnd;varying vec3 vWorldPos;float distanceBetween(vec2 l1,vec2 l2,vec2 p){float D=length(l2-l1);float N=abs((l2.x-l1.x)*(l1.y-p.y)-(l1.x-p.x)*(l2.y-l1.y));return N/D;}void main(){float distanceToLine=distanceBetween(lineStart.xz,lineEnd.xz,vWorldPos.xz);float aaWidth=fwidth(distanceToLine)*ANTIALIAS_WIDTH;float lineLerp=smoothstep(selectedWidth-aaWidth,selectedWidth,distanceToLine);float halfWidth=width*0.5;float aaOpacity=smoothstep(halfWidth,halfWidth-aaWidth,distanceToLine);gl_FragColor=mix(vec4(outlineColor,opacity*aaOpacity),vec4(color,opacity*aaOpacity),lineLerp);if(gl_FragColor.a<0.01){discard;}}"},33057:t=>{t.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vWorldPos;void main(){vWorldPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},22999:t=>{var e={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetRoomBounds"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"floors"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"vertices"},arguments:[{kind:"Argument",name:{kind:"Name",value:"includeUsed"},value:{kind:"BooleanValue",value:!0}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"position"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[{kind:"Argument",name:{kind:"Name",value:"includeUsed"},value:{kind:"BooleanValue",value:!0}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vertices"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"centerLineBias"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"thickness"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"openings"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"width"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"relativeCenter"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"height"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"lowerElevation"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}}]}}]}},{kind:"Field",name:{kind:"Name",value:"rooms"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"classifications"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"boundary"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"holes"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"dimensionEstimates"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"area"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"areaIndoor"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"width"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"depth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"units"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetRoomClassifications"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"roomClassifications"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:987}};e.loc.source={body:"query GetRoomBounds($modelId: ID!) {\n  model(id: $modelId) {\n    floors {\n      id\n      layer { id }\n      vertices(includeUsed: true) {\n        id\n        layer { id }\n        position {\n          x\n          y\n        }\n      }\n      edges(includeUsed: true) {\n        id\n        layer { id }\n        type\n        vertices { id }\n        centerLineBias\n        thickness\n        openings {\n          id\n          width\n          relativeCenter\n          type\n          height\n          lowerElevation\n          layer { id }\n        }\n      }\n    }\n    rooms {\n      id\n      layer { id }\n      floor { id }\n      classifications {\n        id\n        confidence\n        label\n      }\n      boundary {\n        edges { id }\n      }\n      holes {\n        edges { id }\n      }\n      dimensionEstimates {\n        area\n        areaIndoor\n        width\n        depth\n        units\n      }\n      label\n    }\n  }\n}\n\nquery GetRoomClassifications {\n   roomClassifications {\n    id\n    label\n  }\n}",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(t,e){if("FragmentSpread"===t.kind)e.add(t.name.value);else if("VariableDefinition"===t.kind){var s=t.type;"NamedType"===s.kind&&e.add(s.name.value)}t.selectionSet&&t.selectionSet.selections.forEach((function(t){i(t,e)})),t.variableDefinitions&&t.variableDefinitions.forEach((function(t){i(t,e)})),t.definitions&&t.definitions.forEach((function(t){i(t,e)}))}var s={};function a(t,e){for(var i=0;i<t.definitions.length;i++){var s=t.definitions[i];if(s.name&&s.name.value==e)return s}}function o(t,e){var i={kind:t.kind,definitions:[a(t,e)]};t.hasOwnProperty("loc")&&(i.loc=t.loc);var o=s[e]||new Set,n=new Set,r=new Set;for(o.forEach((function(t){r.add(t)}));r.size>0;){var d=r;r=new Set,d.forEach((function(t){n.has(t)||(n.add(t),(s[t]||new Set).forEach((function(t){r.add(t)})))}))}return n.forEach((function(e){var s=a(t,e);s&&i.definitions.push(s)})),i}e.definitions.forEach((function(t){if(t.name){var e=new Set;i(t,e),s[t.name.value]=e}})),t.exports=e,t.exports.GetRoomBounds=o(e,"GetRoomBounds"),t.exports.GetRoomClassifications=o(e,"GetRoomClassifications")}}]);