/*! For license information please see 58.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[58],{37291:e=>{"use strict";function t(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function n(e,t){for(var n,r="",s=0,i=-1,o=0,a=0;a<=e.length;++a){if(a<e.length)n=e.charCodeAt(a);else{if(47===n)break;n=47}if(47===n){if(i===a-1||1===o);else if(i!==a-1&&2===o){if(r.length<2||2!==s||46!==r.charCodeAt(r.length-1)||46!==r.charCodeAt(r.length-2))if(r.length>2){var c=r.lastIndexOf("/");if(c!==r.length-1){-1===c?(r="",s=0):s=(r=r.slice(0,c)).length-1-r.lastIndexOf("/"),i=a,o=0;continue}}else if(2===r.length||1===r.length){r="",s=0,i=a,o=0;continue}t&&(r.length>0?r+="/..":r="..",s=2)}else r.length>0?r+="/"+e.slice(i+1,a):r=e.slice(i+1,a),s=a-i-1;i=a,o=0}else 46===n&&-1!==o?++o:o=-1}return r}var r={resolve:function(){for(var e,r="",s=!1,i=arguments.length-1;i>=-1&&!s;i--){var o;i>=0?o=arguments[i]:(void 0===e&&(e=process.cwd()),o=e),t(o),0!==o.length&&(r=o+"/"+r,s=47===o.charCodeAt(0))}return r=n(r,!s),s?r.length>0?"/"+r:"/":r.length>0?r:"."},normalize:function(e){if(t(e),0===e.length)return".";var r=47===e.charCodeAt(0),s=47===e.charCodeAt(e.length-1);return 0!==(e=n(e,!r)).length||r||(e="."),e.length>0&&s&&(e+="/"),r?"/"+e:e},isAbsolute:function(e){return t(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,n=0;n<arguments.length;++n){var s=arguments[n];t(s),s.length>0&&(void 0===e?e=s:e+="/"+s)}return void 0===e?".":r.normalize(e)},relative:function(e,n){if(t(e),t(n),e===n)return"";if((e=r.resolve(e))===(n=r.resolve(n)))return"";for(var s=1;s<e.length&&47===e.charCodeAt(s);++s);for(var i=e.length,o=i-s,a=1;a<n.length&&47===n.charCodeAt(a);++a);for(var c=n.length-a,l=o<c?o:c,u=-1,h=0;h<=l;++h){if(h===l){if(c>l){if(47===n.charCodeAt(a+h))return n.slice(a+h+1);if(0===h)return n.slice(a+h)}else o>l&&(47===e.charCodeAt(s+h)?u=h:0===h&&(u=0));break}var d=e.charCodeAt(s+h);if(d!==n.charCodeAt(a+h))break;47===d&&(u=h)}var f="";for(h=s+u+1;h<=i;++h)h!==i&&47!==e.charCodeAt(h)||(0===f.length?f+="..":f+="/..");return f.length>0?f+n.slice(a+u):(a+=u,47===n.charCodeAt(a)&&++a,n.slice(a))},_makeLong:function(e){return e},dirname:function(e){if(t(e),0===e.length)return".";for(var n=e.charCodeAt(0),r=47===n,s=-1,i=!0,o=e.length-1;o>=1;--o)if(47===(n=e.charCodeAt(o))){if(!i){s=o;break}}else i=!1;return-1===s?r?"/":".":r&&1===s?"//":e.slice(0,s)},basename:function(e,n){if(void 0!==n&&"string"!=typeof n)throw new TypeError('"ext" argument must be a string');t(e);var r,s=0,i=-1,o=!0;if(void 0!==n&&n.length>0&&n.length<=e.length){if(n.length===e.length&&n===e)return"";var a=n.length-1,c=-1;for(r=e.length-1;r>=0;--r){var l=e.charCodeAt(r);if(47===l){if(!o){s=r+1;break}}else-1===c&&(o=!1,c=r+1),a>=0&&(l===n.charCodeAt(a)?-1==--a&&(i=r):(a=-1,i=c))}return s===i?i=c:-1===i&&(i=e.length),e.slice(s,i)}for(r=e.length-1;r>=0;--r)if(47===e.charCodeAt(r)){if(!o){s=r+1;break}}else-1===i&&(o=!1,i=r+1);return-1===i?"":e.slice(s,i)},extname:function(e){t(e);for(var n=-1,r=0,s=-1,i=!0,o=0,a=e.length-1;a>=0;--a){var c=e.charCodeAt(a);if(47!==c)-1===s&&(i=!1,s=a+1),46===c?-1===n?n=a:1!==o&&(o=1):-1!==n&&(o=-1);else if(!i){r=a+1;break}}return-1===n||-1===s||0===o||1===o&&n===s-1&&n===r+1?"":e.slice(n,s)},format:function(e){if(null===e||"object"!=typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var n=t.dir||t.root,r=t.base||(t.name||"")+(t.ext||"");return n?n===t.root?n+r:n+e+r:r}("/",e)},parse:function(e){t(e);var n={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return n;var r,s=e.charCodeAt(0),i=47===s;i?(n.root="/",r=1):r=0;for(var o=-1,a=0,c=-1,l=!0,u=e.length-1,h=0;u>=r;--u)if(47!==(s=e.charCodeAt(u)))-1===c&&(l=!1,c=u+1),46===s?-1===o?o=u:1!==h&&(h=1):-1!==o&&(h=-1);else if(!l){a=u+1;break}return-1===o||-1===c||0===h||1===h&&o===c-1&&o===a+1?-1!==c&&(n.base=n.name=0===a&&i?e.slice(1,c):e.slice(a,c)):(0===a&&i?(n.name=e.slice(1,o),n.base=e.slice(1,c)):(n.name=e.slice(a,o),n.base=e.slice(a,c)),n.ext=e.slice(o,c)),a>0?n.dir=e.slice(0,a-1):i&&(n.dir="/"),n},sep:"/",delimiter:":",win32:null,posix:null};r.posix=r,e.exports=r},44183:(e,t,n)=>{"use strict";n.d(t,{I:()=>TilesRenderer});var r=n(37291);function s(e){let t;try{t=new URL(e,"http://fakehost.com/")}catch(e){return null}const n=t.pathname.split("/").pop(),r=n.lastIndexOf(".");if(-1===r||r===n.length-1)return null;return n.substring(r+1)}class LRUCache{constructor(){this.maxSize=800,this.minSize=600,this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const n=this.itemSet;if(n.has(e))return!1;if(this.isFull())return!1;const r=this.usedSet,s=this.itemList,i=this.callbacks;return s.push(e),r.add(e),n.set(e,Date.now()),i.set(e,t),!0}remove(e){const t=this.usedSet,n=this.itemSet,r=this.itemList,s=this.callbacks;if(n.has(e)){s.get(e)(e);const i=r.indexOf(e);return r.splice(i,1),t.delete(e),n.delete(e),s.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,n=this.usedSet;t.has(e)&&!n.has(e)&&(t.set(e,Date.now()),n.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,n=this.itemList,r=this.itemSet,s=this.usedSet,i=this.callbacks,o=n.length-s.size,a=n.length-t,c=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&o>0){n.sort(((e,t)=>{const n=s.has(e),r=s.has(t);return n&&r?0:n||r?n?1:-1:c(t)-c(e)}));const l=Math.min(a,o),u=Math.max(t*e,l*e);let h=Math.min(u,o);h=Math.ceil(h);const d=n.splice(0,h);for(let e=0,t=d.length;e<t;e++){const t=d[e];i.get(t)(t),r.delete(t),i.delete(t)}}}scheduleUnload(e=!0){var t;this.scheduled||(this.scheduled=!0,t=()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()},Promise.resolve().then(t))}}var i=n(80122);function o(e){return 3===e||4===e}function a(e,t){return e.__lastFrameVisited===t&&e.__used}function c(e,t){e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)}function l(e,t,n){if(c(e,t),e.__used=!0,n.markUsed(e),e.__contentEmpty){const r=e.children;for(let e=0,s=r.length;e<s;e++)l(r[e],t,n)}}function u(e,t,n){if(e.__contentEmpty&&(!e.__externalTileSet||o(e.__loadingState))){const r=e.children;for(let e=0,s=r.length;e<s;e++){const s=r[e];s.__depthFromRenderedParent=t,u(s,t,n)}}else n.requestTileContents(e)}function h(e,t=null,n=null,r=null,s=0){if(t&&t(e,r,s))return void(n&&n(e,r,s));const i=e.children;for(let r=0,o=i.length;r<o;r++)h(i[r],t,n,e,s+1);n&&n(e,r,s)}function d(e,t){const n=t.stats,r=t.frameCount,s=t.errorTarget,i=t.maxDepth,o=t.loadSiblings,a=t.lruCache,u=t.stopAtEmptyTiles;c(e,r);if(!1===t.tileInView(e))return!1;if(e.__used=!0,a.markUsed(e),e.__inFrustum=!0,n.inFrustum++,(u||!e.__contentEmpty)&&!e.__externalTileSet){t.calculateError(e);if(e.__error<=s)return!0;if(t.maxDepth>0&&e.__depth+1>=i)return!0}let h=!1;const f=e.children;for(let e=0,n=f.length;e<n;e++){const n=d(f[e],t);h=h||n}if(h&&o)for(let e=0,t=f.length;e<t;e++){l(f[e],r,a)}return!0}function f(e,t){const n=t.stats,r=t.frameCount;if(!a(e,r))return;n.used++;const s=e.children;let i=!1;for(let e=0,t=s.length;e<t;e++){const t=s[e];i=i||a(t,r)}if(i){let n=!1,i=!0;for(let e=0,c=s.length;e<c;e++){const c=s[e];if(f(c,t),n=n||c.__wasSetVisible||c.__childrenWereVisible,a(c,r)){const e=c.__allChildrenLoaded||!c.__contentEmpty&&o(c.__loadingState)||c.__externalTileSet&&4===c.__loadingState;i=i&&e}}e.__childrenWereVisible=n,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function p(e,t){const n=t.stats,r=t.frameCount;if(!a(e,r))return;const s=e.parent,i=s?s.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=i;const c=t.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(3===e.__loadingState?(e.__inFrustum&&(e.__visible=!0,n.visible++),e.__active=!0,n.active++):c.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.requestTileContents(e));const l=(t.errorTarget+1)*t.errorThreshold,h=e.__error<=l,d=h||"ADD"===e.refine,f=!e.__contentEmpty,g=f||e.__externalTileSet,m=o(e.__loadingState)&&g,w=e.__childrenWereVisible,x=e.children;let y=e.__allChildrenLoaded;if(d&&f&&e.__depthFromRenderedParent++,d&&!m&&!c.isFull()&&g&&t.requestTileContents(e),(h&&!y&&!w&&m||"ADD"===e.refine&&m)&&(e.__inFrustum&&(e.__visible=!0,n.visible++),e.__active=!0,n.active++),"ADD"!==e.refine&&h&&!y&&m)for(let n=0,s=x.length;n<s;n++){const s=x[n];a(s,r)&&!c.isFull()&&(s.__depthFromRenderedParent=e.__depthFromRenderedParent+1,u(s,s.__depthFromRenderedParent,t))}else for(let e=0,n=x.length;e<n;e++){const n=x[e];a(n,r)&&p(n,t)}}function g(e,t){const n=a(e,t.frameCount);if(n||e.__usedLastFrame){let r=!1,s=!1;n&&(r=e.__active,s=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||3!==e.__loadingState||(e.__wasSetActive!==r&&t.setTileActive(e,r),e.__wasSetVisible!==s&&t.setTileVisible(e,s)),e.__wasSetActive=r,e.__wasSetVisible=s,e.__usedLastFrame=n;const i=e.children;for(let e=0,n=i.length;e<n;e++){g(i[e],t)}}}const m=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,w=e=>1/(e.__depthFromRenderedParent+1);function x(e){return(new TextDecoder).decode(e)}class FeatureTable{constructor(e,t,n,r){this.buffer=e,this.binOffset=t+n,this.binLength=r;let s=null;if(0!==n){const r=new Uint8Array(e,t,n);s=JSON.parse(x(r))}else s={};this.header=s}getKeys(){return Object.keys(this.header)}getData(e,t,n=null,r=null){const s=this.header;if(!(e in s))return null;const i=s[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:s,binOffset:o,binLength:a}=this,c=i.byteOffset||0,l=i.type||r,u=i.componentType||n;if("type"in i&&r&&i.type!==r)throw new Error("FeatureTable: Specified type does not match expected type.");let h,d;switch(l){case"SCALAR":h=1;break;case"VEC2":h=2;break;case"VEC3":h=3;break;case"VEC4":h=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${e}".`)}const f=o+c,p=t*h;switch(u){case"BYTE":d=new Int8Array(s,f,p);break;case"UNSIGNED_BYTE":d=new Uint8Array(s,f,p);break;case"SHORT":d=new Int16Array(s,f,p);break;case"UNSIGNED_SHORT":d=new Uint16Array(s,f,p);break;case"INT":d=new Int32Array(s,f,p);break;case"UNSIGNED_INT":d=new Uint32Array(s,f,p);break;case"FLOAT":d=new Float32Array(s,f,p);break;case"DOUBLE":d=new Float64Array(s,f,p);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${e}".`)}if(f+p*d.BYTES_PER_ELEMENT>o+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}return i}}class BatchTable extends FeatureTable{constructor(e,t,n,r,s){super(e,n,r,s),this.batchSize=t}getData(e,t=null,n=null){return super.getData(e,this.batchSize,t,n)}}class LoaderBase{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}class B3DMLoaderBase extends LoaderBase{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("b3dm"===n);const r=t.getUint32(4,!0);console.assert(1===r);const s=t.getUint32(8,!0);console.assert(s===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),l=e.slice(28,28+i+o),u=new FeatureTable(l,0,i,o),h=28+i+o,d=e.slice(h,h+a+c),f=new BatchTable(d,u.getData("BATCH_LENGTH"),0,a,c),p=h+a+c;return{version:r,featureTable:u,batchTable:f,glbBytes:new Uint8Array(e,p,s-p)}}}var y=n(84428),b=n(17047);class B3DMLoader extends B3DMLoaderBase{constructor(e=y.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),n=t.glbBytes.slice().buffer;return new Promise(((e,r)=>{const s=this.manager,i=this.fetchOptions,o=s.getHandler("path.gltf")||new b.GLTFLoader(s);"include"===i.credentials&&"cors"===i.mode&&o.setCrossOrigin("use-credentials"),"credentials"in i&&o.setWithCredentials("include"===i.credentials),i.headers&&o.setRequestHeader(i.headers);let a=this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/"),o.parse(n,a,(n=>{const{batchTable:r,featureTable:s}=t,{scene:i}=n,o=s.getData("RTC_CENTER");o&&(i.position.x+=o[0],i.position.y+=o[1],i.position.z+=o[2]),n.batchTable=r,n.featureTable=s,i.batchTable=r,i.featureTable=s,e(n)}),r)}))}}class PNTSLoaderBase extends LoaderBase{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("pnts"===n);const r=t.getUint32(4,!0);console.assert(1===r);const s=t.getUint32(8,!0);console.assert(s===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),l=e.slice(28,28+i+o),u=new FeatureTable(l,0,i,o),h=28+i+o,d=e.slice(h,h+a+c),f=new BatchTable(d,u.getData("BATCH_LENGTH")||u.getData("POINTS_LENGTH"),0,a,c);return Promise.resolve({version:r,featureTable:u,batchTable:f})}}class PNTSLoader extends PNTSLoaderBase{constructor(e=y.DefaultLoadingManager){super(),this.manager=e}parse(e){return super.parse(e).then((e=>{const{featureTable:t}=e,n=t.getData("POINTS_LENGTH"),r=t.getData("POSITION",n,"FLOAT","VEC3"),s=t.getData("RGB",n,"UNSIGNED_BYTE","VEC3");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGBA","RGB565","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const i=new y.BufferGeometry;i.setAttribute("position",new y.BufferAttribute(r,3,!1));const o=new y.PointsMaterial;o.size=2,o.sizeAttenuation=!1,null!==s&&(i.setAttribute("color",new y.BufferAttribute(s,3,!0)),o.vertexColors=!0);const a=new y.Points(i,o);e.scene=a,e.scene.featureTable=t;const c=t.getData("RTC_CENTER");return c&&(e.scene.position.x+=c[0],e.scene.position.y+=c[1],e.scene.position.z+=c[2]),e}))}}class I3DMLoaderBase extends LoaderBase{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("i3dm"===n);const r=t.getUint32(4,!0);console.assert(1===r);const s=t.getUint32(8,!0);console.assert(s===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),c=t.getUint32(24,!0),l=t.getUint32(28,!0),u=e.slice(32,32+i+o),h=new FeatureTable(u,0,i,o),d=32+i+o,f=e.slice(d,d+a+c),p=new BatchTable(f,h.getData("INSTANCES_LENGTH"),0,a,c),g=d+a+c,m=new Uint8Array(e,g,s-g);let w=null,y=null;if(l)w=m,y=Promise.resolve();else{const e=this.resolveExternalURL(x(m));y=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>{w=new Uint8Array(e)}))}return y.then((()=>({version:r,featureTable:h,batchTable:p,glbBytes:w})))}}const _=new y.Vector3,T=new y.Vector3,S=new y.Vector3,v=new y.Vector3,B=new y.Quaternion,M=new y.Vector3,P=new y.Matrix4;class I3DMLoader extends I3DMLoaderBase{constructor(e=y.DefaultLoadingManager){super(),this.manager=e}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:n}=e,r=e.glbBytes.slice().buffer;return new Promise(((e,s)=>{const i=this.fetchOptions,o=this.manager,a=o.getHandler("path.gltf")||new b.GLTFLoader(o);"include"===i.credentials&&"cors"===i.mode&&a.setCrossOrigin("use-credentials"),"credentials"in i&&a.setWithCredentials("include"===i.credentials),i.headers&&a.setRequestHeader(i.headers);let c=this.workingPath;/[\\/]$/.test(c)||(c+="/"),a.parse(r,c,(r=>{const s=t.getData("INSTANCES_LENGTH"),i=t.getData("POSITION",s,"FLOAT","VEC3"),o=t.getData("NORMAL_UP",s,"FLOAT","VEC3"),a=t.getData("NORMAL_RIGHT",s,"FLOAT","VEC3"),c=t.getData("SCALE_NON_UNIFORM",s,"FLOAT","VEC3"),l=t.getData("SCALE",s,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const u=new Map,h=[];r.scene.traverse((e=>{if(e.isMesh){const{geometry:t,material:n}=e,r=new y.InstancedMesh(t,n,s);r.position.copy(e.position),r.rotation.copy(e.rotation),r.scale.copy(e.scale),h.push(r),u.set(e,r)}}));const d=new y.Vector3;for(let e=0;e<s;e++)d.x+=i[3*e+0]/s,d.y+=i[3*e+1]/s,d.z+=i[3*e+2]/s;u.forEach(((e,t)=>{const n=t.parent;n&&(n.remove(t),n.add(e),e.updateMatrixWorld(),e.position.copy(d).applyMatrix4(e.matrixWorld))}));for(let e=0;e<s;e++){v.set(i[3*e+0]-d.x,i[3*e+1]-d.y,i[3*e+2]-d.z),o?(T.set(o[3*e+0],o[3*e+1],o[3*e+2]),S.set(a[3*e+0],a[3*e+1],a[3*e+2]),_.crossVectors(S,T).normalize(),P.makeBasis(S,T,_),B.setFromRotationMatrix(P)):B.set(0,0,0,1),l?M.setScalar(l[e]):c?M.set(c[3*e+0],c[3*e+1],c[3*e+2]):M.set(1,1,1),P.compose(v,B,M);for(let t=0,n=h.length;t<n;t++){h[t].setMatrixAt(e,P)}}r.batchTable=n,r.featureTable=t,r.scene.batchTable=n,r.scene.featureTable=t,e(r)}),s)}))}))}}class CMPTLoaderBase extends LoaderBase{parse(e){const t=new DataView(e),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3));console.assert("cmpt"===n,'CMPTLoader: The magic bytes equal "cmpt".');const r=t.getUint32(4,!0);console.assert(1===r,'CMPTLoader: The version listed in the header is "1".');const s=t.getUint32(8,!0);console.assert(s===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),o=[];let a=16;for(let t=0;t<i;t++){const t=new DataView(e,a,12),n=String.fromCharCode(t.getUint8(0))+String.fromCharCode(t.getUint8(1))+String.fromCharCode(t.getUint8(2))+String.fromCharCode(t.getUint8(3)),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=new Uint8Array(e,a,s);o.push({type:n,buffer:i,version:r}),a+=s}return{version:r,tiles:o}}}class CMPTLoader extends CMPTLoaderBase{constructor(e=y.DefaultLoadingManager){super(),this.manager=e}parse(e){const t=super.parse(e),n=this.manager,r=[];for(const e in t.tiles){const{type:s,buffer:i}=t.tiles[e];switch(s){case"b3dm":{const e=i.slice(),t=new B3DMLoader(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const s=t.parse(e.buffer);r.push(s);break}case"pnts":{const e=i.slice(),t=new PNTSLoader(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const s=t.parse(e.buffer);r.push(s);break}case"i3dm":{const e=i.slice(),t=new I3DMLoader(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const s=t.parse(e.buffer);r.push(s);break}}}return Promise.all(r).then((e=>{const t=new y.Group;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}class GLTFExtensionLoader extends LoaderBase{constructor(e=y.DefaultLoadingManager){super(),this.manager=e}parse(e){return new Promise(((t,n)=>{const r=this.manager,s=this.fetchOptions;let i=r.getHandler("path.gltf")||r.getHandler("path.glb");i||(i=new b.GLTFLoader(r),"include"===s.credentials&&"cors"===s.mode&&i.setCrossOrigin("use-credentials"),"credentials"in s&&i.setWithCredentials("include"===s.credentials),s.headers&&i.setRequestHeader(s.headers));let o=i.resourcePath||i.path||this.workingPath;!/[\\/]$/.test(o)&&o.length&&(o+="/"),i.parse(e,o,(e=>{t(e)}),n)}))}}const A=new y.Matrix4;class TilesGroup extends y.Group{constructor(e){super(),this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e}raycast(e,t){this.tilesRenderer.optimizeRaycast&&this.tilesRenderer.raycast(e,t)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?A.copy(this.matrix):A.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=A.elements,t=this.matrixWorld.elements;let n=!1;for(let r=0;r<16;r++){const s=e[r],i=t[r];if(Math.abs(s-i)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(A);const e=this.children;for(let t=0,n=e.length;t<n;t++)e[t].updateMatrixWorld()}}}}const V=new y.Sphere,F=new y.Matrix4,C=new y.Vector3,U=new y.Vector3,L=new y.Ray,E=[];function R(e,t){return e.distance-t.distance}function k(e,t,n){e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,n)}))}function O(e,t,n,r){if(n.has(e)){if(k(e.cached.scene,r,E),E.length>0){E.length>1&&E.sort(R);const e=E[0];return E.length=0,e}return null}const s=[],i=e.children;for(let e=0,n=i.length;e<n;e++){const n=i[e],o=n.cached,a=t.matrixWorld;F.copy(a);const c=o.sphere;if(c&&(V.copy(c),V.applyMatrix4(F),!r.ray.intersectsSphere(V)))continue;const l=o.box,u=o.boxTransform;if(l){if(F.multiply(u).invert(),L.copy(r.ray),L.applyMatrix4(F),!L.intersectBox(l,C))continue;{let e;U.setFromMatrixScale(F),e=U.x,Math.abs(Math.max(U.x-U.y,U.x-U.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when raycasting.");let t={distance:1/0,tile:null};s.push(t),t.distance=C.distanceToSquared(L.origin)*e*e,t.tile=n}}}s.sort(R);let o=1/0,a=null;for(let e=0,i=s.length;e<i;e++){const i=s[e];if(i.distance>o)break;{const e=i.tile,s=e.cached.scene;let c=null;if(n.has(e)?(k(s,r,E),E.length>0&&(E.length>1&&E.sort(R),c=E[0])):c=O(e,t,n,r),c){const e=c.distance*c.distance;e<o&&(o=e,a=c),E.length=0}}}return a}function I(e,t,n,r,s){const i=e.cached,o=t.matrixWorld;F.copy(o);const a=i.sphere;if(a&&(V.copy(a),V.applyMatrix4(F),!r.ray.intersectsSphere(V)))return;const c=i.box,l=i.boxTransform;if(c&&(F.multiply(l).invert(),L.copy(r.ray).applyMatrix4(F),!L.intersectsBox(c)))return;const u=i.scene;if(n.has(e))return void k(u,r,s);const h=e.children;for(let e=0,i=h.length;e<i;e++)I(h[e],t,n,r,s)}const D=Symbol("INITIAL_FRUSTUM_CULLED"),N=new y.Matrix4,H=new y.Matrix4,z=new y.Vector3,G=new y.Vector3,q=new y.Vector3,j=new y.Vector3,W=new y.Vector3(1,0,0),$=new y.Vector3(0,1,0);function J(e,t){e.traverse((e=>{e.frustumCulled=e[D]&&t}))}class TilesRenderer extends class TilesRendererBase{get rootTileSet(){const e=this.tileSets[this.rootURL];return!e||e instanceof Promise?null:e}get root(){const e=this.rootTileSet;return e?e.root:null}constructor(e){this.tileSets={},this.rootURL=e,this.fetchOptions={},this.preprocessURL=null;const t=new LRUCache;t.unloadPriorityCallback=w;const n=new i.Z;n.maxJobs=4,n.priorityCallback=m;const r=new i.Z;r.maxJobs=1,r.priorityCallback=m,this.lruCache=t,this.downloadQueue=n,this.parseQueue=r,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0}traverse(e,t){const n=this.tileSets[this.rootURL];n&&n.root&&h(n.root,e,t)}update(){const e=this.stats,t=this.lruCache,n=this.tileSets,r=n[this.rootURL];if(!(this.rootURL in n))return void this.loadRootTileSet(this.rootURL);if(!r||!r.root)return;const s=r.root;e.inFrustum=0,e.used=0,e.active=0,e.visible=0,this.frameCount++,d(s,this),f(s,this),p(s,this),g(s,this),t.scheduleUnload()}parseTile(e,t,n){return null}disposeTile(e){}preprocessNode(e,t,n){e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=function(...e){const t=/^[a-zA-Z]+:\/\//;let n=-1;for(let r=0,s=e.length;r<s;r++)t.test(e[r])&&(n=r);if(-1===n)return r.join(...e).replace(/\\/g,"/");{const s=n<=0?e:e.slice(n),i=s[0].match(t)[0];return s[0]=s[0].substring(i.length),(i+r.join(...s)).replace(/\\/g,"/")}}(n,e.content.uri)),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=t,e.children=e.children||[];if(e.content&&e.content.uri){const t=s(e.content.uri),n=Boolean(t&&"json"===t.toLowerCase());e.__externalTileSet=n,e.__contentEmpty=n}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,null===t?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=t.__depth+1,e.refine=e.refine||t.refine)}setTileActive(e,t){}setTileVisible(e,t){}calculateError(e){return 0}tileInView(e){return!0}fetchTileSet(e,t,n=null){return fetch(e,t).then((t=>{if(t.ok)return t.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>{const s=t.asset.version;console.assert("1.0"===s||"0.0"===s,'asset.version is expected to be a string of "1.0" or "0.0"');const i=r.dirname(e);return h(t.root,((e,t)=>this.preprocessNode(e,t,i)),null,n,n?n.__depth:0),t}))}loadRootTileSet(e){const t=this.tileSets;if(e in t)return t[e]instanceof Error?Promise.reject(t[e]):Promise.resolve(t[e]);{const n=this.fetchTileSet(this.preprocessURL?this.preprocessURL(e):e,this.fetchOptions).then((n=>{t[e]=n}));return n.catch((n=>{console.error(n),t[e]=n})),t[e]=n,n}}requestTileContents(e){if(0!==e.__loadingState)return;const t=this.stats,n=this.lruCache,r=this.downloadQueue,i=this.parseQueue,o=e.__externalTileSet;n.add(e,(e=>{1===e.__loadingState?(e.__loadAbort.abort(),e.__loadAbort=null):o?e.children.length=0:this.disposeTile(e),1===e.__loadingState?t.downloading--:2===e.__loadingState&&t.parsing--,e.__loadingState=0,e.__loadIndex++,i.remove(e),r.remove(e)})),e.__loadIndex++;const a=e.__loadIndex,c=new AbortController,l=c.signal;t.downloading++,e.__loadAbort=c,e.__loadingState=1;const u=s=>{e.__loadIndex===a&&("AbortError"!==s.name?(i.remove(e),r.remove(e),2===e.__loadingState?t.parsing--:1===e.__loadingState&&t.downloading--,t.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(s),e.__loadingState=4):n.remove(e))};o?r.add(e,(e=>{if(e.__loadIndex!==a)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return this.fetchTileSet(t,Object.assign({signal:l},this.fetchOptions),e)})).then((n=>{e.__loadIndex===a&&(t.downloading--,e.__loadAbort=null,e.__loadingState=3,e.children.push(n.root))})).catch(u):r.add(e,(e=>{if(e.__loadIndex!==a)return Promise.resolve();const t=this.preprocessURL?this.preprocessURL(e.content.uri):e.content.uri;return fetch(t,Object.assign({signal:l},this.fetchOptions))})).then((t=>{if(e.__loadIndex===a){if(t.ok)return t.arrayBuffer();throw new Error(`Failed to load model with error code ${t.status}`)}})).then((n=>{if(e.__loadIndex===a)return t.downloading--,t.parsing++,e.__loadAbort=null,e.__loadingState=2,i.add(e,(e=>{if(e.__loadIndex!==a)return Promise.resolve();const t=s(e.content.uri);return this.parseTile(n,e,t)}))})).then((()=>{e.__loadIndex===a&&(t.parsing--,e.__loadingState=3,e.__wasSetVisible&&this.setTileVisible(e,!0),e.__wasSetActive&&this.setTileActive(e,!0))})).catch(u)}dispose(){const e=this.lruCache;this.traverse((t=>{e.remove(t)}))}}{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{J(t,!e)})))}constructor(...e){super(...e),this.group=new TilesGroup(this),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this.activeTiles=new Set,this.visibleTiles=new Set,this._autoDisableRendererCulling=!0,this.optimizeRaycast=!0,this.onLoadTileSet=null,this.onLoadModel=null,this.onDisposeModel=null,this.onTileVisibilityChange=null;const t=new y.LoadingManager;t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t;const n=this;this._overridenRaycast=function(e,t){n.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,e,t)}}getBounds(e){if(!this.root)return!1;const t=this.root.cached,n=t.box,r=t.boxTransform;return!!n&&(e.copy(n),e.applyMatrix4(r),!0)}getOrientedBounds(e,t){if(!this.root)return!1;const n=this.root.cached,r=n.box,s=n.boxTransform;return!!r&&(e.copy(r),t.copy(s),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.sphere;return!!t&&(e.copy(t),!0)}forEachLoadedModel(e){this.traverse((t=>{const n=t.cached.scene;n&&e(n,t)}))}raycast(e,t){if(this.root)if(e.firstHitOnly){const n=O(this.root,this.group,this.activeTiles,e);n&&t.push(n)}else I(this.root,this.group,this.activeTiles,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,n=this.cameraMap;return!n.has(e)&&(n.set(e,new y.Vector2),t.push(e),!0)}setResolution(e,t,n){const r=this.cameraMap;return!!r.has(e)&&(t instanceof y.Vector2?r.get(e).copy(t):r.get(e).set(t,n),!0)}setResolutionFromRenderer(e,t){const n=this.cameraMap;if(!n.has(e))return!1;const r=n.get(e);return t.getSize(r),r.multiplyScalar(t.getPixelRatio()),!0}deleteCamera(e){const t=this.cameras,n=this.cameraMap;if(n.has(e)){const r=t.indexOf(e);return t.splice(r,1),n.delete(e),!0}return!1}fetchTileSet(e,...t){const n=super.fetchTileSet(e,...t);return n.then((t=>{this.onLoadTileSet&&Promise.resolve().then((()=>{this.onLoadTileSet(t,e)}))})),n}update(){const e=this.group,t=this.cameras,n=this.cameraMap,r=this.cameraInfo;if(0===t.length)return void console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.");for(;r.length>t.length;)r.pop();for(;r.length<t.length;)r.push({frustum:new y.Frustum,isOrthographic:!1,sseDenominator:-1,position:new y.Vector3,invScale:-1,pixelSize:0});let s;H.copy(e.matrixWorld).invert(),z.setFromMatrixScale(H),s=z.x,Math.abs(Math.max(z.x-z.y,z.x-z.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let i=0,o=r.length;i<o;i++){const o=t[i],a=r[i],c=a.frustum,l=a.position,u=n.get(o);0!==u.width&&0!==u.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=o.projectionMatrix.elements;if(a.isOrthographic=1===h[15],a.isOrthographic){const e=2/h[0],t=2/h[5];a.pixelSize=Math.max(t/u.height,e/u.width)}else a.sseDenominator=2/h[5]/u.height;a.invScale=s,N.copy(e.matrixWorld),N.premultiply(o.matrixWorldInverse),N.premultiply(o.projectionMatrix),c.setFromProjectionMatrix(N),l.set(0,0,0),l.applyMatrix4(o.matrixWorld),l.applyMatrix4(H)}super.update()}preprocessNode(e,t,n){super.preprocessNode(e,t,n);const r=new y.Matrix4;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)r.elements[e]=t[e]}else r.identity();t&&r.premultiply(t.cached.transform);const s=(new y.Matrix4).copy(r).invert();let i=null,o=null,a=null;if("box"in e.boundingVolume){const t=e.boundingVolume.box;i=new y.Box3,o=new y.Matrix4,a=new y.Matrix4,G.set(t[3],t[4],t[5]),q.set(t[6],t[7],t[8]),j.set(t[9],t[10],t[11]);const n=G.length(),s=q.length(),c=j.length();G.normalize(),q.normalize(),j.normalize(),0===n&&G.crossVectors(q,j),0===s&&q.crossVectors(G,j),0===c&&j.crossVectors(G,q),o.set(G.x,q.x,j.x,t[0],G.y,q.y,j.y,t[1],G.z,q.z,j.z,t[2],0,0,0,1),o.premultiply(r),a.copy(o).invert(),i.min.set(-n,-s,-c),i.max.set(n,s,c)}let c=null;if("sphere"in e.boundingVolume){const t=e.boundingVolume.sphere;c=new y.Sphere,c.center.set(t[0],t[1],t[2]),c.radius=t[3],c.applyMatrix4(r)}else if("box"in e.boundingVolume){const t=e.boundingVolume.box;c=new y.Sphere,i.getBoundingSphere(c),c.center.set(t[0],t[1],t[2]),c.applyMatrix4(r)}"region"in e.boundingVolume&&console.warn("ThreeTilesRenderer: region bounding volume not supported."),e.cached={loadIndex:0,transform:r,transformInverse:s,active:!1,inFrustum:[],box:i,boxTransform:o,boxTransformInverse:a,sphere:c,region:null,scene:null,geometry:null,material:null}}parseTile(e,t,n){t._loadIndex=t._loadIndex||0,t._loadIndex++;const r=t.content.uri.split(/[\\\/]/g);r.pop();const s=r.join("/"),i=this.fetchOptions,o=this.manager,a=t._loadIndex;let c=null;switch(n){case"b3dm":{const t=new B3DMLoader(o);t.workingPath=s,t.fetchOptions=i,c=t.parse(e).then((e=>e.scene));break}case"pnts":{const t=new PNTSLoader(o);t.workingPath=s,t.fetchOptions=i,c=t.parse(e).then((e=>e.scene));break}case"i3dm":{const t=new I3DMLoader(o);t.workingPath=s,t.fetchOptions=i,c=t.parse(e).then((e=>e.scene));break}case"cmpt":{const t=new CMPTLoader(o);t.workingPath=s,t.fetchOptions=i,c=t.parse(e).then((e=>e.scene));break}case"gltf":case"glb":const t=new GLTFExtensionLoader(o);t.workingPath=s,t.fetchOptions=i,c=t.parse(e).then((e=>e.scene));break;default:console.warn(`TilesRenderer: Content type "${n}" not supported.`),c=Promise.resolve(null)}return c.then((e=>{if(t._loadIndex!==a)return;const r=this.rootTileSet.asset&&this.rootTileSet.asset.gltfUpAxis||"y",s=t.cached,i=s.transform;switch(r.toLowerCase()){case"x":N.makeRotationAxis($,-Math.PI/2);break;case"y":N.makeRotationAxis(W,Math.PI/2);break;case"z":N.identity()}e.updateMatrix(),"pnts"!==n&&e.matrix.multiply(N),e.matrix.premultiply(i),e.matrix.decompose(e.position,e.quaternion,e.scale),e.traverse((e=>{e[D]=e.frustumCulled})),J(e,!this.autoDisableRendererCulling),s.scene=e,e.traverse((e=>{e.raycast=this._overridenRaycast}));const o=[],c=[],l=[];e.traverse((e=>{if(e.geometry&&c.push(e.geometry),e.material){const t=e.material;o.push(e.material);for(const e in t){const n=t[e];n&&n.isTexture&&l.push(n)}}})),s.materials=o,s.geometry=c,s.textures=l,this.onLoadModel&&this.onLoadModel(e,t)}))}disposeTile(e){const t=e.cached;if(t.scene){const n=t.materials,r=t.geometry,s=t.textures;for(let e=0,t=r.length;e<t;e++)r[e].dispose();for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=s.length;e<t;e++){s[e].dispose()}this.onDisposeModel&&this.onDisposeModel(t.scene,e),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}e._loadIndex++}setTileVisible(e,t){const n=e.cached.scene,r=this.visibleTiles,s=this.group;t?(s.add(n),r.add(e),n.updateMatrixWorld(!0)):(s.remove(n),r.delete(e)),this.onTileVisibilityChange&&this.onTileVisibilityChange(n,e,t)}setTileActive(e,t){const n=this.activeTiles;t?n.add(e):n.delete(e)}calculateError(e){const t=e.cached,n=t.inFrustum,r=this.cameras,s=this.cameraInfo,i=e.boundingVolume;if("box"in i||"sphere"in i){const i=t.sphere,o=t.box,a=t.boxTransformInverse,c=t.transformInverse,l=o&&a;let u=-1/0,h=1/0;for(let t=0,d=r.length;t<d;t++){if(!n[t])continue;const r=s[t],d=r.invScale;let f;if(r.isOrthographic){const t=r.pixelSize;f=e.geometricError/(t*d)}else{let t;z.copy(r.position),l?(z.applyMatrix4(a),t=o.distanceToPoint(z)):(z.applyMatrix4(c),t=Math.max(i.distanceToPoint(z),0));const n=t*d,s=r.sseDenominator;f=e.geometricError/(n*s),h=Math.min(h,n)}u=Math.max(u,f)}e.__distanceFromCamera=h,e.__error=u}else"region"in i&&console.warn("ThreeTilesRenderer : Region bounds not supported.")}tileInView(e){const t=e.cached,n=t.sphere,r=t.inFrustum;if(n){const e=this.cameraInfo;let t=!1;for(let s=0,i=e.length;s<i;s++){e[s].frustum.intersectsSphere(n)?(t=!0,r[s]=!0):r[s]=!1}return t}return!0}}},80122:(e,t,n)=>{"use strict";n.d(t,{Z:()=>PriorityQueue});class PriorityQueue{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((n,r)=>{const s=this.items,i=this.callbacks;s.push(e),i.set(e,((...e)=>t(...e).then(n).catch(r))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,n=this.callbacks,r=t.indexOf(e);-1!==r&&(t.splice(r,1),n.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,n=this.maxJobs;let r=this.currJobs;for(;n>r&&e.length>0;){r++;const n=e.pop(),s=t.get(n);t.delete(n),s(n).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=r}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}},80645:(e,t)=>{t.read=function(e,t,n,r,s){var i,o,a=8*s-r-1,c=(1<<a)-1,l=c>>1,u=-7,h=n?s-1:0,d=n?-1:1,f=e[t+h];for(h+=d,i=f&(1<<-u)-1,f>>=-u,u+=a;u>0;i=256*i+e[t+h],h+=d,u-=8);for(o=i&(1<<-u)-1,i>>=-u,u+=r;u>0;o=256*o+e[t+h],h+=d,u-=8);if(0===i)i=1-l;else{if(i===c)return o?NaN:1/0*(f?-1:1);o+=Math.pow(2,r),i-=l}return(f?-1:1)*o*Math.pow(2,i-r)},t.write=function(e,t,n,r,s,i){var o,a,c,l=8*i-s-1,u=(1<<l)-1,h=u>>1,d=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:i-1,p=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=u):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),(t+=o+h>=1?d/c:d*Math.pow(2,1-h))*c>=2&&(o++,c/=2),o+h>=u?(a=0,o=u):o+h>=1?(a=(t*c-1)*Math.pow(2,s),o+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,s),o=0));s>=8;e[n+f]=255&a,f+=p,a/=256,s-=8);for(o=o<<s|a,l+=s;l>0;e[n+f]=255&o,f+=p,o/=256,l-=8);e[n+f-p]|=128*g}},3614:(e,t,n)=>{"use strict";e.exports=s;var r=n(80645);function s(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}s.Varint=0,s.Fixed64=1,s.Bytes=2,s.Fixed32=5;var i=4294967296,o=1/i;function a(e){return e.type===s.Bytes?e.readVarint()+e.pos:e.pos+1}function c(e,t,n){return n?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function l(e,t,n){var r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.ceil(Math.log(t)/(7*Math.LN2));n.realloc(r);for(var s=n.pos-1;s>=e;s--)n.buf[s+r]=n.buf[s]}function u(e,t){for(var n=0;n<e.length;n++)t.writeVarint(e[n])}function h(e,t){for(var n=0;n<e.length;n++)t.writeSVarint(e[n])}function d(e,t){for(var n=0;n<e.length;n++)t.writeFloat(e[n])}function f(e,t){for(var n=0;n<e.length;n++)t.writeDouble(e[n])}function p(e,t){for(var n=0;n<e.length;n++)t.writeBoolean(e[n])}function g(e,t){for(var n=0;n<e.length;n++)t.writeFixed32(e[n])}function m(e,t){for(var n=0;n<e.length;n++)t.writeSFixed32(e[n])}function w(e,t){for(var n=0;n<e.length;n++)t.writeFixed64(e[n])}function x(e,t){for(var n=0;n<e.length;n++)t.writeSFixed64(e[n])}function y(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function b(e,t,n){e[n]=t,e[n+1]=t>>>8,e[n+2]=t>>>16,e[n+3]=t>>>24}function _(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}s.prototype={destroy:function(){this.buf=null},readFields:function(e,t,n){for(n=n||this.length;this.pos<n;){var r=this.readVarint(),s=r>>3,i=this.pos;this.type=7&r,e(s,t,this),this.pos===i&&this.skip(r)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=y(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=_(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=y(this.buf,this.pos)+y(this.buf,this.pos+4)*i;return this.pos+=8,e},readSFixed64:function(){var e=y(this.buf,this.pos)+_(this.buf,this.pos+4)*i;return this.pos+=8,e},readFloat:function(){var e=r.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=r.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,n,r=this.buf;return t=127&(n=r[this.pos++]),n<128?t:(t|=(127&(n=r[this.pos++]))<<7,n<128?t:(t|=(127&(n=r[this.pos++]))<<14,n<128?t:(t|=(127&(n=r[this.pos++]))<<21,n<128?t:function(e,t,n){var r,s,i=n.buf;if(s=i[n.pos++],r=(112&s)>>4,s<128)return c(e,r,t);if(s=i[n.pos++],r|=(127&s)<<3,s<128)return c(e,r,t);if(s=i[n.pos++],r|=(127&s)<<10,s<128)return c(e,r,t);if(s=i[n.pos++],r|=(127&s)<<17,s<128)return c(e,r,t);if(s=i[n.pos++],r|=(127&s)<<24,s<128)return c(e,r,t);if(s=i[n.pos++],r|=(1&s)<<31,s<128)return c(e,r,t);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(n=r[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var e=this.readVarint()+this.pos,t=function(e,t,n){var r="",s=t;for(;s<n;){var i,o,a,c=e[s],l=null,u=c>239?4:c>223?3:c>191?2:1;if(s+u>n)break;1===u?c<128&&(l=c):2===u?128==(192&(i=e[s+1]))&&(l=(31&c)<<6|63&i)<=127&&(l=null):3===u?(i=e[s+1],o=e[s+2],128==(192&i)&&128==(192&o)&&((l=(15&c)<<12|(63&i)<<6|63&o)<=2047||l>=55296&&l<=57343)&&(l=null)):4===u&&(i=e[s+1],o=e[s+2],a=e[s+3],128==(192&i)&&128==(192&o)&&128==(192&a)&&((l=(15&c)<<18|(63&i)<<12|(63&o)<<6|63&a)<=65535||l>=1114112)&&(l=null)),null===l?(l=65533,u=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),r+=String.fromCharCode(l),s+=u}return r}(this.buf,this.pos,e);return this.pos=e,t},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){var n=a(this);for(e=e||[];this.pos<n;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){var t=a(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===s.Varint)for(;this.buf[this.pos++]>127;);else if(t===s.Bytes)this.pos=this.readVarint()+this.pos;else if(t===s.Fixed32)this.pos+=4;else{if(t!==s.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var n=new Uint8Array(t);n.set(this.buf),this.buf=n,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),b(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),b(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),b(this.buf,-1&e,this.pos),b(this.buf,Math.floor(e*o),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),b(this.buf,-1&e,this.pos),b(this.buf,Math.floor(e*o),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(e,t){var n,r;e>=0?(n=e%4294967296|0,r=e/4294967296|0):(r=~(-e/4294967296),4294967295^(n=~(-e%4294967296))?n=n+1|0:(n=0,r=r+1|0));if(e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,n){n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos]=127&e}(n,0,t),function(e,t){var n=(7&e)<<4;if(t.buf[t.pos++]|=n|((e>>>=3)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;t.buf[t.pos++]=127&e}(r,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(Boolean(e))},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(e,t,n){for(var r,s,i=0;i<t.length;i++){if((r=t.charCodeAt(i))>55295&&r<57344){if(!s){r>56319||i+1===t.length?(e[n++]=239,e[n++]=191,e[n++]=189):s=r;continue}if(r<56320){e[n++]=239,e[n++]=191,e[n++]=189,s=r;continue}r=s-55296<<10|r-56320|65536,s=null}else s&&(e[n++]=239,e[n++]=191,e[n++]=189,s=null);r<128?e[n++]=r:(r<2048?e[n++]=r>>6|192:(r<65536?e[n++]=r>>12|224:(e[n++]=r>>18|240,e[n++]=r>>12&63|128),e[n++]=r>>6&63|128),e[n++]=63&r|128)}return n}(this.buf,e,this.pos);var n=this.pos-t;n>=128&&l(t,n,this),this.pos=t-1,this.writeVarint(n),this.pos+=n},writeFloat:function(e){this.realloc(4),r.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),r.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var n=0;n<t;n++)this.buf[this.pos++]=e[n]},writeRawMessage:function(e,t){this.pos++;var n=this.pos;e(t,this);var r=this.pos-n;r>=128&&l(n,r,this),this.pos=n-1,this.writeVarint(r),this.pos+=r},writeMessage:function(e,t,n){this.writeTag(e,s.Bytes),this.writeRawMessage(t,n)},writePackedVarint:function(e,t){this.writeMessage(e,u,t)},writePackedSVarint:function(e,t){this.writeMessage(e,h,t)},writePackedBoolean:function(e,t){this.writeMessage(e,p,t)},writePackedFloat:function(e,t){this.writeMessage(e,d,t)},writePackedDouble:function(e,t){this.writeMessage(e,f,t)},writePackedFixed32:function(e,t){this.writeMessage(e,g,t)},writePackedSFixed32:function(e,t){this.writeMessage(e,m,t)},writePackedFixed64:function(e,t){this.writeMessage(e,w,t)},writePackedSFixed64:function(e,t){this.writeMessage(e,x,t)},writeBytesField:function(e,t){this.writeTag(e,s.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,s.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,s.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,s.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,s.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,s.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,s.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,s.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,s.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,s.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t))}}},81080:(e,t,n)=>{"use strict";n.d(t,{r:()=>MeshBVH});var r=n(84428);const s=1.25,i=65535,o=Math.pow(2,-24);class MeshBVHNode{constructor(){}}function a(e,t,n){return n.min.x=t[e],n.min.y=t[e+1],n.min.z=t[e+2],n.max.x=t[e+3],n.max.y=t[e+4],n.max.z=t[e+5],n}function c(e){let t=-1,n=-1/0;for(let r=0;r<3;r++){const s=e[r+3]-e[r];s>n&&(n=s,t=r)}return t}function l(e,t){t.set(e)}function u(e,t,n){let r,s;for(let i=0;i<3;i++){const o=i+3;r=e[i],s=t[i],n[i]=r<s?r:s,r=e[o],s=t[o],n[o]=r>s?r:s}}function h(e,t,n){for(let r=0;r<3;r++){const s=t[e+2*r],i=t[e+2*r+1],o=s-i,a=s+i;o<n[r]&&(n[r]=o),a>n[r+3]&&(n[r+3]=a)}}function d(e){const t=e[3]-e[0],n=e[4]-e[1],r=e[5]-e[2];return 2*(t*n+n*r+r*t)}function f(e,t,n,r,s=null){let i=1/0,o=1/0,a=1/0,c=-1/0,l=-1/0,u=-1/0,h=1/0,d=1/0,f=1/0,p=-1/0,g=-1/0,m=-1/0;const w=null!==s;for(let r=6*t,s=6*(t+n);r<s;r+=6){const t=e[r+0],n=e[r+1],s=t-n,x=t+n;s<i&&(i=s),x>c&&(c=x),w&&t<h&&(h=t),w&&t>p&&(p=t);const y=e[r+2],b=e[r+3],_=y-b,T=y+b;_<o&&(o=_),T>l&&(l=T),w&&y<d&&(d=y),w&&y>g&&(g=y);const S=e[r+4],v=e[r+5],B=S-v,M=S+v;B<a&&(a=B),M>u&&(u=M),w&&S<f&&(f=S),w&&S>m&&(m=S)}r[0]=i,r[1]=o,r[2]=a,r[3]=c,r[4]=l,r[5]=u,w&&(s[0]=h,s[1]=d,s[2]=f,s[3]=p,s[4]=g,s[5]=m)}const p=32,g=(e,t)=>e.candidate-t.candidate,m=new Array(p).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),w=new Float32Array(6);function x(e,t){function n(e){B&&B(e/M)}function i(t,r,o,a=null,B=0){if(!P&&B>=_&&(P=!0,T&&(console.warn(`MeshBVH: Max depth of ${_} reached when generating BVH. Consider increasing maxDepth.`),console.warn(e))),o<=S||B>=_)return n(r+o),t.offset=r,t.count=o,t;const M=function(e,t,n,r,i,o){let a=-1,f=0;if(0===o)a=c(t),-1!==a&&(f=(t[a]+t[a+3])/2);else if(1===o)a=c(e),-1!==a&&(f=function(e,t,n,r){let s=0;for(let i=t,o=t+n;i<o;i++)s+=e[6*i+2*r];return s/n}(n,r,i,a));else if(2===o){const o=d(e);let c=s*i;const x=6*r,y=6*(r+i);for(let e=0;e<3;e++){const r=t[e],b=(t[e+3]-r)/p;if(i<8){const t=[...m];t.length=i;let r=0;for(let s=x;s<y;s+=6,r++){const i=t[r];i.candidate=n[s+2*e],i.count=0;const{bounds:o,leftCacheBounds:a,rightCacheBounds:c}=i;for(let e=0;e<3;e++)c[e]=1/0,c[e+3]=-1/0,a[e]=1/0,a[e+3]=-1/0,o[e]=1/0,o[e+3]=-1/0;h(s,n,o)}t.sort(g);let l=i;for(let e=0;e<l;e++){const n=t[e];for(;e+1<l&&t[e+1].candidate===n.candidate;)t.splice(e+1,1),l--}for(let r=x;r<y;r+=6){const s=n[r+2*e];for(let e=0;e<l;e++){const i=t[e];s>=i.candidate?h(r,n,i.rightCacheBounds):(h(r,n,i.leftCacheBounds),i.count++)}}for(let n=0;n<l;n++){const r=t[n],l=r.count,u=i-r.count,h=r.leftCacheBounds,p=r.rightCacheBounds;let g=0;0!==l&&(g=d(h)/o);let m=0;0!==u&&(m=d(p)/o);const w=1+s*(g*l+m*u);w<c&&(a=e,c=w,f=r.candidate)}}else{for(let e=0;e<p;e++){const t=m[e];t.count=0,t.candidate=r+b+e*b;const n=t.bounds;for(let e=0;e<3;e++)n[e]=1/0,n[e+3]=-1/0}for(let t=x;t<y;t+=6){let s=~~((n[t+2*e]-r)/b);s>=p&&(s=31);const i=m[s];i.count++,h(t,n,i.bounds)}const t=m[31];l(t.bounds,t.rightCacheBounds);for(let e=30;e>=0;e--){const t=m[e],n=m[e+1];u(t.bounds,n.rightCacheBounds,t.rightCacheBounds)}let g=0;for(let t=0;t<31;t++){const n=m[t],r=n.count,h=n.bounds,p=m[t+1].rightCacheBounds;0!==r&&(0===g?l(h,w):u(h,w,w)),g+=r;let x=0,y=0;0!==g&&(x=d(w)/o);const b=i-g;0!==b&&(y=d(p)/o);const _=1+s*(x*g+y*b);_<c&&(a=e,c=_,f=n.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${o} used.`);return{axis:a,pos:f}}(t.boundingData,a,y,r,o,v);if(-1===M.axis)return n(r+o),t.offset=r,t.count=o,t;const A=function(e,t,n,r,s){let i=n,o=n+r-1;const a=s.pos,c=2*s.axis;for(;;){for(;i<=o&&t[6*i+c]<a;)i++;for(;i<=o&&t[6*o+c]>=a;)o--;if(!(i<o))return i;for(let n=0;n<3;n++){let r=e[3*i+n];e[3*i+n]=e[3*o+n],e[3*o+n]=r;let s=t[6*i+2*n+0];t[6*i+2*n+0]=t[6*o+2*n+0],t[6*o+2*n+0]=s;let a=t[6*i+2*n+1];t[6*i+2*n+1]=t[6*o+2*n+1],t[6*o+2*n+1]=a}i++,o--}}(b,y,r,o,M);if(A===r||A===r+o)n(r+o),t.offset=r,t.count=o;else{t.splitAxis=M.axis;const e=new MeshBVHNode,n=r,s=A-r;t.left=e,e.boundingData=new Float32Array(6),f(y,n,s,e.boundingData,x),i(e,n,s,x,B+1);const a=new MeshBVHNode,c=A,l=o-s;t.right=a,a.boundingData=new Float32Array(6),f(y,c,l,a.boundingData,x),i(a,c,l,x,B+1)}return t}!function(e,t){if(!e.index){const n=e.attributes.position.count,s=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;let i;i=n>65535?new Uint32Array(new s(4*n)):new Uint16Array(new s(2*n)),e.setIndex(new r.BufferAttribute(i,1));for(let e=0;e<n;e++)i[e]=e}}(e,t);const a=new Float32Array(6),x=new Float32Array(6),y=function(e,t){const n=e.attributes.position,r=n.array,s=e.index.array,i=s.length/3,a=new Float32Array(6*i),c=n.offset||0;let l=3;n.isInterleavedBufferAttribute&&(l=n.data.stride);for(let e=0;e<i;e++){const n=3*e,i=6*e,u=s[n+0]*l+c,h=s[n+1]*l+c,d=s[n+2]*l+c;for(let e=0;e<3;e++){const n=r[u+e],s=r[h+e],c=r[d+e];let l=n;s<l&&(l=s),c<l&&(l=c);let f=n;s>f&&(f=s),c>f&&(f=c);const p=(f-l)/2,g=2*e;a[i+g+0]=l+p,a[i+g+1]=p+(Math.abs(l)+p)*o,l<t[e]&&(t[e]=l),f>t[e+3]&&(t[e+3]=f)}}return a}(e,a),b=e.index.array,_=t.maxDepth,T=t.verbose,S=t.maxLeafTris,v=t.strategy,B=t.onProgress,M=e.index.count/3;let P=!1;const A=[],V=function(e){if(!e.groups||!e.groups.length)return[{offset:0,count:e.index.count/3}];const t=[],n=new Set;for(const t of e.groups)n.add(t.start),n.add(t.start+t.count);const r=Array.from(n.values()).sort(((e,t)=>e-t));for(let e=0;e<r.length-1;e++){const n=r[e],s=r[e+1];t.push({offset:n/3,count:(s-n)/3})}return t}(e);if(1===V.length){const e=V[0],t=new MeshBVHNode;t.boundingData=a,function(e,t,n,r){let s=1/0,i=1/0,o=1/0,a=-1/0,c=-1/0,l=-1/0;for(let r=6*t,u=6*(t+n);r<u;r+=6){const t=e[r+0];t<s&&(s=t),t>a&&(a=t);const n=e[r+2];n<i&&(i=n),n>c&&(c=n);const u=e[r+4];u<o&&(o=u),u>l&&(l=u)}r[0]=s,r[1]=i,r[2]=o,r[3]=a,r[4]=c,r[5]=l}(y,e.offset,e.count,x),i(t,e.offset,e.count,x),A.push(t)}else for(let e of V){const t=new MeshBVHNode;t.boundingData=new Float32Array(6),f(y,e.offset,e.count,t.boundingData,x),i(t,e.offset,e.count,x),A.push(t)}return A}class SeparatingAxisBounds{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let n=1/0,r=-1/0;for(let s=0,i=e.length;s<i;s++){const i=e[s][t];n=i<n?i:n,r=i>r?i:r}this.min=n,this.max=r}setFromPoints(e,t){let n=1/0,r=-1/0;for(let s=0,i=t.length;s<i;s++){const i=t[s],o=e.dot(i);n=o<n?o:n,r=o>r?o:r}this.min=n,this.max=r}isSeparated(e){return this.min>e.max||e.min>this.max}}SeparatingAxisBounds.prototype.setFromBox=function(){const e=new r.Vector3;return function(t,n){const r=n.min,s=n.max;let i=1/0,o=-1/0;for(let n=0;n<=1;n++)for(let a=0;a<=1;a++)for(let c=0;c<=1;c++){e.x=r.x*n+s.x*(1-n),e.y=r.y*a+s.y*(1-a),e.z=r.z*c+s.z*(1-c);const l=t.dot(e);i=Math.min(l,i),o=Math.max(l,o)}this.min=i,this.max=o}}();!function(){const e=new SeparatingAxisBounds}();const y=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Vector3;return function(r,s,i){const o=r.start,a=e,c=s.start,l=t;n.subVectors(o,c),e.subVectors(r.end,s.start),t.subVectors(s.end,s.start);const u=n.dot(l),h=l.dot(a),d=l.dot(l),f=n.dot(a),p=a.dot(a)*d-h*h;let g,m;g=0!==p?(u*h-f*d)/p:0,m=(u+g*h)/d,i.x=g,i.y=m}}(),b=function(){const e=new r.Vector2,t=new r.Vector3,n=new r.Vector3;return function(r,s,i,o){y(r,s,e);let a=e.x,c=e.y;if(a>=0&&a<=1&&c>=0&&c<=1)return r.at(a,i),void s.at(c,o);if(a>=0&&a<=1)return c<0?s.at(0,o):s.at(1,o),void r.closestPointToPoint(o,!0,i);if(c>=0&&c<=1)return a<0?r.at(0,i):r.at(1,i),void s.closestPointToPoint(i,!0,o);{let e,l;e=a<0?r.start:r.end,l=c<0?s.start:s.end;const u=t,h=n;return r.closestPointToPoint(l,!0,t),s.closestPointToPoint(e,!0,n),u.distanceToSquared(l)<=h.distanceToSquared(e)?(i.copy(u),void o.copy(l)):(i.copy(e),void o.copy(h))}}}(),_=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Plane,s=new r.Line3;return function(r,i){const{radius:o,center:a}=r,{a:c,b:l,c:u}=i;s.start=c,s.end=l;if(s.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;s.start=c,s.end=u;if(s.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;s.start=l,s.end=u;if(s.closestPointToPoint(a,!0,e).distanceTo(a)<=o)return!0;const h=i.getPlane(n);if(Math.abs(h.distanceToPoint(a))<=o){const e=h.projectPoint(a,t);if(i.containsPoint(e))return!0}return!1}}();class ExtendedTriangle extends r.Triangle{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new r.Vector3)),this.satBounds=new Array(4).fill().map((()=>new SeparatingAxisBounds)),this.points=[this.a,this.b,this.c],this.sphere=new r.Sphere,this.plane=new r.Plane,this.needsUpdate=!1}intersectsSphere(e){return _(e,this)}update(){const e=this.a,t=this.b,n=this.c,r=this.points,s=this.satAxes,i=this.satBounds,o=s[0],a=i[0];this.getNormal(o),a.setFromPoints(o,r);const c=s[1],l=i[1];c.subVectors(e,t),l.setFromPoints(c,r);const u=s[2],h=i[2];u.subVectors(t,n),h.setFromPoints(u,r);const d=s[3],f=i[3];d.subVectors(n,e),f.setFromPoints(d,r),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,e),this.needsUpdate=!1}}ExtendedTriangle.prototype.closestPointToSegment=function(){const e=new r.Vector3,t=new r.Vector3,n=new r.Line3;return function(r,s=null,i=null){const{start:o,end:a}=r,c=this.points;let l,u=1/0;for(let o=0;o<3;o++){const a=(o+1)%3;n.start.copy(c[o]),n.end.copy(c[a]),b(n,r,e,t),l=e.distanceToSquared(t),l<u&&(u=l,s&&s.copy(e),i&&i.copy(t))}return this.closestPointToPoint(o,e),l=o.distanceToSquared(e),l<u&&(u=l,s&&s.copy(e),i&&i.copy(o)),this.closestPointToPoint(a,e),l=a.distanceToSquared(e),l<u&&(u=l,s&&s.copy(e),i&&i.copy(a)),Math.sqrt(u)}}(),ExtendedTriangle.prototype.intersectsTriangle=function(){const e=new ExtendedTriangle,t=new Array(3),n=new Array(3),s=new SeparatingAxisBounds,i=new SeparatingAxisBounds,o=new r.Vector3,a=new r.Vector3,c=new r.Vector3,l=new r.Vector3,u=new r.Line3,h=new r.Line3,d=new r.Line3;return function(r,f=null){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(e.copy(r),e.update(),r=e);const p=this.plane,g=r.plane;if(Math.abs(p.normal.dot(g.normal))>1-1e-10){const e=this.satBounds,a=this.satAxes;n[0]=r.a,n[1]=r.b,n[2]=r.c;for(let t=0;t<4;t++){const r=e[t],i=a[t];if(s.setFromPoints(i,n),r.isSeparated(s))return!1}const c=r.satBounds,l=r.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let e=0;e<4;e++){const n=c[e],r=l[e];if(s.setFromPoints(r,t),n.isSeparated(s))return!1}for(let e=0;e<4;e++){const r=a[e];for(let e=0;e<4;e++){const a=l[e];if(o.crossVectors(r,a),s.setFromPoints(o,t),i.setFromPoints(o,n),s.isSeparated(i))return!1}}return f&&(console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),f.start.set(0,0,0),f.end.set(0,0,0)),!0}{const e=this.points;let t=!1,n=0;for(let r=0;r<3;r++){const s=e[r],i=e[(r+1)%3];if(u.start.copy(s),u.end.copy(i),u.delta(a),0===g.normal.dot(a)&&0===g.distanceToPoint(u.start)){h.copy(u),n=2;break}if(g.intersectLine(u,t?h.start:h.end)){if(n++,t)break;t=!0}}if(2!==n)return!1;const s=r.points;let i=!1,o=0;for(let e=0;e<3;e++){const t=s[e],n=s[(e+1)%3];if(u.start.copy(t),u.end.copy(n),u.delta(c),0===p.normal.dot(c)&&0===p.distanceToPoint(u.start)){d.copy(u),o=2;break}if(p.intersectLine(u,i?d.start:d.end)){if(o++,i)break;i=!0}}if(2!==o)return!1;if(h.delta(a),d.delta(c),a.dot(c)<0){let e=d.start;d.start=d.end,d.end=e}const m=h.start.dot(a),w=h.end.dot(a),x=d.start.dot(a),y=d.end.dot(a),b=w<x,_=m<y;return(m===y||x===w||b!==_)&&(f&&(l.subVectors(h.start,d.start),l.dot(a)>0?f.start.copy(h.start):f.start.copy(d.start),l.subVectors(h.end,d.end),l.dot(a)<0?f.end.copy(h.end):f.end.copy(d.end)),!0)}}}(),ExtendedTriangle.prototype.distanceToPoint=function(){const e=new r.Vector3;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),ExtendedTriangle.prototype.distanceToTriangle=function(){const e=new r.Vector3,t=new r.Vector3,n=["a","b","c"],s=new r.Line3,i=new r.Line3;return function(r,o=null,a=null){const c=o||a?s:null;if(this.intersectsTriangle(r,c))return(o||a)&&(o&&c.getCenter(o),a&&c.getCenter(a)),0;let l=1/0;for(let t=0;t<3;t++){let s;const i=n[t],c=r[i];this.closestPointToPoint(c,e),s=c.distanceToSquared(e),s<l&&(l=s,o&&o.copy(e),a&&a.copy(c));const u=this[i];r.closestPointToPoint(u,e),s=u.distanceToSquared(e),s<l&&(l=s,o&&o.copy(u),a&&a.copy(e))}for(let c=0;c<3;c++){const u=n[c],h=n[(c+1)%3];s.set(this[u],this[h]);for(let c=0;c<3;c++){const u=n[c],h=n[(c+1)%3];i.set(r[u],r[h]),b(s,i,e,t);const d=e.distanceToSquared(t);d<l&&(l=d,o&&o.copy(e),a&&a.copy(t))}}return Math.sqrt(l)}}();class OrientedBox extends r.Box3{constructor(...e){super(...e),this.isOrientedBox=!0,this.matrix=new r.Matrix4,this.invMatrix=new r.Matrix4,this.points=new Array(8).fill().map((()=>new r.Vector3)),this.satAxes=new Array(3).fill().map((()=>new r.Vector3)),this.satBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.alignedSatBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.needsUpdate=!1}set(e,t,n){super.set(e,t),this.matrix.copy(n),this.needsUpdate=!0}copy(e){super.copy(e),this.matrix.copy(e.matrix),this.needsUpdate=!0}}OrientedBox.prototype.update=function(){const e=this.matrix,t=this.min,n=this.max,r=this.points;for(let s=0;s<=1;s++)for(let i=0;i<=1;i++)for(let o=0;o<=1;o++){const a=r[1*s|2*i|4*o];a.x=s?n.x:t.x,a.y=i?n.y:t.y,a.z=o?n.z:t.z,a.applyMatrix4(e)}const s=this.satBounds,i=this.satAxes,o=r[0];for(let e=0;e<3;e++){const t=i[e],n=s[e],a=r[1<<e];t.subVectors(o,a),n.setFromPoints(t,r)}const a=this.alignedSatBounds;a[0].setFromPointsField(r,"x"),a[1].setFromPointsField(r,"y"),a[2].setFromPointsField(r,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},OrientedBox.prototype.intersectsBox=function(){const e=new SeparatingAxisBounds;return function(t){this.needsUpdate&&this.update();const n=t.min,r=t.max,s=this.satBounds,i=this.satAxes,o=this.alignedSatBounds;if(e.min=n.x,e.max=r.x,o[0].isSeparated(e))return!1;if(e.min=n.y,e.max=r.y,o[1].isSeparated(e))return!1;if(e.min=n.z,e.max=r.z,o[2].isSeparated(e))return!1;for(let n=0;n<3;n++){const r=i[n],o=s[n];if(e.setFromBox(r,t),o.isSeparated(e))return!1}return!0}}(),OrientedBox.prototype.intersectsTriangle=function(){const e=new ExtendedTriangle,t=new Array(3),n=new SeparatingAxisBounds,s=new SeparatingAxisBounds,i=new r.Vector3;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(e.copy(r),e.update(),r=e);const o=this.satBounds,a=this.satAxes;t[0]=r.a,t[1]=r.b,t[2]=r.c;for(let e=0;e<3;e++){const r=o[e],s=a[e];if(n.setFromPoints(s,t),r.isSeparated(n))return!1}const c=r.satBounds,l=r.satAxes,u=this.points;for(let e=0;e<3;e++){const t=c[e],r=l[e];if(n.setFromPoints(r,u),t.isSeparated(n))return!1}for(let e=0;e<3;e++){const r=a[e];for(let e=0;e<4;e++){const o=l[e];if(i.crossVectors(r,o),n.setFromPoints(i,t),s.setFromPoints(i,u),n.isSeparated(s))return!1}}return!0}}(),OrientedBox.prototype.closestPointToPoint=function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t},OrientedBox.prototype.distanceToPoint=function(){const e=new r.Vector3;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),OrientedBox.prototype.distanceToBox=function(){const e=["x","y","z"],t=new Array(12).fill().map((()=>new r.Line3)),n=new Array(12).fill().map((()=>new r.Line3)),s=new r.Vector3,i=new r.Vector3;return function(r,o=0,a=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(a||c)&&(r.getCenter(i),this.closestPointToPoint(i,s),r.closestPointToPoint(s,i),a&&a.copy(s),c&&c.copy(i)),0;const l=o*o,u=r.min,h=r.max,d=this.points;let f=1/0;for(let e=0;e<8;e++){const t=d[e];i.copy(t).clamp(u,h);const n=t.distanceToSquared(i);if(n<f&&(f=n,a&&a.copy(t),c&&c.copy(i),n<l))return Math.sqrt(n)}let p=0;for(let r=0;r<3;r++)for(let s=0;s<=1;s++)for(let i=0;i<=1;i++){const o=(r+1)%3,a=(r+2)%3,c=1<<r|s<<o|i<<a,l=d[s<<o|i<<a],f=d[c];t[p].set(l,f);const g=e[r],m=e[o],w=e[a],x=n[p],y=x.start,b=x.end;y[g]=u[g],y[m]=s?u[m]:h[m],y[w]=i?u[w]:h[m],b[g]=h[g],b[m]=s?u[m]:h[m],b[w]=i?u[w]:h[m],p++}for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let n=0;n<=1;n++){i.x=e?h.x:u.x,i.y=t?h.y:u.y,i.z=n?h.z:u.z,this.closestPointToPoint(i,s);const r=i.distanceToSquared(s);if(r<f&&(f=r,a&&a.copy(s),c&&c.copy(i),r<l))return Math.sqrt(r)}for(let e=0;e<12;e++){const r=t[e];for(let e=0;e<12;e++){const t=n[e];b(r,t,s,i);const o=s.distanceToSquared(i);if(o<f&&(f=o,a&&a.copy(s),c&&c.copy(i),o<l))return Math.sqrt(o)}}return Math.sqrt(f)}}();var T=n(34003);function S(e,t,n,r){const s=e.a,i=e.b,o=e.c;let a=t,c=t+1,l=t+2;n&&(a=n.getX(t),c=n.getX(t+1),l=n.getX(t+2)),s.x=r.getX(a),s.y=r.getY(a),s.z=r.getZ(a),i.x=r.getX(c),i.y=r.getY(c),i.z=r.getZ(c),o.x=r.getX(l),o.y=r.getY(l),o.z=r.getZ(l)}function v(e,t,n,r,s,i,o){const a=n.index,c=n.attributes.position;for(let n=e,l=t+e;n<l;n++)if(S(o,3*n,a,c),o.needsUpdate=!0,r(o,n,s,i))return!0;return!1}class PrimitivePool{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return 0===e.length?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}function B(e,t){return 65535===t[e+15]}function M(e,t){return t[e+6]}function P(e,t){return t[e+14]}function A(e){return e+8}function V(e,t){return t[e+6]}const F=new r.Box3,C=new r.Vector3,U=["x","y","z"];function L(e,t,n,r,s){let i=2*e,o=N,a=H,c=z;if(B(i,a)){const o=M(e,c),l=P(i,a);(0,T.U$)(t,n,r,o,l,s)}else{const i=A(e);O(i,o,r,C)&&L(i,t,n,r,s);const a=V(e,c);O(a,o,r,C)&&L(a,t,n,r,s)}}function E(e,t,n,r){let s=2*e,i=N,o=H,a=z;if(B(s,o)){const i=M(e,a),c=P(s,o);return(0,T.rM)(t,n,r,i,c)}{const s=function(e,t){return t[e+7]}(e,a),o=U[s],c=r.direction[o]>=0;let l,u;c?(l=A(e),u=V(e,a)):(l=V(e,a),u=A(e));const h=O(l,i,r,C)?E(l,t,n,r):null;if(h){const e=h.point[o];if(c?e<=i[u+s]:e>=i[u+s+3])return h}const d=O(u,i,r,C)?E(u,t,n,r):null;return h&&d?h.distance<=d.distance?h:d:h||d||null}}const R=function(){let e,t;const n=[],s=new PrimitivePool((()=>new r.Box3));return function(...r){e=s.getPrimitive(),t=s.getPrimitive(),n.push(e,t);const o=i(...r);s.releasePrimitive(e),s.releasePrimitive(t),n.pop(),n.pop();const a=n.length;return a>0&&(t=n[a-1],e=n[a-2]),o};function i(n,r,s,o,c=null,l=0,u=0){function h(e){let t=2*e,n=H,r=z;for(;!B(t,n);)t=2*(e=A(e));return M(e,r)}function d(e){let t=2*e,n=H,r=z;for(;!B(t,n);)t=2*(e=V(e,r));return M(e,r)+P(t,n)}let f=2*n,p=N,g=H,m=z;if(B(f,g)){const t=M(n,m),r=P(f,g);return a(n,p,e),o(t,r,!1,u,l+n,e)}{const f=A(n),w=V(n,m);let x,y,b,_,T=f,S=w;if(c&&(b=e,_=t,a(T,p,b),a(S,p,_),x=c(b),y=c(_),y<x)){T=w,S=f;const e=x;x=y,y=e,b=_}b||(b=e,a(T,p,b));const v=s(b,B(2*T,g),x,u+1,l+T);let M;if(2===v){const e=h(T);M=o(e,d(T)-e,!0,u+1,l+T,b)}else M=v&&i(T,r,s,o,c,l,u+1);if(M)return!0;_=t,a(S,p,_);const P=s(_,B(2*S,g),y,u+1,l+S);let F;if(2===P){const e=h(S);F=o(e,d(S)-e,!0,u+1,l+S,_)}else F=P&&i(S,r,s,o,c,l,u+1);return!!F}}}(),k=function(){const e=new ExtendedTriangle,t=new ExtendedTriangle,n=new r.Matrix4,s=new OrientedBox,i=new OrientedBox;return function r(o,c,l,u,h=null){let d=2*o,f=N,p=H,g=z;null===h&&(l.boundingBox||l.computeBoundingBox(),s.set(l.boundingBox.min,l.boundingBox.max,u),h=s);if(!B(d,p)){const e=o+8,t=g[o+6];a(e,f,F);if(h.intersectsBox(F)&&r(e,c,l,u,h))return!0;a(t,f,F);return!!(h.intersectsBox(F)&&r(t,c,l,u,h))}{const r=c,s=r.index,h=r.attributes.position,m=l.index,w=l.attributes.position,x=M(o,g),y=P(d,p);if(n.copy(u).invert(),l.boundsTree){a(o,f,i),i.matrix.copy(n),i.needsUpdate=!0;return l.boundsTree.shapecast({intersectsBounds:e=>i.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(u),e.b.applyMatrix4(u),e.c.applyMatrix4(u),e.needsUpdate=!0;for(let n=3*x,r=3*(y+x);n<r;n+=3)if(S(t,n,s,h),t.needsUpdate=!0,e.intersectsTriangle(t))return!0;return!1}})}for(let r=3*x,i=y+3*x;r<i;r+=3){S(e,r,s,h),e.a.applyMatrix4(n),e.b.applyMatrix4(n),e.c.applyMatrix4(n),e.needsUpdate=!0;for(let n=0,r=m.count;n<r;n+=3)if(S(t,n,m,w),t.needsUpdate=!0,e.intersectsTriangle(t))return!0}}}}();function O(e,t,n,r){return a(e,t,F),n.intersectBox(F,r)}const I=[];let D,N,H,z;function G(e){D&&I.push(D),D=e,N=new Float32Array(e),H=new Uint16Array(e),z=new Uint32Array(e)}function q(){D=null,N=null,H=null,z=null,I.length&&G(I.pop())}const j=Symbol("skip tree generation"),W=new r.Box3,$=new r.Box3,J=new r.Matrix4,Q=new OrientedBox,Z=new OrientedBox,X=new r.Vector3,Y=new r.Vector3,K=new r.Vector3,ee=new r.Vector3,te=new r.Vector3,ne=new r.Box3,re=new PrimitivePool((()=>new ExtendedTriangle));class MeshBVH{static serialize(e,t={}){if(t.isBufferGeometry)return console.warn("MeshBVH.serialize: The arguments for the function have changed. See documentation for new signature."),MeshBVH.serialize(arguments[0],{cloneBuffers:void 0===arguments[2]||arguments[2]});t={cloneBuffers:!0,...t};const n=e.geometry,r=e._roots,s=n.getIndex();let i;return i=t.cloneBuffers?{roots:r.map((e=>e.slice())),index:s.array.slice()}:{roots:r,index:s.array},i}static deserialize(e,t,n={}){if("boolean"==typeof n)return console.warn("MeshBVH.deserialize: The arguments for the function have changed. See documentation for new signature."),MeshBVH.deserialize(arguments[0],arguments[1],{setIndex:void 0===arguments[2]||arguments[2]});n={setIndex:!0,...n};const{index:s,roots:i}=e,o=new MeshBVH(t,{...n,[j]:!0});if(o._roots=i,n.setIndex){const n=t.getIndex();if(null===n){const n=new r.BufferAttribute(e.index,1,!1);t.setIndex(n)}else n.array!==s&&(n.array.set(s),n.needsUpdate=!0)}return o}constructor(e,t={}){if(!e.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((t=Object.assign({strategy:0,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,[j]:!1},t)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this._roots=null,t[j]||(this._roots=function(e,t){const n=x(e,t);let r,s,o;const a=[],c=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let e=0;e<n.length;e++){const t=n[e],i=new c(32*l(t));r=new Float32Array(i),s=new Uint32Array(i),o=new Uint16Array(i),u(0,t),a.push(i)}return a;function l(e){return e.count?1:1+l(e.left)+l(e.right)}function u(e,t){const n=e/4,a=e/2,c=!!t.count,l=t.boundingData;for(let e=0;e<6;e++)r[n+e]=l[e];if(c){const r=t.offset,c=t.count;return s[n+6]=r,o[a+14]=c,o[a+15]=i,e+32}{const r=t.left,i=t.right,o=t.splitAxis;let a;if(a=u(e+32,r),a/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return s[n+6]=a/4,a=u(a,i),s[n+7]=o,a}}}(e,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new r.Box3))),this.geometry=e}refit(e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=this.geometry,n=t.index.array,r=t.attributes.position,s=r.array,o=r.offset||0;let a,c,l,u,h=3;r.isInterleavedBufferAttribute&&(h=r.data.stride);let d=0;const f=this._roots;for(let e=0,t=f.length;e<t;e++)a=f[e],c=new Uint32Array(a),l=new Uint16Array(a),u=new Float32Array(a),p(0,d),d+=a.byteLength;function p(t,r,a=!1){const d=2*t;if(l[d+15]===i){const e=c[t+6];let r=1/0,i=1/0,a=1/0,f=-1/0,p=-1/0,g=-1/0;for(let t=3*e,c=3*(e+l[d+14]);t<c;t++){const e=n[t]*h+o,c=s[e+0],l=s[e+1],u=s[e+2];c<r&&(r=c),c>f&&(f=c),l<i&&(i=l),l>p&&(p=l),u<a&&(a=u),u>g&&(g=u)}return(u[t+0]!==r||u[t+1]!==i||u[t+2]!==a||u[t+3]!==f||u[t+4]!==p||u[t+5]!==g)&&(u[t+0]=r,u[t+1]=i,u[t+2]=a,u[t+3]=f,u[t+4]=p,u[t+5]=g,!0)}{const n=t+8,s=c[t+6],i=n+r,o=s+r;let l=a,h=!1,d=!1;e?l||(h=e.has(i),d=e.has(o),l=!h&&!d):(h=!0,d=!0);const f=l||d;let g=!1;(l||h)&&(g=p(n,r,l));let m=!1;f&&(m=p(s,r,l));const w=g||m;if(w)for(let e=0;e<3;e++){const r=n+e,i=s+e,o=u[r],a=u[r+3],c=u[i],l=u[i+3];u[t+e]=o<c?o:c,u[t+e+3]=a>l?a:l}return w}}}traverse(e,t=0){const n=this._roots[t],r=new Uint32Array(n),s=new Uint16Array(n);!function t(o,a=0){const c=2*o,l=s[c+15]===i;if(l){const t=r[o+6],i=s[c+14];e(a,l,new Float32Array(n,4*o,6),t,i)}else{const s=o+8,i=r[o+6],c=r[o+7];e(a,l,new Float32Array(n,4*o,6),c)||(t(s,a+1),t(i,a+1))}}(0)}raycast(e,t=r.FrontSide){const n=this._roots,s=this.geometry,i=[],o=t.isMaterial,a=Array.isArray(t),c=s.groups,l=o?t.side:t;for(let r=0,o=n.length;r<o;r++){const o=a?t[c[r].materialIndex].side:l,u=i.length;if(G(n[r]),L(0,s,o,e,i),q(),a){const e=c[r].materialIndex;for(let t=u,n=i.length;t<n;t++)i[t].face.materialIndex=e}}return i}raycastFirst(e,t=r.FrontSide){const n=this._roots,s=this.geometry,i=t.isMaterial,o=Array.isArray(t);let a=null;const c=s.groups,l=i?t.side:t;for(let r=0,i=n.length;r<i;r++){const i=o?t[c[r].materialIndex].side:l;G(n[r]);const u=E(0,s,i,e);q(),null!=u&&(null==a||u.distance<a.distance)&&(a=u,o&&(u.face.materialIndex=c[r].materialIndex))}return a}intersectsGeometry(e,t){const n=this.geometry;let r=!1;for(const s of this._roots)if(G(s),r=k(0,n,e,t),q(),r)break;return r}shapecast(e,t,n){const r=this.geometry;if(e instanceof Function){if(t){const e=t;t=(t,n,r,s)=>{const i=3*n;return e(t,i,i+1,i+2,r,s)}}e={boundsTraverseOrder:n,intersectsBounds:e,intersectsTriangle:t,intersectsRange:null},console.warn("MeshBVH: Shapecast function signature has changed and now takes an object of callbacks as a second argument. See docs for new signature.")}const s=re.getPrimitive();let{boundsTraverseOrder:i,intersectsBounds:o,intersectsRange:a,intersectsTriangle:c}=e;if(a&&c){const e=a;a=(t,n,i,o,a)=>!!e(t,n,i,o,a)||v(t,n,r,c,i,o,s)}else a||(a=c?(e,t,n,i)=>v(e,t,r,c,n,i,s):(e,t,n)=>n);let l=!1,u=0;for(const e of this._roots){if(G(e),l=R(0,r,o,a,i,u),q(),l)break;u+=e.byteLength}return re.releasePrimitive(s),l}bvhcast(e,t,n){let{intersectsRanges:r,intersectsTriangles:s}=n;const i=this.geometry.index,o=this.geometry.attributes.position,a=e.geometry.index,c=e.geometry.attributes.position;J.copy(t).invert();const l=re.getPrimitive(),u=re.getPrimitive();if(s){function h(e,n,r,h,d,f,p,g){for(let m=r,w=r+h;m<w;m++){S(u,3*m,a,c),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let t=e,r=e+n;t<r;t++)if(S(l,3*t,i,o),l.needsUpdate=!0,s(l,u,t,m,d,f,p,g))return!0}return!1}if(r){const e=r;r=function(t,n,r,s,i,o,a,c){return!!e(t,n,r,s,i,o,a,c)||h(t,n,r,s,i,o,a,c)}}else r=h}this.getBoundingBox($),$.applyMatrix4(t);const d=this.shapecast({intersectsBounds:e=>$.intersectsBox(e),intersectsRange:(t,n,s,i,o,a)=>(W.copy(a),W.applyMatrix4(J),e.shapecast({intersectsBounds:e=>W.intersectsBox(e),intersectsRange:(e,s,a,c,l)=>r(t,n,e,s,i,o,c,l)}))});return re.releasePrimitive(l),re.releasePrimitive(u),d}intersectsBox(e,t){return Q.set(e.min,e.max,t),Q.needsUpdate=!0,this.shapecast({intersectsBounds:e=>Q.intersectsBox(e),intersectsTriangle:e=>Q.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,n={},r={},s=0,i=1/0){e.boundingBox||e.computeBoundingBox(),Q.set(e.boundingBox.min,e.boundingBox.max,t),Q.needsUpdate=!0;const o=this.geometry,a=o.attributes.position,c=o.index,l=e.attributes.position,u=e.index,h=re.getPrimitive(),d=re.getPrimitive();let f=Y,p=K,g=null,m=null;r&&(g=ee,m=te);let w=1/0,x=null,y=null;return J.copy(t).invert(),Z.matrix.copy(J),this.shapecast({boundsTraverseOrder:e=>Q.distanceToBox(e),intersectsBounds:(e,t,n)=>n<w&&n<i&&(t&&(Z.min.copy(e.min),Z.max.copy(e.max),Z.needsUpdate=!0),!0),intersectsRange:(n,r)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:e=>Z.distanceToBox(e),intersectsBounds:(e,t,n)=>n<w&&n<i,intersectsRange:(e,i)=>{for(let o=3*e,b=3*(e+i);o<b;o+=3){S(d,o,u,l),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let e=3*n,t=3*(n+r);e<t;e+=3){S(h,e,c,a),h.needsUpdate=!0;const t=h.distanceToTriangle(d,f,g);if(t<w&&(p.copy(f),m&&m.copy(g),w=t,x=e/3,y=o/3),t<s)return!0}}}});for(let e=0,i=u?u.count:l.count;e<i;e+=3){S(d,e,u,l),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let t=3*n,i=3*(n+r);t<i;t+=3){S(h,t,c,a),h.needsUpdate=!0;const n=h.distanceToTriangle(d,f,g);if(n<w&&(p.copy(f),m&&m.copy(g),w=n,x=t/3,y=e/3),n<s)return!0}}}}),re.releasePrimitive(h),re.releasePrimitive(d),w===1/0?null:(n.point?n.point.copy(p):n.point=p.clone(),n.distance=w,n.faceIndex=x,r&&(r.point?r.point.copy(m):r.point=m.clone(),r.point.applyMatrix4(J),p.applyMatrix4(J),r.distance=p.sub(r.point).length(),r.faceIndex=y),n)}closestPointToPoint(e,t={},n=0,r=1/0){const s=n*n,i=r*r;let o=1/0,a=null;if(this.shapecast({boundsTraverseOrder:t=>(X.copy(e).clamp(t.min,t.max),X.distanceToSquared(e)),intersectsBounds:(e,t,n)=>n<o&&n<i,intersectsTriangle:(t,n)=>{t.closestPointToPoint(e,X);const r=e.distanceToSquared(X);return r<o&&(Y.copy(X),o=r,a=n),r<s}}),o===1/0)return null;const c=Math.sqrt(o);return t.point?t.point.copy(Y):t.point=Y.clone(),t.distance=c,t.faceIndex=a,t}getBoundingBox(e){e.makeEmpty();return this._roots.forEach((t=>{a(0,new Float32Array(t),ne),e.union(ne)})),e}}const se=MeshBVH.prototype.raycast;MeshBVH.prototype.raycast=function(...e){if(e[0].isMesh){console.warn('MeshBVH: The function signature and results frame for "raycast" has changed. See docs for new signature.');const[t,n,r,s]=e;return se.call(this,r,t.material).forEach((e=>{(e=(0,T.O)(e,t,n))&&s.push(e)})),s}return se.apply(this,e)};const ie=MeshBVH.prototype.raycastFirst;MeshBVH.prototype.raycastFirst=function(...e){if(e[0].isMesh){console.warn('MeshBVH: The function signature and results frame for "raycastFirst" has changed. See docs for new signature.');const[t,n,r]=e;return(0,T.O)(ie.call(this,r,t.material),t,n)}return ie.apply(this,e)};const oe=MeshBVH.prototype.closestPointToPoint;MeshBVH.prototype.closestPointToPoint=function(...e){if(e[0].isMesh){console.warn('MeshBVH: The function signature and results frame for "closestPointToPoint" has changed. See docs for new signature.'),e.unshift();const t=e[1],n={};return e[1]=n,oe.apply(this,e),t&&t.copy(n.point),n.distance}return oe.apply(this,e)};const ae=MeshBVH.prototype.closestPointToGeometry;MeshBVH.prototype.closestPointToGeometry=function(...e){const t=e[2],n=e[3];if(t&&t.isVector3||n&&n.isVector3){console.warn('MeshBVH: The function signature and results frame for "closestPointToGeometry" has changed. See docs for new signature.');const r={},s={},i=e[1];return e[2]=r,e[3]=s,ae.apply(this,e),t&&t.copy(r.point),n&&n.copy(s.point).applyMatrix4(i),r.distance}return ae.apply(this,e)};const ce=MeshBVH.prototype.refit;MeshBVH.prototype.refit=function(...e){const t=e[0],n=e[1];if(n&&(n instanceof Set||Array.isArray(n))){console.warn('MeshBVH: The function signature for "refit" has changed. See docs for new signature.');const e=new Set;n.forEach((t=>e.add(t))),t&&t.forEach((t=>e.add(t))),ce.call(this,e)}else ce.apply(this,e)},["intersectsGeometry","shapecast","intersectsBox","intersectsSphere"].forEach((e=>{const t=MeshBVH.prototype[e];MeshBVH.prototype[e]=function(...n){return(null===n[0]||n[0].isMesh)&&(n.shift(),console.warn(`MeshBVH: The function signature for "${e}" has changed and no longer takes Mesh. See docs for new signature.`)),t.apply(this,n)}}))},864:(e,t,n)=>{"use strict";n.d(t,{uL:()=>l,Xy:()=>u,sn:()=>h});var r=n(84428),s=n(34003),i=n(81080);const o=new r.Ray,a=new r.Matrix4,c=r.Mesh.prototype.raycast;function l(e,t){if(this.geometry.boundsTree){if(void 0===this.material)return;a.copy(this.matrixWorld).invert(),o.copy(e.ray).applyMatrix4(a);const n=this.geometry.boundsTree;if(!0===e.firstHitOnly){const r=(0,s.O)(n.raycastFirst(o,this.material),this,e);r&&t.push(r)}else{const r=n.raycast(o,this.material);for(let n=0,i=r.length;n<i;n++){const i=(0,s.O)(r[n],this,e);i&&t.push(i)}}}else c.call(this,e,t)}function u(e){return this.boundsTree=new i.r(this,e),this.boundsTree}function h(){this.boundsTree=null}},34003:(e,t,n)=>{"use strict";n.d(t,{O:()=>g,rM:()=>p,U$:()=>f});var r=n(84428);const s=new r.Vector3,i=new r.Vector3,o=new r.Vector3,a=new r.Vector2,c=new r.Vector2,l=new r.Vector2,u=new r.Vector3;function h(e,t,n,h,d,f,p){s.fromBufferAttribute(t,h),i.fromBufferAttribute(t,d),o.fromBufferAttribute(t,f);const g=function(e,t,n,s,i,o){let a;return a=o===r.BackSide?e.intersectTriangle(s,n,t,!0,i):e.intersectTriangle(t,n,s,o!==r.DoubleSide,i),null===a?null:{distance:e.origin.distanceTo(i),point:i.clone()}}(e,s,i,o,u,p);if(g){n&&(a.fromBufferAttribute(n,h),c.fromBufferAttribute(n,d),l.fromBufferAttribute(n,f),g.uv=r.Triangle.getUV(u,s,i,o,a,c,l,new r.Vector2));const e={a:h,b:d,c:f,normal:new r.Vector3,materialIndex:0};r.Triangle.getNormal(s,i,o,e.normal),g.face=e,g.faceIndex=h}return g}function d(e,t,n,r,s){const i=3*r,o=e.index.getX(i),a=e.index.getX(i+1),c=e.index.getX(i+2),l=h(n,e.attributes.position,e.attributes.uv,o,a,c,t);return l?(l.faceIndex=r,s&&s.push(l),l):null}function f(e,t,n,r,s,i){for(let o=r,a=r+s;o<a;o++)d(e,t,n,o,i)}function p(e,t,n,r,s){let i=1/0,o=null;for(let a=r,c=r+s;a<c;a++){const r=d(e,t,n,a);r&&r.distance<i&&(o=r,i=r.distance)}return o}function g(e,t,n){return null===e?null:(e.point.applyMatrix4(t.matrixWorld),e.distance=e.point.distanceTo(n.ray.origin),e.object=t,e.distance<n.near||e.distance>n.far?null:e)}}}]);